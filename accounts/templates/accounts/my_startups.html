{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}
{% load accounts_extras %}
{% load math_filters %}
{% load startup_filters %}
{% load file_tags %}

{% block title %}Мои стартапы{% endblock %}

{% block head_extra %}
  {{ block.super }}
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'accounts/css/investments.css' %}">
  
  <style>
    main.content {
      max-width: 1303px !important;
    }

    .applications-section {
      color: #FFFFFF;
      padding: 40px 0;
      margin-top: 40px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .applications-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end; /* Выравниваем по нижнему краю */
      margin-bottom: 30px;
    }
    .applications-titles {
       display: flex;
       flex-direction: column;
       line-height: 0.8; /* Сближаем строки */
    }
    .applications-title-main,
    .applications-title-sub {
      font-family: 'Blippo Local', sans-serif; /* Новый шрифт */
      font-weight: 400; /* Новый вес */
      font-size: 45px; /* Чуть меньше */
      line-height: 1.0;
      letter-spacing: -0.02em;
      margin: 0;
      text-transform: uppercase;
    }
    .applications-title-main { color: #FFFFFF; }
    .applications-title-sub { color: #FFEF2B; }

    .applications-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .application-card {
      background-color: #1A1D2E; /* Темный фон для карточки заявки */
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: background-color 0.3s linear, border-color 0.3s linear;
    }
    .application-card:hover {
      background-color: #212538;
      border-color: rgba(255, 255, 255, 0.2);
    }
    .application-title {
      font-size: 16px;
      font-weight: 500;
      color: #FFFFFF;
      margin-bottom: 5px;
    }
    .application-status {
      font-size: 14px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block; /* Чтобы padding работал */
      margin-bottom: 10px;
      text-align: center;
      min-width: 100px; /* Минимальная ширина для выравнивания */
    }
    /* Стили для статусов заявок */
    .status-approved { background-color: #28a745; color: #fff; }
    .status-pending { background-color: #ffc107; color: #191919; }
    .status-rejected { background-color: #dc3545; color: #fff; }
    .status-blocked { background-color: #6c757d; color: #fff; } /* Добавим стиль для blocked */
    .status-closed { background-color: #343a40; color: #fff; } /* Добавим стиль для closed */

    .application-comment {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      font-style: italic;
      margin-top: auto; /* Прижимаем комментарий к низу */
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .application-card a {
        color: #FFEF2B;
        text-decoration: none;
        font-weight: 500;
        margin-top: 10px;
        display: inline-block;
    }
    .application-card a:hover {
        text-decoration: underline;
    }



    /* Стили для планетарной системы my_startups */
    .planetary-system-container {
      position: relative;
      width: 100%;
      height: 600px;
      overflow: hidden;
      background: transparent;
      box-shadow: 6px 6px 10px rgba(123, 97, 255, 0.25);
      border-radius: 10px;
      outline: 1px #C6BBFE solid;
      outline-offset: -1px;
    }

          .my_startups_planetary-system {
      width: 100%;
      height: 100%;
      position: relative;
      perspective: 1000px;
      cursor: grab;
    }

          .my_startups_planetary-system.dragging {
      cursor: grabbing;
    }

          .my_startups_planetary-system .my_startups_space-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #0B1426 0%, #1E3A8A 100%);
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 813"><defs><radialGradient id="spaceGrad" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.3)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><rect width="100%" height="100%" fill="url(%23spaceGrad)"/></svg>');
      background-size: cover;
      background-position: center;
      z-index: 1;
      pointer-events: none;
    }

    .my_startups_planetary-system .my_startups_stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.7), transparent);
      background-repeat: repeat;
      background-size: 600px 400px;
      animation: ultra_new_planetary_star_scroll 40s linear infinite;
      z-index: 2;
      pointer-events: none;
    }

    @keyframes ultra_new_planetary_star_scroll {
      from { background-position: 0 0; }
      to { background-position: -800px 0; }
    }

    .my_startups_planetary-system #my_startups_scene {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translate(0px, 0px) scale(1);
      transform-style: preserve-3d;
    }

    .my_startups_planetary-system #my_startups_galaxy {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      transform: translate(-50%, -50%) rotateX(60deg);
      transform-style: preserve-3d;
      z-index: 5;
    }

    .my_startups_planetary-system #my_startups_scene {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      transform: translate(-50%, -50%) scale(0.7);
      transform-style: preserve-3d;
    }

    .my_startups_planetary-system #my_startups_logo {
      width: 100px;
      height: 100px;
      background-size: cover;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotateX(-60deg);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: #333;
      text-align: center;
      line-height: 1.2;
      overflow: hidden; /* Предотвращаем обрезку */
    }

    .my_startups_planetary-system .orbit {
      position: absolute;
      top: 50%;
      left: 50%;
      width: var(--orbit-size);
      height: var(--orbit-size);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      margin-left: calc(-0.5 * var(--orbit-size));
      margin-top: calc(-0.5 * var(--orbit-size));
      transform-style: preserve-3d;
      z-index: 1;
      transition: all 0.5s ease;
    }

    .my_startups_planetary-system .planet-orientation {
      position: absolute;
      transform-style: preserve-3d;
    }

    .my_startups_planetary-system .planet {
      position: absolute;
      width: var(--planet-size);
      height: var(--planet-size);
      margin-left: calc(-0.5 * var(--planet-size));
      margin-top: calc(-0.5 * var(--planet-size));
      border-radius: 50%;
      background-color: transparent !important;
      cursor: pointer;
      transform-style: preserve-3d;
      z-index: 5;
      transition: all 0.3s ease;
      overflow: visible !important; /* Убираем обрезку, чтобы логотипы были видны */
      border: none; /* Убираем рамку */
      pointer-events: auto; /* Обеспечиваем кликабельность */
    }

    .my_startups_planetary-system .planet * {
      pointer-events: auto; /* Все дочерние элементы тоже кликабельны */
    }

    .my_startups_planetary-system .planet-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }



    .my_startups_planetary-system .planet:hover {
      transform: scale(1.1);
    }

    .my_startups_planetary-system .planet.active {
      transform: scale(1.2);
    }

    .my_startups_planetary-system #info-card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      max-width: 300px;
      width: 90%;
      color: #333;
      z-index: 20;
      display: none;
      text-align: center;
    }

    .my_startups_planetary-system #info-card .planet-image {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 8px;
      background-size: cover;
    }

    .my_startups_planetary-system #info-card h2 {
      margin: 0 0 4px;
      font-size: 18px;
      color: #000;
    }

    .my_startups_planetary-system #info-card .rating {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
    }

    .my_startups_planetary-system #info-card .progress-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 8px 0;
    }

    .my_startups_planetary-system #info-card .progress-bar button {
      padding: 4px 8px;
      border: none;
      background: #000;
      color: white;
      font-size: 12px;
      border-radius: 4px 0 0 4px;
    }

    .my_startups_planetary-system #info-card .progress-bar .progress {
      background: #ffd700;
      padding: 4px;
      font-size: 12px;
      font-weight: bold;
      border-radius: 0 4px 4px 0;
    }

    .my_startups_planetary-system #info-card .funding {
      font-size: 12px;
      color: #555;
      margin: 8px 0;
    }

    .my_startups_planetary-system #info-card .investors {
      font-size: 12px;
      color: #555;
      margin-bottom: 12px;
    }

    .my_startups_planetary-system #info-card .description {
      font-size: 12px;
      color: #555;
      margin-bottom: 12px;
    }

    .my_startups_planetary-system #info-card .more-details {
      padding: 8px 16px;
      background: none;
      border: none;
      color: #007bff;
      font-size: 14px;
      cursor: pointer;
    }

    .my_startups_planetary-system #close-card {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ffd700;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #000;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Стили для модального окна в стиле основной планетарки */
    .planetary-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .planetary-modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
    }

    .planetary-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 30px;
      cursor: pointer;
      z-index: 1002;
    }

    .planetary-modal-close:hover {
      color: #ccc;
    }

    .planetary-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      gap: 132px;
      z-index: 1001;
    }

    .planetary-modal-planet {
      width: 445px;
      height: 420px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .planetary-modal-planet img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .planetary-modal-card {
      width: 471px;
      padding: 28px 40px;
      background: white;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .planetary-modal-title {
      color: black;
      font-size: 20px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 400;
      line-height: 18px;
      margin: 0 0 16px 0;
      text-align: center;
    }

    .planetary-modal-rating-section {
      display: flex;
      align-items: center;
      gap: 13px;
      margin-bottom: 16px;
    }

    .planetary-modal-rating {
      color: #004E9F;
      font-size: 12px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.12px;
    }

    .planetary-modal-comments {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .planetary-modal-comment-icon {
      width: 16px;
      height: 15px;
      filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(97%);
    }

    .planetary-modal-comments-text {
      color: #004E9F;
      font-size: 14px;
      font-family: 'Circe', sans-serif;
      font-weight: 400;
      line-height: 18px;
    }

    .planetary-modal-category-section {
      margin-bottom: 16px;
    }

    .planetary-modal-category {
      display: inline-block;
      padding: 9px 17px;
      background: #050505;
      border-radius: 5px;
      color: white;
      font-size: 12px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.12px;
    }

    .planetary-modal-progress-container {
      width: 100%;
      height: 20px;
      margin-bottom: 16px;
      position: relative;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .planetary-modal-progress-bar-visual {
      width: 0%; 
      height: 100%;
      background: linear-gradient(90deg, #31D2C6 0%, #006EDF 100%);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        inset 0 0 5px rgb(255 255 255 / 50%),
        0 0 10px rgb(71 209 255 / 70%);
      transition: width 0.5s ease-in-out;
    }

    .planetary-modal-progress-animation-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .planetary-modal-progress-planets {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .planetary-modal-progress-planets::before,
    .planetary-modal-progress-planets::after {
      content: '';
      position: absolute;
      top: 50%;
      border-radius: 50%;
      background-color: rgb(255 255 255 / 70%);
      box-shadow: 0 0 8px rgb(255 255 255 / 80%);
      animation: planetary-modal-movePlanets 8s linear infinite;
    }

    .planetary-modal-progress-planets::before {
      width: 12px;
      height: 12px;
      margin-top: -6px;
      left: 10%;
      animation-delay: 0s;
    }

    .planetary-modal-progress-planets::after {
      width: 8px;
      height: 8px;
      margin-top: -4px;
      left: 60%;
      animation-delay: -4s;
    }

    .planetary-modal-progress-animation-container::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 30%;
      width: 10px;
      height: 10px;
      margin-top: -5px;
      border-radius: 50%;
      background-color: rgb(255 255 255 / 60%);
      box-shadow: 0 0 6px rgb(255 255 255 / 70%);
      animation: planetary-modal-movePlanets 10s linear infinite alternate;
      animation-delay: -2s;
    }

    @keyframes planetary-modal-movePlanets {
      0% {
        transform: translateX(0) translateY(-1px) scale(1);
        opacity: 0.7;
      }
      25% {
        transform: translateX(20px) translateY(1px) scale(1.1);
        opacity: 0.9;
      }
      50% {
        transform: translateX(-10px) translateY(0) scale(1);
        opacity: 0.8;
      }
      75% {
        transform: translateX(15px) translateY(-2px) scale(0.9);
        opacity: 1;
      }
      100% {
        transform: translateX(0) translateY(-1px) scale(1);
        opacity: 0.7;
      }
    }

    .planetary-modal-progress-percentage {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: #fff;
      font-size: 12px;
      z-index: 3;
      text-shadow: 0 1px 2px rgb(0 0 0 / 60%);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 5px;
      box-sizing: border-box;
    }

    .planetary-modal-description {
      color: black;
      font-size: 12px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.12px;
      line-height: 1.4;
      margin-bottom: 24px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .planetary-modal-financing-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .planetary-modal-funding-goal {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .planetary-modal-funding-label {
      color: #004E9F;
      font-size: 8px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.08px;
    }

    .planetary-modal-funding-amount {
      color: #31D2C6;
      font-size: 25px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 600;
      line-height: 35px;
    }

    .planetary-modal-valuation {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 50px;
      outline: 1px #004E9F solid;
      outline-offset: -1px;
    }

    .planetary-modal-valuation-icon {
      width: 17px;
      height: 17px;
      filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(97%);
    }

    .planetary-modal-valuation-label,
    .planetary-modal-valuation-amount {
      color: #004E9F;
      font-size: 8px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.08px;
      white-space: nowrap;
    }

    .planetary-modal-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .planetary-modal-details-btn {
      padding: 12px 35px;
      background: linear-gradient(0deg, #004E9F 0%, #006EDF 100%);
      border: none;
      border-radius: 10px;
      color: #F5F5F5;
      font-size: 16px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 400;
      line-height: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .planetary-modal-details-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 78, 159, 0.4);
    }

    .planetary-modal-investors-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 24px 8px 0;
    }

    .planetary-modal-investor-icon {
      width: 16px;
      height: 16px;
      filter: brightness(0) saturate(100%) invert(31%) sepia(8%) saturate(748%) hue-rotate(202deg) brightness(94%) contrast(86%);
    }

    .planetary-modal-investors-text {
      color: #4E4F51;
      font-size: 12px;
      font-family: 'Unbounded', sans-serif;
      font-weight: 300;
      letter-spacing: 0.12px;
    }

    @media (max-width: 1200px) {
      .planetary-modal-content {
        gap: 80px;
      }
      .planetary-modal-planet {
        width: 350px;
        height: 350px;
      }
      .planetary-modal-card {
        width: 400px;
        padding: 24px 32px;
      }
    }

    @media (max-width: 768px) {
      .planetary-modal-content {
        flex-direction: column;
        gap: 40px;
        padding: 20px;
      }
      .planetary-modal-planet {
        width: 250px;
        height: 250px;
      }
      .planetary-modal-card {
        width: 100%;
        max-width: 400px;
        padding: 20px 24px;
      }
      .planetary-modal-progress-container {
        height: 16px;
      }
      .planetary-modal-progress-percentage {
        font-size: 10px;
      }
    }

    @media (max-width: 768px) {
      .planetary-modal-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .planetary-modal-planet {
        margin-bottom: 20px;
      }
      
      .planetary-modal-financing-section {
        flex-direction: column;
        gap: 10px;
      }
    }

    .status-filter-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .status-filter-btn {
        padding: 8px 16px;
        background-color: #1A1D2E;
        color: #FFFFFF;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .status-filter-btn:hover {
        background-color: #212538;
        border-color: rgba(255, 255, 255, 0.2);
    }

    .status-filter-btn.active {
        background-color: #FFEF2B;
        color: #191919;
        border-color: #FFEF2B;
    }
  </style>
{% endblock %}

{% block content %}
  <main class="content">
  {% if user.is_authenticated and user.role.role_name == 'startuper' %}
    <div class="portfolio-container">
      
      <div class="analytics-section">
        <div class="analytics-left">
          <div class="portfolio-image-container planetary-system-container">
            <button class="portfolio-image-fullscreen-btn" aria-label="Развернуть на полный экран">
              <i class="fas fa-expand"></i>
            </button>
        <div class="my_startups_planetary-system" id="my_startups_solar-system">
                <div class="my_startups_space-background"></div>
                <div class="my_startups_stars"></div>
                <div id="my_startups_scene">
                  <div id="my_startups_galaxy">
                    <div id="my_startups_logo" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <img src="{% if user.get_profile_picture_url %}{{ user.get_profile_picture_url }}{% else %}{% static 'accounts/images/avatars/default_avatar_ufo.png' %}{% endif %}" alt="Аватар" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block;">
                        {% if planetary_startups|length == 0 %}
                          <span style="margin-top: 12px; color: white; font-size: 18px; text-align: center;">Нет стартапов для отображения</span>
                        {% endif %}
                    </div>
                    {% for startup in planetary_startups %}
                      <div class="orbit" style="--orbit-size: {{ startup.orbit_size }}px; --orbit-time: {{ startup.orbit_time }}s;">
                        <div class="planet-orientation">
                          <div class="planet" style="--planet-size: {{ startup.planet_size }}px;" data-id="{{ startup.startup_id }}">
                            {% if startup.planet_image %}
                              <img src="https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/{{ startup.planet_image }}" alt="{{ startup.name|escape }}" class="planet-img">
                            {% else %}
                              <img src="{% static 'accounts/images/planet_logo_carusel.webp' %}" alt="Планета по умолчанию" class="planet-img">
                            {% endif %}

                          </div>
                        </div>
                      </div>
                    {% empty %}
                      
                    {% endfor %}
                  </div>
              </div>
              <div id="info-card">
                  <button id="close-card" aria-label="Закрыть карточку">×</button>
                  <div class="planet-image" id="planet-image"></div>
                  <h2 id="startup-name"></h2>
                  <div class="rating" id="startup-rating"></div>
                  <div class="progress-bar">
                      <button>Выкуп+инвестирование</button>
                      <div class="progress" id="startup-progress"></div>
                  </div>
                  <div class="funding" id="startup-funding"></div>
                  <div class="investors" id="startup-investors"></div>
                  <div class="description" id="startup-description"></div>
                  <button class="more-details" id="more-details">Подробнее</button>
              </div>
          </div>
          </div>
          
          <!-- Новое модальное окно для планетарной системы -->
          <div id="planetary-modal" class="planetary-modal">
            <div class="planetary-modal-backdrop"></div>
            <button id="planetary-modal-close" class="planetary-modal-close">×</button>
            <div class="planetary-modal-content">
              <div class="planetary-modal-planet">
                <img id="planetary-modal-planet-img" src="" alt="Planet">
              </div>
              <div class="planetary-modal-card">
                <h2 id="planetary-modal-name" class="planetary-modal-title">Название стартапа</h2>
                <div class="planetary-modal-rating-section">
                  <div id="planetary-modal-rating" class="planetary-modal-rating">Рейтинг 0/5 (0)</div>
                  <div class="planetary-modal-comments">
                    <img src="{% static 'accounts/images/planetary_system/comment.svg' %}" alt="Комментарии" class="planetary-modal-comment-icon">
                    <div id="planetary-modal-comments-count" class="planetary-modal-comments-text">0</div>
                  </div>
                </div>
                <div class="planetary-modal-category-section">
                  <div id="planetary-modal-category" class="planetary-modal-category">Категория</div>
                </div>
                <div class="planetary-modal-progress-container">
                  <div class="planetary-modal-progress-bar-visual">
                    <div class="planetary-modal-progress-animation-container">
                      <div class="planetary-modal-progress-planets"></div>
                      <div id="planetary-modal-progress-percentage" class="planetary-modal-progress-percentage">0%</div>
                    </div>
                  </div>
                </div>
                <div id="planetary-modal-description" class="planetary-modal-description">
                  Описание стартапа...
                </div>
                <div class="planetary-modal-financing-section">
                  <div class="planetary-modal-funding-goal">
                    <div class="planetary-modal-funding-label">Цель финансирования</div>
                    <div id="planetary-modal-funding-amount" class="planetary-modal-funding-amount">0 ₽</div>
                  </div>
                  <div class="planetary-modal-valuation">
                    <img src="{% static 'accounts/images/planetary_system/award.svg' %}" alt="Оценка" class="planetary-modal-valuation-icon">
                    <div class="planetary-modal-valuation-label">Оценка</div>
                    <div id="planetary-modal-valuation-amount" class="planetary-modal-valuation-amount">0 ₽</div>
                  </div>
                </div>
                <div class="planetary-modal-actions">
                  <button id="planetary-modal-details-btn" class="planetary-modal-details-btn">Подробнее</button>
                  <div class="planetary-modal-investors-info">
                    <img src="{% static 'accounts/images/planetary_system/groups.svg' %}" alt="Инвесторы" class="planetary-modal-investor-icon">
                    <div id="planetary-modal-investors-count" class="planetary-modal-investors-text">Инвестировало (0)</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="categories-radial-section">
            <h3 class="categories-radial-title">Категории Ваших Стартапов</h3>
            <div class="categories-radial-grid">
              {% for category in investment_categories %}
                <div class="category-radial-item">
                  <div class="radial-chart" data-percentage="{{ category.percentage|default:0 }}" data-category-name="{{ category.name|default:''|escape }}">
                    <div class="radial-chart-progress"></div>
                    <div class="radial-chart-text">{{ category.percentage|default:0 }}%</div>
                  </div>
                  <span class="category-radial-name">{{ category.name|default:"Без категории"|escape }}</span>
                </div>
              {% empty %}
                <p>Нет данных по категориям созданных стартапов.</p>
              {% endfor %}
              
              <div class="category-radial-item category-all" id="openCategoriesModalBtn">
                <div class="radial-chart-all">
                  <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
                </div>
                <span class="category-radial-name">Все</span>
              </div>
            </div>
          </div>
        </div>
        <div class="analytics-content">
          <div class="analytics-header">
            <h1 class="analytics-title">Аналитика</h1>
            <div class="analytics-controls">
              <select class="month-select" aria-label="Выбор периода">
                <option value="весь год">Весь год</option>
              </select>
              <button class="analytics-options-btn" aria-label="Дополнительные опции">
                <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div class="stats-overview">
            <div class="stat-item">
              <span class="stat-label">Одобренные стартапы</span>
              <div class="stat-value-box dark-box">{{ startups_count|default:0|floatformat:0|intcomma }}</div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Всего собрано (одобренными)</span>
              <div class="stat-value-box blue-box">{{ total_investment|default:0|floatformat:0|intcomma }} ₽</div>
            </div>
          </div>

          <div class="stats-details">
            <div class="stat-item detail-item">
              <span class="stat-label">Макс. собрано (одобренным)</span>
              <span class="stat-value-simple">{{ max_investment|default:0|floatformat:0|intcomma }} ₽</span>
            </div>
            <div class="stat-item detail-item">
              <span class="stat-label">Мин. собрано (одобренным)</span>
              <span class="stat-value-simple">{{ min_investment|default:0|floatformat:0|intcomma }} ₽</span>
            </div>
          </div>

          
          <div class="analytics-chart-container">
            <canvas id="monthlyInvestmentChart" aria-label="График сборов одобренных стартапов за год"></canvas>
            <span class="chart-title-overlay">Собрано одобренными за год</span>
          </div>

                  <button class="download-report-btn" type="button" onclick="downloadReport()">Скачать отчет</button>
        </div>
      </div>

      
      <div class="my-startups-section">
        <div class="startups-header">
          <div class="startups-titles">
            <h2 class="startups-title-main">МОИ</h2>
            <h2 class="startups-title-sub">СТАРТАПЫ</h2>
          </div>
          <div class="total-investment">
            <span class="investment-label">Собрано всего (одобренными)</span>
            <div class="investment-amount">{{ total_investment|default:0|floatformat:0|intcomma }} ₽</div>
          </div>
        </div>

        <div class="startups-filters">
          
          <div class="status-filter-wrapper">
              <select id="status-filter" aria-label="Фильтр по статусу">
                  <option value="all">Все</option>
                  <option value="approved">Одобрены</option>
                  <option value="rejected">Отклонены</option>
                  <option value="blocked">Заблокированы</option>
                  <option value="closed">Закрыты</option>
              </select>
          </div>

          <div class="startups-search-wrapper">
            <i class="fas fa-search search-icon" aria-hidden="true"></i>
            <input type="text" placeholder="Поиск по названию..." id="startup-search" class="startups-search-input" aria-label="Поиск стартапов по названию">
          </div>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" type="button">Все</button>
            <div class="filter-dropdown-wrapper">
              <button class="filter-btn filter-btn-dropdown" data-filter="category" type="button" aria-expanded="false">
                Категория <i class="fas fa-chevron-down" aria-hidden="true"></i>
              </button>
              <div class="filter-dropdown-content">
                <a href="#" aria-label="Загрузка категорий">Загрузка...</a>
              </div>
            </div>
          </div>
        </div>

        <div class="startups-grid">
          {% for startup in user_startups|slice:":6" %}
            <div class="startup-card" data-category="{{ startup.direction.direction_name|default:''|escape }}" data-name="{{ startup.title|default:''|escape }}" data-status="{{ startup.status|lower|default:'pending' }}">
              <div class="startup-card-left">
                <div class="startup-planet-placeholder" style="width: 70px; height: 70px; border-radius: 50%; margin-bottom: 5px; overflow: hidden; position: relative;">
                  {% if startup.planet_image %}
                    <img src="https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/{{ startup.planet_image }}" alt="{{ startup.title|default:'Планета' }}" style="width: 100%; height: 100%; object-fit: cover;">
                  {% else %}
                    <img src="{% static 'accounts/images/planet_logo_carusel.webp' %}" alt="Планета по умолчанию" style="width: 100%; height: 100%; object-fit: cover;">
                  {% endif %}
                </div>
                <div class="startup-name">
                  {% if startup.title %}
                    <a href="{% url 'startup_detail' startup_id=startup.startup_id|default_if_none:'' %}" style="color: inherit; text-decoration: none;">{{ startup.title|escape }}</a>
                  {% else %}
                    <span style="color: red; font-size: 10px;">(Имя не задано!)</span>
                  {% endif %}
                </div>
                <div class="startup-rating">
                  {% with rating=startup.average_rating|default:0 %}
                    {% for i in "12345"|make_list %}
                      {% if rating >= i|floatformat:0 %}
                        <i class="fas fa-star" aria-hidden="true"></i>
                      {% elif rating >= i|add:-0.5 %}
                        <i class="fas fa-star-half-alt" aria-hidden="true"></i>
                      {% else %}
                        <i class="far fa-star" aria-hidden="true"></i>
                      {% endif %}
                    {% endfor %}
                    <span style="font-size: 12px; color: #868E96; margin-left: 5px;">({{ startup.total_voters|default:0|floatformat:0|intcomma }})</span>
                  {% endwith %}
                </div>
                <div class="startup-comments">
                  <i class="fas fa-comment-dots" aria-hidden="true"></i>
                  <span>{{ startup.comment_count|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>
              <div class="startup-card-right">
                <div class="startup-status-row">
                  <span class="detail-label">Статус</span>
                  <span class="detail-value status-{{ startup.status|lower|default:'pending' }}">
                    {% if startup.status == 'approved' %}Активен{% else %}{{ startup.get_status_display }}{% endif %}
                  </span>
                  <span class="status-value" data-status="{{ startup.status|lower|default:'pending' }}" style="display: none;"></span>
                </div>
                <div class="startup-financials">
                  <div class="startup-detail-row">
                    <span class="detail-label">Собрано:</span>
                    <span class="detail-value">{{ startup.amount_raised|default:'0'|floatformat:0|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Инвесторов:</span>
                    <span class="detail-value">{{ startup.get_investors_count|default:0|floatformat:0|intcomma }}</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Цель:</span>
                    <span class="detail-value">{{ startup.funding_goal|default:'0'|floatformat:0|intcomma }} ₽</span>
                  </div>
                </div>
                <div class="startup-category-row">
                  <span class="detail-label">Категория</span>
                  <span class="startup-category-tag">
                    {{ startup.direction.direction_name|translate_category|default:"Без категории"|escape }}
                  </span>
                </div>
                <a href="{% url 'edit_startup' startup_id=startup.startup_id|default_if_none:'' %}" class="edit-startup-btn" style="align-self: flex-end; margin-top: 10px; color: #007bff; text-decoration: none; font-size: 13px;">Редактировать</a>
              </div>
            </div>
          {% empty %}
            <p style="grid-column: 1 / -1; text-align: center;">У вас пока нет одобренных стартапов.</p>
          {% endfor %}

          
          {% for startup in user_startups|slice:"6:" %}
            <div class="startup-card hidden-card" data-category="{{ startup.direction.direction_name|default:''|escape }}" data-name="{{ startup.title|default:''|escape }}" data-status="{{ startup.status|lower|default:'pending' }}" style="display: none;">
              <div class="startup-card-left">
                <div class="startup-planet-placeholder" style="width: 70px; height: 70px; border-radius: 50%; margin-bottom: 5px; overflow: hidden; position: relative;">
                  {% if startup.planet_image %}
                    <img src="https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/{{ startup.planet_image }}" alt="{{ startup.title|default:'Планета' }}" style="width: 100%; height: 100%; object-fit: cover;">
                  {% else %}
                    <img src="{% static 'accounts/images/planet_logo_carusel.webp' %}" alt="Планета по умолчанию" style="width: 100%; height: 100%; object-fit: cover;">
                  {% endif %}
                </div>
                <div class="startup-name">
                  {% if startup.title %}
                    <a href="{% url 'startup_detail' startup_id=startup.startup_id|default_if_none:'' %}" style="color: inherit; text-decoration: none;">{{ startup.title|escape }}</a>
                  {% else %}
                    <span style="color: red; font-size: 10px;">(Имя не задано!)</span>
                  {% endif %}
                </div>
                <div class="startup-rating">
                  {% with rating=startup.average_rating|default:0 %}
                    {% for i in "12345"|make_list %}
                      {% if rating >= i|floatformat:0 %}
                        <i class="fas fa-star" aria-hidden="true"></i>
                      {% elif rating >= i|add:-0.5 %}
                        <i class="fas fa-star-half-alt" aria-hidden="true"></i>
                      {% else %}
                        <i class="far fa-star" aria-hidden="true"></i>
                      {% endif %}
                    {% endfor %}
                    <span style="font-size: 12px; color: #868E96; margin-left: 5px;">({{ startup.total_voters|default:0|floatformat:0|intcomma }})</span>
                  {% endwith %}
                </div>
                <div class="startup-comments">
                  <i class="fas fa-comment-dots" aria-hidden="true"></i>
                  <span>{{ startup.comment_count|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>
              <div class="startup-card-right">
                <div class="startup-status-row">
                  <span class="detail-label">Статус</span>
                  <span class="detail-value status-{{ startup.status|lower|default:'pending' }}">
                    {% if startup.status == 'approved' %}Активен{% else %}{{ startup.get_status_display }}{% endif %}
                  </span>
                  <span class="status-value" data-status="{{ startup.status|lower|default:'pending' }}" style="display: none;"></span>
                </div>
                <div class="startup-financials">
                  <div class="startup-detail-row">
                    <span class="detail-label">Собрано:</span>
                    <span class="detail-value">{{ startup.amount_raised|default:'0'|floatformat:0|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Инвесторов:</span>
                    <span class="detail-value">{{ startup.get_investors_count|default:0|floatformat:0|intcomma }}</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Цель:</span>
                    <span class="detail-value">{{ startup.funding_goal|default:'0'|floatformat:0|intcomma }} ₽</span>
                  </div>
                </div>
                <div class="startup-category-row">
                  <span class="detail-label">Категория</span>
                  <span class="startup-category-tag">
                    {{ startup.direction.direction_name|translate_category|default:"Без категории"|escape }}
                  </span>
                </div>
                <a href="{% url 'edit_startup' startup_id=startup.startup_id|default_if_none:'' %}" class="edit-startup-btn" style="align-self: flex-end; margin-top: 10px; color: #007bff; text-decoration: none; font-size: 13px;">Редактировать</a>
              </div>
            </div>
          {% endfor %}
        </div>

        
        {% if user_startups|length > 6 %}
          <div class="startup-buttons-container" style="text-align: center; margin-top: 20px;">
            <button class="show-more-btn" id="load-more" type="button">
              Показать еще <i class="fas fa-arrow-right" aria-hidden="true"></i>
            </button>
            <button class="show-more-btn hide-btn" id="hide-startups-btn" style="display: none;" type="button">
              Скрыть <i class="fas fa-arrow-up" aria-hidden="true"></i>
            </button>
          </div>
        {% endif %}
      </div>

      
      <div class="applications-section">
        <div class="applications-header">
          <div class="applications-titles">
            <h2 class="applications-title-main">Заявки</h2>
            <h2 class="applications-title-sub">на стартапы</h2>
          </div>
          <div class="status-filter-buttons">
            <button class="status-filter-btn active" data-status-filter="all">Все</button>
            <button class="status-filter-btn" data-status-filter="approved">Одобрены</button>
            <button class="status-filter-btn" data-status-filter="rejected">Отклонены</button>
            <button class="status-filter-btn" data-status-filter="blocked">Заблокированы</button>
            <button class="status-filter-btn" data-status-filter="closed">Закрыты</button>
        </div>
        </div>

        <div class="applications-list">
          {% for app in startup_applications %}
            <div class="application-card" data-status="{{ app.status|lower|default:'pending' }}">
              <div class="application-title">{{ app.title|default:"Без названия"|escape }}</div>
              <div class="application-status status-{{ app.status|lower|default:'pending' }}">
                {{ app.get_status_display }}
              </div>
              {% if app.status == 'rejected' or app.status == 'blocked' %}
                {% if app.moderator_comment %}
                  <div class="application-comment">
                    <strong>Комментарий модератора:</strong> {{ app.moderator_comment|escape }}
                  </div>
                {% endif %}
              {% endif %}
              {% if app.status == 'pending' or app.status == 'rejected' %}
                <a href="{% url 'edit_startup' startup_id=app.startup_id|default_if_none:'' %}">Редактировать заявку</a>
              {% elif app.status == 'approved' %}
                <a href="{% url 'startup_detail' startup_id=app.startup_id|default_if_none:'' %}">Перейти к стартапу</a>
              {% endif %}
              <span style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">
                Обновлено: {{ app.updated_at|date:"d.m.Y H:i"|default:"Дата неизвестна" }}
              </span>
            </div>
          {% empty %}
            <p style="grid-column: 1 / -1; text-align: center;">У вас пока нет отправленных заявок.</p>
          {% endfor %}
        </div>
      </div>
      
    </div>

    
    <div id="allCategoriesModal" class="modal-overlay">
      <div class="modal-content category-modal-content">
        <button class="modal-close-btn" id="closeCategoriesModalBtn" aria-label="Закрыть модальное окно">×</button>
        <h2 class="modal-title">Все категории стартапов</h2>
        <div class="modal-categories-grid" id="modalCategoriesGrid"></div>
      </div>
    </div>

    
    {{ month_labels|json_script:"chart-month-labels" }}
    {{ chart_monthly_category_data|json_script:"chart-monthly-category-data" }}
    {{ chart_categories|json_script:"chart-categories" }}
    {{ all_directions|json_script:"all-directions-data" }}
    {{ invested_category_data|json_script:"invested-category-data" }}
    {{ planetary_startups_json|json_script:"planetary-startups-data" }}

    <script>
      // Функция для скачивания отчета
      function downloadReport() {
        // Показываем индикатор загрузки
        const button = document.querySelector('.download-report-btn');
        const originalText = button.textContent;
        button.textContent = 'Генерация отчета...';
        button.disabled = true;
        
        // Выполняем запрос на скачивание
        fetch('{% url "download_startups_report" %}')
          .then(response => {
            if (response.ok) {
              return response.blob();
            }
            throw new Error('Ошибка при генерации отчета');
          })
          .then(blob => {
            // Создаем ссылку для скачивания
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_startups_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Восстанавливаем кнопку
            button.textContent = originalText;
            button.disabled = false;
          })
          .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при скачивании отчета. Попробуйте еще раз.');
            
            // Восстанавливаем кнопку
            button.textContent = originalText;
            button.disabled = false;
          });
      }

      // ГЛОБАЛЬНЫЕ ФУНКЦИИ, КОНСТАНТЫ
      const categoryColors = {
          "Medicine": "#e74c3c", "Auto": "#3498db", "Delivery": "#f1c40f",
          "Cafe": "#9b59b6", "Fastfood": "#e67e22", "Health": "#1abc9c",
          "Beauty": "#fd79a8", "Transport": "#2ecc71", "Sport": "#a3ff00",
          "Psychology": "#d35400", "AI": "#00bcd4", "Finance": "#2980b9",
          "Healthcare": "#c0392b", "IT": "#8e44ad", "Retail": "#f39c12",
          "default": "#007bff"
      };
    
      function translateCategoryName(name) {
          const translations = {
              "Medicine": "Медицина", "Auto": "Автомобили", "Delivery": "Доставка",
              "Cafe": "Кафе/рестораны", "Fastfood": "Фастфуд", "Health": "Здоровье",
              "Beauty": "Красота", "Transport": "Транспорт", "Sport": "Спорт",
              "Psychology": "Психология", "AI": "ИИ", "Finance": "Финансы",
              "Healthcare": "Здравоохранение", "Technology": "Технологии", "IT": "ИТ",
              "Retail": "Ритейл"
          };
          return translations[name] || name || "Без категории";
      }
    
      function updateRadialChartColors() {
        document.querySelectorAll('.radial-chart').forEach(chart => {
          const percentage = parseInt(chart.dataset.percentage || 0, 10);
          const categoryName = chart.dataset.categoryName || '';
          const color = categoryColors[categoryName] || categoryColors["default"];
          const progressElement = chart.querySelector('.radial-chart-progress');
          const textElement = chart.querySelector('.radial-chart-text');
          if (progressElement) {
              progressElement.style.setProperty('--percentage', percentage);
              progressElement.style.setProperty('--progress-color', color);
          }
          if (!chart.closest('.category-all') && textElement) {
                textElement.textContent = `${percentage}%`;
          }
        });
         document.querySelectorAll('.category-radial-name').forEach(span => {
            const item = span.closest('.category-radial-item');
            if (item && !item.classList.contains('category-all')) {
                const chart = item.querySelector('.radial-chart');
                if (chart) {
                    const originalName = chart.dataset.categoryName;
                    span.textContent = translateCategoryName(originalName);
                }
            }
         });
      }
    
      function openModal(directionsData, investedDataDict) {
          const modalOverlay = document.getElementById('allCategoriesModal');
          const modalGrid = document.getElementById('modalCategoriesGrid');
    
          if (!modalOverlay || !modalGrid) return;
    
          modalGrid.innerHTML = '';
          if (directionsData && directionsData.length > 0) {
              directionsData.sort((a, b) => (investedDataDict[b.direction_name] || 0) - (investedDataDict[a.direction_name] || 0));
    
              directionsData.forEach(direction => {
                  const categoryName = direction.direction_name;
                  const percentage = investedDataDict[categoryName] || 0;
                  const translatedName = translateCategoryName(categoryName);
                  const color = categoryColors[categoryName] || categoryColors["default"];
                  const item = document.createElement('div');
                  item.classList.add('modal-category-item');
                  item.innerHTML = `
                      <div class="radial-chart" data-percentage="${percentage}" data-category-name="${categoryName}">
                        <div class="radial-chart-progress" style="--percentage: ${percentage}; --progress-color: ${color};"></div>
                        <div class="radial-chart-text">${percentage}%</div>
                      </div>
                      <span class="modal-category-name">${translatedName}</span>
                  `;
                  modalGrid.appendChild(item);
              });
          } else {
              modalGrid.innerHTML = '<p>Нет доступных категорий.</p>';
          }
    
          modalOverlay.classList.add('visible');
          document.body.classList.add('modal-open-blur');
      }
    
      function closeModal() {
          const modalOverlay = document.getElementById('allCategoriesModal');
          if (!modalOverlay) return;
          modalOverlay.classList.remove('visible');
          document.body.classList.remove('modal-open-blur');
      }
    
      function filterByCategory(event) {
          event.preventDefault();
          const selectedCategory = event.target.dataset.category;
          const categoryButton = document.querySelector('.filter-btn[data-filter="category"]');
          const filterButtons = document.querySelectorAll('.filter-btn');
          const startupCards = document.querySelectorAll('.startups-grid .startup-card');
          const loadMoreBtn = document.getElementById('load-more');
          const hideBtn = document.getElementById('hide-startups-btn');
          const startupGrid = document.querySelector('.startups-grid');
    
          filterButtons.forEach(btn => btn.classList.remove('active'));
          if (categoryButton) {
               categoryButton.classList.add('active');
               const chevron = categoryButton.querySelector('i');
               categoryButton.textContent = translateCategoryName(selectedCategory) + ' ';
               if (chevron) categoryButton.appendChild(chevron);
          }
    
          let visibleCount = 0;
          startupCards.forEach(card => {
              if (card.dataset.category === selectedCategory) {
                  if (visibleCount < 6) {
                       card.style.display = 'flex';
                       visibleCount++;
                  } else {
                      card.style.display = 'none';
                      card.classList.add('hidden-card');
                  }
              } else {
                  card.style.display = 'none';
              }
          });
    
          if (loadMoreBtn) loadMoreBtn.style.display = 'none';
          if (hideBtn) hideBtn.style.display = 'none';
    
          let startupsNoResultsMsg = startupGrid.querySelector('.no-results-message');
          if (visibleCount === 0) {
              if (!startupsNoResultsMsg) {
                  const p = document.createElement('p');
                  p.textContent = `Нет стартапов в категории "${translateCategoryName(selectedCategory)}".`;
                  p.style.gridColumn = '1 / -1';
                  p.style.textAlign = 'center';
                  p.classList.add('no-results-message');
                  startupGrid.appendChild(p);
              }
          } else {
              if (startupsNoResultsMsg) {
                  startupsNoResultsMsg.remove();
              }
          }
      }
    
      document.addEventListener('DOMContentLoaded', function() {
          let parsedDirections = [];
          let parsedInvestedData = {};
          try {
              const directionsElement = document.getElementById('all-directions-data');
              const investedElement = document.getElementById('invested-category-data');
              if (directionsElement) {
                  parsedDirections = JSON.parse(directionsElement.textContent);
              }
              if (investedElement) {
                  parsedInvestedData = JSON.parse(investedElement.textContent);
              }
          } catch (e) {
              
          }
    
          updateRadialChartColors();
    
          const categoryDropdownContent = document.querySelector('.filter-dropdown-content');
          if (categoryDropdownContent) {
              const directionsForDropdown = parsedDirections || [];
              categoryDropdownContent.innerHTML = '';
              if (directionsForDropdown.length > 0) {
                   const allLink = document.createElement('a');
                   allLink.href = '#';
                   allLink.dataset.filter = 'all';
                   allLink.textContent = 'Все категории';
                   allLink.addEventListener('click', (e) => {
                       e.preventDefault();
                       document.querySelector('.filter-btn[data-filter="all"]').click();
                       const categoryButton = document.querySelector('.filter-btn[data-filter="category"]');
                       const chevron = categoryButton.querySelector('i');
                       categoryButton.textContent = 'Категория ';
                       if (chevron) categoryButton.appendChild(chevron);
                   });
                   categoryDropdownContent.appendChild(allLink);
    
                   directionsForDropdown.forEach(direction => {
                      const link = document.createElement('a');
                      link.href = '#';
                      link.dataset.category = direction.direction_name;
                      link.textContent = translateCategoryName(direction.direction_name);
                      link.addEventListener('click', filterByCategory);
                      categoryDropdownContent.appendChild(link);
                  });
              } else {
                  categoryDropdownContent.innerHTML = '<a href="#">Нет категорий</a>';
              }
          }
    
          const searchInput = document.getElementById('startup-search');
          const startupGrid = document.querySelector('.startups-grid');
          if (searchInput && startupGrid) {
             searchInput.addEventListener('input', function() {
                 const searchTerm = this.value.toLowerCase().trim();
                 const startupCards = startupGrid.querySelectorAll('.startup-card');
                 const loadMoreBtnSearch = document.getElementById('load-more');
                 const hideBtnSearch = document.getElementById('hide-startups-btn');
                 let visibleCount = 0;
                 const activeCategoryButton = document.querySelector('.filter-btn[data-filter="category"].active');
                 let activeCategoryFilter = null;
                 if (activeCategoryButton) {
                     const links = categoryDropdownContent.querySelectorAll('a');
                     for(let link of links){
                         if(translateCategoryName(link.dataset.category) === activeCategoryButton.textContent.trim().split(' ')[0]){
                             activeCategoryFilter = link.dataset.category;
                             break;
                         }
                     }
                     if (!activeCategoryFilter && !document.querySelector('.filter-btn[data-filter="all"].active')) {
                         console.warn("Не удалось определить активный фильтр категории для поиска.");
                         activeCategoryFilter = null;
                     } else if (document.querySelector('.filter-btn[data-filter="all"].active')) {
                          activeCategoryFilter = null;
                     }
                 }
    
                 startupCards.forEach(card => {
                    const name = card.getAttribute('data-name').toLowerCase();
                    const category = card.getAttribute('data-category');
    
                    const matchesCategory = !activeCategoryFilter || (category === activeCategoryFilter);
                    const matchesSearch = name.includes(searchTerm);
    
                    if (matchesSearch && matchesCategory) {
                         if (visibleCount < 6) {
                              card.style.display = 'flex';
                              visibleCount++;
                         } else {
                             card.style.display = 'none';
                             card.classList.add('hidden-card');
                         }
                    } else {
                        card.style.display = 'none';
                    }
                 });
    
                 if (loadMoreBtnSearch) loadMoreBtnSearch.style.display = 'none';
                 if (hideBtnSearch) hideBtnSearch.style.display = 'none';
    
                 let startupsNoResultsMsg = startupGrid.querySelector('.no-results-message');
                 if (visibleCount === 0 && searchTerm !== '') {
                      if (!startupsNoResultsMsg) {
                          const p = document.createElement('p');
                          p.textContent = 'По вашему запросу ничего не найдено.';
                          p.style.gridColumn = '1 / -1';
                          p.style.textAlign = 'center';
                          p.classList.add('no-results-message');
                          startupGrid.appendChild(p);
                      }
                  } else {
                      if (startupsNoResultsMsg) {
                          startupsNoResultsMsg.remove();
                      }
                  }
             });
          }
    
          const filterButtons = document.querySelectorAll('.filter-btn');
          const allStartupCards = startupGrid.querySelectorAll('.startup-card');
          const loadMoreBtn = document.getElementById('load-more');
          const hideBtn = document.getElementById('hide-startups-btn');
    
          filterButtons.forEach(button => {
              button.addEventListener('click', function(event) {
                  if (this.classList.contains('filter-btn-dropdown')) {
                     return;
                  }
                  if (event.target.tagName === 'A' && event.target.closest('.filter-dropdown-content')) {
                      return;
                  }
    
                 filterButtons.forEach(btn => btn.classList.remove('active'));
                 this.classList.add('active');
                 const filter = this.getAttribute('data-filter');
    
                 let startupsNoResultsMsg = startupGrid.querySelector('.no-results-message');
                 if (startupsNoResultsMsg) startupsNoResultsMsg.remove();
    
                 if (filter === 'all') {
                     let visibleCount = 0;
                     allStartupCards.forEach(card => {
                        if (visibleCount < 6) {
                            card.style.display = 'flex';
                            card.classList.remove('hidden-card');
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                            card.classList.add('hidden-card');
                        }
                     });
                    const hiddenCardsAfterReset = startupGrid.querySelectorAll('.startup-card.hidden-card');
                    if (hiddenCardsAfterReset.length > 0) {
                        if (loadMoreBtn) loadMoreBtn.style.display = 'flex';
                        if (hideBtn) hideBtn.style.display = 'none';
                    } else {
                        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                        if (hideBtn) hideBtn.style.display = 'none';
                    }
                    const categoryButton = document.querySelector('.filter-btn[data-filter="category"]');
                    if (categoryButton) {
                         const chevron = categoryButton.querySelector('i');
                         categoryButton.textContent = 'Категория ';
                         if (chevron) categoryButton.appendChild(chevron);
                    }
                    if(searchInput) searchInput.value = '';
                 }
    
                 // Вызываем фильтрацию для "Мои стартапы" (без статуса)
                 const searchInput = document.getElementById('startup-search');
                 const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const startupCards = startupGrid.querySelectorAll('.startup-card');
                 const loadMoreBtnSearch = document.getElementById('load-more');
                 const hideBtnSearch = document.getElementById('hide-startups-btn');
                 let visibleCount = 0;
                 const activeCategoryButton = document.querySelector('.filter-btn[data-filter="category"].active');
                 let activeCategoryFilter = null;
                 if (activeCategoryButton) {
                     const links = categoryDropdownContent.querySelectorAll('a');
                     for(let link of links){
                         if(translateCategoryName(link.dataset.category) === activeCategoryButton.textContent.trim().split(' ')[0]){
                             activeCategoryFilter = link.dataset.category;
                             break;
                         }
                     }
                     if (!activeCategoryFilter && !document.querySelector('.filter-btn[data-filter="all"].active')) {
                         console.warn("Не удалось определить активный фильтр категории для поиска.");
                         activeCategoryFilter = null;
                     } else if (document.querySelector('.filter-btn[data-filter="all"].active')) {
                         activeCategoryFilter = null;
                     }
                 }
    
                 startupCards.forEach(card => {
                     const name = card.getAttribute('data-name').toLowerCase();
                     const category = card.getAttribute('data-category');
    
                     const matchesCategory = !activeCategoryFilter || (category === activeCategoryFilter);
                     const matchesSearch = name.includes(searchTerm);
    
                     if (matchesSearch && matchesCategory) {
                         if (visibleCount < 6) {
                             card.style.display = 'flex';
                             visibleCount++;
                         } else {
                             card.style.display = 'none';
                             card.classList.add('hidden-card');
                         }
                     } else {
                         card.style.display = 'none';
                     }
                 });
    
                 if (loadMoreBtnSearch) loadMoreBtnSearch.style.display = 'none';
                 if (hideBtnSearch) hideBtnSearch.style.display = 'none';
    
                 startupsNoResultsMsg = startupGrid.querySelector('.no-results-message');
                 if (visibleCount === 0 && searchTerm !== '') {
                     if (!startupsNoResultsMsg) {
                         const p = document.createElement('p');
                         p.textContent = 'По вашему запросу ничего не найдено.';
                         p.style.gridColumn = '1 / -1';
                         p.style.textAlign = 'center';
                         p.classList.add('no-results-message');
                         startupGrid.appendChild(p);
                     }
                 } else {
                     if (startupsNoResultsMsg) {
                         startupsNoResultsMsg.remove();
                     }
                 }
             });
         });
    
         if (loadMoreBtn) {
             loadMoreBtn.addEventListener('click', function() {
                 const currentlyHiddenCards = startupGrid.querySelectorAll('.startup-card.hidden-card');
                 currentlyHiddenCards.forEach(card => {
                     card.style.display = 'flex';
                     card.classList.remove('hidden-card');
                 });
                 this.style.display = 'none';
                 if (hideBtn) hideBtn.style.display = 'flex';
             });
         }
    
         if (hideBtn) {
             hideBtn.addEventListener('click', function() {
                  let visibleCount = 0;
                  startupGrid.querySelectorAll('.startup-card').forEach(card => {
                       if (card.style.display === 'flex') {
                           if (visibleCount >= 6) {
                               card.style.display = 'none';
                               card.classList.add('hidden-card');
                           }
                           visibleCount++;
                       }
                  });
                 this.style.display = 'none';
                 if (loadMoreBtn && startupGrid.querySelectorAll('.startup-card.hidden-card').length > 0) {
                      loadMoreBtn.style.display = 'flex';
                 }
             });
         }
    
         const openModalBtn = document.getElementById('openCategoriesModalBtn');
         const closeModalBtn = document.getElementById('closeCategoriesModalBtn');
         const modalOverlay = document.getElementById('allCategoriesModal');
         if (openModalBtn) {
             openModalBtn.addEventListener('click', function() {
                 openModal(parsedDirections, parsedInvestedData);
             });
         }
         if (closeModalBtn) {
             closeModalBtn.addEventListener('click', closeModal);
         }
         if (modalOverlay) {
             modalOverlay.addEventListener('click', function(event) {
                 if (event.target === modalOverlay) {
                     closeModal();
                 }
             });
         }
    
         document.querySelectorAll('.filter-dropdown-content a').forEach(link => {
             link.addEventListener('click', function(event) {
                 filterByCategory(event);
                 // Вызываем фильтрацию для "Мои стартапы" (без статуса)
                 const searchInput = document.getElementById('startup-search');
                 const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const startupCards = startupGrid.querySelectorAll('.startup-card');
                 const loadMoreBtnSearch = document.getElementById('load-more');
                 const hideBtnSearch = document.getElementById('hide-startups-btn');
                 let visibleCount = 0;
                 const activeCategoryButton = document.querySelector('.filter-btn[data-filter="category"].active');
                 let activeCategoryFilter = null;
                 if (activeCategoryButton) {
                     const links = categoryDropdownContent.querySelectorAll('a');
                     for(let link of links){
                         if(translateCategoryName(link.dataset.category) === activeCategoryButton.textContent.trim().split(' ')[0]){
                             activeCategoryFilter = link.dataset.category;
                             break;
                         }
                     }
                     if (!activeCategoryFilter && !document.querySelector('.filter-btn[data-filter="all"].active')) {
                         console.warn("Не удалось определить активный фильтр категории для поиска.");
                         activeCategoryFilter = null;
                     } else if (document.querySelector('.filter-btn[data-filter="all"].active')) {
                         activeCategoryFilter = null;
                     }
                 }
    
                 startupCards.forEach(card => {
                     const name = card.getAttribute('data-name').toLowerCase();
                     const category = card.getAttribute('data-category');
    
                     const matchesCategory = !activeCategoryFilter || (category === activeCategoryFilter);
                     const matchesSearch = name.includes(searchTerm);
    
                     if (matchesSearch && matchesCategory) {
                         if (visibleCount < 6) {
                             card.style.display = 'flex';
                             visibleCount++;
                         } else {
                             card.style.display = 'none';
                             card.classList.add('hidden-card');
                         }
                     } else {
                         card.style.display = 'none';
                     }
                 });
    
                 if (loadMoreBtnSearch) loadMoreBtnSearch.style.display = 'none';
                 if (hideBtnSearch) hideBtnSearch.style.display = 'none';
    
                 let startupsNoResultsMsg = startupGrid.querySelector('.no-results-message');
                 if (visibleCount === 0 && searchTerm !== '') {
                     if (!startupsNoResultsMsg) {
                         const p = document.createElement('p');
                         p.textContent = 'По вашему запросу ничего не найдено.';
                         p.style.gridColumn = '1 / -1';
                         p.style.textAlign = 'center';
                         p.classList.add('no-results-message');
                         startupGrid.appendChild(p);
                     }
                 } else {
                     if (startupsNoResultsMsg) {
                         startupsNoResultsMsg.remove();
                     }
                 }
             });
         });
    
         // Добавляем логику для фильтрации по статусу в разделе "Заявки на стартапы"
         function applyApplicationFilters() {
             const activeButton = document.querySelector('.status-filter-btn.active');
             const statusFilter = activeButton ? activeButton.getAttribute('data-status-filter') : 'all';
             const applicationCards = document.querySelectorAll('.applications-list .application-card');
    
             let visibleCount = 0;
             applicationCards.forEach(card => {
                 const status = card.getAttribute('data-status');
                 const matchesStatus = statusFilter === 'all' || status === statusFilter;
    
                 if (matchesStatus) {
                     card.style.display = 'flex';
                     visibleCount++;
                 } else {
                     card.style.display = 'none';
                 }
             });
    
             let applicationsNoResultsMsg = document.querySelector('.applications-list .no-results-message');
             // Отключаем автоматическое добавление сообщения, чтобы не было дублирующих системных сообщений
             if (applicationsNoResultsMsg) {
                 applicationsNoResultsMsg.remove();
             }
         }
    
         // Обработчик для кнопок фильтрации в "Заявки на стартапы"
         const statusFilterButtons = document.querySelectorAll('.status-filter-btn');
         statusFilterButtons.forEach(button => {
             button.addEventListener('click', function() {
                 statusFilterButtons.forEach(btn => btn.classList.remove('active'));
                 this.classList.add('active');
                 applyApplicationFilters();
             });
         });
    
         // Инициализация фильтрации при загрузке страницы
         applyApplicationFilters();
    
         (function() {
             const canvasElement = document.getElementById('monthlyInvestmentChart');
             if (!canvasElement) {
 
                 return;
             }
             const ctx = canvasElement.getContext('2d');
    
             let monthLabels = [];
             let monthlyCategoryData = [];
             let categoriesForChart = [];
    
             try {
                 const labelsEl = document.getElementById('chart-month-labels');
                 const monthlyDataEl = document.getElementById('chart-monthly-category-data');
                 const categoriesEl = document.getElementById('chart-categories');
    
                 if (!labelsEl || !monthlyDataEl || !categoriesEl) throw new Error("Элементы данных графика не найдены");
    
                 monthLabels = JSON.parse(labelsEl.textContent);
                 monthlyCategoryData = JSON.parse(monthlyDataEl.textContent);
                 categoriesForChart = JSON.parse(categoriesEl.textContent);
    
                 
             } catch (e) {
 
                 if (canvasElement.parentNode) {
                   canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: red;">Ошибка загрузки данных для графика.</p>';
                 }
                 return;
             }
    
             const hasData = monthlyCategoryData && monthlyCategoryData.some(month => Object.keys(month.category_data).length > 0);
             
    
             if (hasData && categoriesForChart.length > 0) {
                 const datasets = categoriesForChart.map(categoryName => {
                     const color = categoryColors[categoryName] || categoryColors["default"];
                     const data = monthLabels.map((label, index) => {
                         const monthData = monthlyCategoryData[index];
                         return monthData.category_data[categoryName] || 0;
                     });
    
                     return {
                         label: translateCategoryName(categoryName),
                         data: data,
                         backgroundColor: color,
                     };
                 });
    
 
    
                 new Chart(ctx, {
                     type: 'bar',
                     data: {
                         labels: monthLabels,
                         datasets: datasets
                     },
                     options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       interaction: {
                           mode: 'index',
                           intersect: false,
                       },
                       scales: {
                           y: {
                               stacked: true,
                               beginAtZero: true,
                               grid: { color: 'rgba(255, 255, 255, 0.05)' },
                               ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                   callback: function(value) {
                                       if (value >= 1000000) { return (value / 1000000).toLocaleString('ru-RU', { maximumFractionDigits: 1 }) + 'M'; }
                                       if (value >= 1000) { return (value / 1000).toLocaleString('ru-RU', { maximumFractionDigits: 0 }) + 'k'; }
                                       else { return value.toLocaleString('ru-RU'); }
                                   }
                               },
                               title: {
                                   display: true,
                                   text: 'Сумма сборов, ₽',
                                   color: 'rgba(255, 255, 255, 0.7)'
                               }
                           },
                           x: {
                               stacked: true,
                               grid: { display: false },
                               ticks: { color: '#495057' }
                           }
                       },
                       plugins: {
                           legend: {
                               display: true,
                               position: 'top',
                               labels: {
                                   color: 'rgba(255, 255, 255, 0.7)',
                                   boxWidth: 12,
                                   padding: 15
                               }
                            },
                           tooltip: {
                               callbacks: {
                                   title: function(tooltipItems) {
                                       return tooltipItems[0].label;
                                   },
                                   label: function(context) {
                                       let label = context.dataset.label || '';
                                       if (label) { label += ': '; }
                                       if (context.parsed.y !== null) {
                                           label += context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₽';
                                       }
                                       return label;
                                   }
                               }
                           }
                       }
                     }
                 });
             } else {

                if (canvasElement.parentNode) {
                   canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: #adb5bd;">Нет данных по сборам средств за текущий год для отображения по категориям.</p>';
                }
             }
         })();
    
          // Планетарная система
          (function() {
              const rawData = document.getElementById('planetary-startups-data').textContent || '[]';

              
              let startups_data;
              try {
                  // Убираем лишние пробелы и экранирование
                  const cleanData = rawData.trim();
                                  startups_data = JSON.parse(cleanData);
                              } catch (error) {
                    startups_data = [];
                }
              const startups = {};
              // Проверяем, что данные являются массивом или объектом с данными
                              if (Array.isArray(startups_data)) {
                    startups_data.forEach((s, index) => {
                        if (s && s.startup_id) {
                            const startupId = s.startup_id.toString();
                            startups[startupId] = {
                                startup_id: s.startup_id,
                                image: s.planet_image ? `https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/${s.planet_image}` : '{% static "accounts/images/planet_logo_carusel.webp" %}',
                                name: s.title || s.name || 'Без названия',
                                rating: s.average_rating || s.rating || 0,
                                comment_count: s.comment_count || 0,
                                progress: s.progress || '0%',
                                direction: s.direction || 'Без категории',
                                funding_goal: s.funding_goal || 0,
                                investors: s.get_investors_count || s.investors || 0,
                                investment_type: s.investment_type || 'Не указано',
                                description: s.description || s.short_description || 'Описание отсутствует'
                            };
                        }
                    });
                              } else if (startups_data && typeof startups_data === 'object' && 'length' in startups_data && startups_data.length > 0) {
                    for (let i = 0; i < startups_data.length; i++) {
                        const s = startups_data[i];
                        if (s && s.startup_id) {
                            const startupId = s.startup_id.toString();
                            startups[startupId] = {
                                startup_id: s.startup_id,
                                image: s.planet_image ? `https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/${s.planet_image}` : '{% static "accounts/images/planet_logo_carusel.webp" %}',
                                name: s.title || s.name || 'Без названия',
                                rating: s.average_rating || s.rating || 0,
                                comment_count: s.comment_count || 0,
                                progress: s.progress || '0%',
                                direction: s.direction || 'Без категории',
                                funding_goal: s.funding_goal || 0,
                                investors: s.get_investors_count || s.investors || 0,
                                investment_type: s.investment_type || 'Не указано',
                                description: s.description || s.short_description || 'Описание отсутствует'
                            };
                        }
                    }
                              } else if (startups_data && typeof startups_data === 'object') {
                    // Если это объект, попробуем обработать его как массив
                    const dataArray = Object.values(startups_data);
                    dataArray.forEach((s, index) => {
                        if (s && s.startup_id) {
                            const startupId = s.startup_id.toString();
                            startups[startupId] = {
                                startup_id: s.startup_id,
                                image: s.planet_image ? `https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/${s.planet_image}` : '{% static "accounts/images/planet_logo_carusel.webp" %}',
                                name: s.title || s.name || 'Без названия',
                                rating: s.average_rating || s.rating || 0,
                                comment_count: s.comment_count || 0,
                                progress: s.progress || '0%',
                                direction: s.direction || 'Без категории',
                                funding_goal: s.funding_goal || 0,
                                investors: s.get_investors_count || s.investors || 0,
                                investment_type: s.investment_type || 'Не указано',
                                description: s.description || s.short_description || 'Описание отсутствует'
                            };
                        }
                    });
                              } else {
                    // Попробуем принудительно обработать как массив, если это строка с JSON
                    if (typeof startups_data === 'string' && startups_data.startsWith('[') && startups_data.endsWith(']')) {
                        try {
                            const parsedArray = JSON.parse(startups_data);
                            if (Array.isArray(parsedArray)) {
                                parsedArray.forEach((s, index) => {
                                    if (s && s.startup_id) {
                                        const startupId = s.startup_id.toString();
                                        startups[startupId] = {
                                            startup_id: s.startup_id,
                                            image: s.planet_image ? `https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/${s.planet_image}` : '{% static "accounts/images/planet_logo_carusel.webp" %}',
                                            name: s.title || s.name || 'Без названия',
                                            rating: s.average_rating || s.rating || 0,
                                            comment_count: s.comment_count || 0,
                                            progress: s.progress || '0%',
                                            direction: s.direction || 'Без категории',
                                            funding_goal: s.funding_goal || 0,
                                            investors: s.get_investors_count || s.investors || 0,
                                            investment_type: s.investment_type || 'Не указано',
                                            description: s.description || s.short_description || 'Описание отсутствует'
                                        };
                                    }
                                });
                            }
                        } catch (parseError) {
                            // Игнорируем ошибки парсинга
                        }
                    }
                }
              


              const planets = document.querySelectorAll('.my_startups_planetary-system .planet');
              const solarSystem = document.querySelector('.my_startups_planetary-system#my_startups_solar-system');
              const scene = document.querySelector('.my_startups_planetary-system #my_startups_scene');
              const galaxy = document.querySelector('.my_startups_planetary-system #my_startups_galaxy');
              const logoElement = document.querySelector('.my_startups_planetary-system #my_startups_logo');

              const galaxyTiltAngle = 60;
              const planetTiltCompensation = -60;
              const planetObjects = [];
              let isPaused = false;
              let pausedTime = 0;
              let lastInteractionTime = Date.now();
              const inactivityTimeout = 10000;
              let isReturningToCenter = false;
              let isDragging = false;
              let startX, startY;
              let offsetX = 0;
              let offsetY = 0;
              let scale = 1;
              let currentStartupID = null;

              planets.forEach((planet, index) => {
                  const orbit = planet.closest('.orbit');
                  const planetOrientation = planet.closest('.planet-orientation');
                  if (!orbit || !planetOrientation) {
      
                      return;
                  }

                  const orbitSize = parseFloat(getComputedStyle(orbit).getPropertyValue('--orbit-size')) || 200;
                  if (orbitSize < 100) {
                      planetOrientation.style.display = 'none'; // Скрываем планеты с орбитой меньше 100px
                      return;
                  }

                  const orbitTime = parseFloat(getComputedStyle(orbit).getPropertyValue('--orbit-time')) || 10;
                  const initialAngle = Math.random() * 360;
                  const speedFactor = 0.8 + Math.random() * 0.4;
                  const radius = orbitSize / 2;

                  if (radius > 0) {
                      const angleRad = initialAngle * Math.PI / 180;
                      const x = Math.cos(angleRad) * radius;
                      const y = Math.sin(angleRad) * radius;
                      planetOrientation.style.left = `${50 + 50 * (x / radius)}%`;
                      planetOrientation.style.top = `${50 + 50 * (y / radius)}%`;
                  } else {
      
                  }

                  const tiltCompensation = planetTiltCompensation;
                  planet.style.transform = `rotateX(${tiltCompensation}deg)`;

                  planetObjects.push({
                      element: planet,
                      orientation: planetOrientation,
                      orbit: orbit,
                      size: parseFloat(getComputedStyle(planet).getPropertyValue('--planet-size')) || 50,
                      orbitSize: orbitSize,
                      orbitTime: orbitTime,
                      angle: initialAngle,
                      speedFactor: speedFactor,
                      startTime: Date.now() - Math.random() * orbitTime * 1000
                  });

                  const id = planet.getAttribute('data-id');
                  if (startups[id]) {
                      planet.style.backgroundImage = 'none';
                      planet.style.backgroundColor = 'transparent';
                      const img = planet.querySelector('.planet-img');
                      if (img) {
                          img.onerror = () => {
              
                              img.src = '{% static "accounts/images/planet_logo_carusel.webp" %}';
                          };
                      }
                  }

                  // Обработчик клика для планеты и всех её дочерних элементов
                  const handlePlanetClick = (e) => {
                      e.stopPropagation();
                      const id = planet.getAttribute('data-id');
                      
                      const startup = startups[id];
                      if (!startup) {
                          return;
                      }

                      // Заполняем новое модальное окно
                      const modal = document.getElementById('planetary-modal');
                      const modalPlanetImg = document.getElementById('planetary-modal-planet-img');
                      const modalName = document.getElementById('planetary-modal-name');
                      const modalRating = document.getElementById('planetary-modal-rating');
                      const modalCommentsCount = document.getElementById('planetary-modal-comments-count');
                      const modalCategory = document.getElementById('planetary-modal-category');
                      const modalProgressPercentage = document.getElementById('planetary-modal-progress-percentage');
                      const modalDescription = document.getElementById('planetary-modal-description');
                      const modalFundingAmount = document.getElementById('planetary-modal-funding-amount');
                      const modalValuationAmount = document.getElementById('planetary-modal-valuation-amount');
                      const modalInvestorsCount = document.getElementById('planetary-modal-investors-count');
                      const modalDetailsBtn = document.getElementById('planetary-modal-details-btn');

                      modalPlanetImg.src = startup.image;
                      modalName.textContent = startup.name || startup.title || 'Без названия';
                      modalRating.textContent = `Рейтинг ${(startup.rating || startup.average_rating || 0).toFixed(1)}/5 (${startup.comment_count || 0})`;
                      modalCommentsCount.textContent = startup.comment_count;
                      
                      // Перевод категорий
                      const translateCategory = (category) => {
                          const translations = {
                              'Technology': 'Технологии',
                              'Finance': 'Финансы',
                              'Health': 'Здоровье',
                              'Education': 'Образование',
                              'Entertainment': 'Развлечения',
                              'Food': 'Еда',
                              'Fashion': 'Мода',
                              'Sports': 'Спорт',
                              'Travel': 'Путешествия',
                              'Real Estate': 'Недвижимость',
                              'Transport': 'Транспорт',
                              'Energy': 'Энергетика',
                              'Agriculture': 'Сельское хозяйство',
                              'Media': 'Медиа',
                              'Security': 'Безопасность',
                              'Environment': 'Экология',
                              'Beauty': 'Красота',
                              'Cafe': 'Кафе',
                              'Delivery': 'Доставка',
                              'Fastfood': 'Фастфуд'
                          };
                          return translations[category] || category;
                      };
                      modalCategory.textContent = translateCategory(startup.direction);
                      modalProgressPercentage.textContent = startup.progress;
                      modalDescription.textContent = startup.description || startup.short_description || 'Описание отсутствует';
                      
                      // Форматируем сумму правильно
                      const formatAmount = (amount) => {
                          const num = parseFloat(amount) || 0;
                          if (num === 0) return '0 ₽';
                          // Убираем десятичные знаки если они .0000
                          const cleanNum = num % 1 === 0 ? Math.floor(num) : num;
                          return `${cleanNum.toLocaleString('ru-RU')} ₽`;
                      };
                      modalFundingAmount.textContent = formatAmount(startup.funding_goal);
                      
                      // Форматируем оценку правильно
                      const formatValuation = (amount) => {
                          const num = parseFloat(amount) || 0;
                          if (num === 0) return '0 ₽';
                          const valuation = num * 1.2;
                          const cleanValuation = valuation % 1 === 0 ? Math.floor(valuation) : valuation;
                          return `${cleanValuation.toLocaleString('ru-RU')} ₽`;
                      };
                      modalValuationAmount.textContent = formatValuation(startup.funding_goal);
                      modalInvestorsCount.textContent = `Инвестировало (${startup.investors || startup.get_investors_count || 0})`;

                      // Обработчик для кнопки "Подробнее"
                      modalDetailsBtn.onclick = () => {
                          if (startup.startup_id) {
                              window.location.href = `/startups/${startup.startup_id}/`;
                          }
                      };

                      currentStartupID = startup.startup_id;

                      // Показываем модальное окно
                      modal.style.display = 'flex';
                      planets.forEach(p => p.classList.remove('active'));
                      planet.classList.add('active');

                      // Пауза анимации
                      if (!isPaused) {
                          isPaused = true;
                          pausedTime = Date.now();
                      }
                      lastInteractionTime = Date.now();
                  };

                  // Добавляем обработчик на саму планету
                  planet.addEventListener('click', handlePlanetClick);
                  
                  // Добавляем обработчик на все дочерние элементы планеты
                  const planetChildren = planet.querySelectorAll('*');
                  planetChildren.forEach(child => {
                      child.addEventListener('click', handlePlanetClick);
                      child.style.pointerEvents = 'auto';
                  });
              });

              // Обработчик закрытия нового модального окна
              const modalCloseBtn = document.getElementById('planetary-modal-close');
              const modal = document.getElementById('planetary-modal');
              
              modalCloseBtn.addEventListener('click', () => {
                  modal.style.display = 'none';
                  planets.forEach(p => p.classList.remove('active'));
                  if (isPaused) {
                      const pauseDuration = Date.now() - pausedTime;
                      planetObjects.forEach(planetObj => {
                          planetObj.startTime += pauseDuration;
                      });
                      isPaused = false;
                  }
                  lastInteractionTime = Date.now();
              });

              // Закрытие модального окна при клике на backdrop
              const modalBackdrop = document.querySelector('.planetary-modal-backdrop');
              modalBackdrop.addEventListener('click', () => {
                  modal.style.display = 'none';
                  planets.forEach(p => p.classList.remove('active'));
                  if (isPaused) {
                      const pauseDuration = Date.now() - pausedTime;
                      planetObjects.forEach(planetObj => {
                          planetObj.startTime += pauseDuration;
                      });
                      isPaused = false;
                  }
                  lastInteractionTime = Date.now();
              });

              // Закрытие на ESC
              document.addEventListener('keydown', (e) => {
                  if (e.key === 'Escape' && modal.style.display !== 'none') {
                      modal.style.display = 'none';
                      planets.forEach(p => p.classList.remove('active'));
                      if (isPaused) {
                          const pauseDuration = Date.now() - pausedTime;
                          planetObjects.forEach(planetObj => {
                              planetObj.startTime += pauseDuration;
                          });
                          isPaused = false;
                      }
                      lastInteractionTime = Date.now();
                  }
              });

              solarSystem.addEventListener('mousedown', (e) => {
                  e.preventDefault();
                  isDragging = true;
                  startX = e.clientX;
                  startY = e.clientY;
                  solarSystem.classList.add('dragging');
                  lastInteractionTime = Date.now();
                  isReturningToCenter = false;
              });

              document.addEventListener('mousemove', (e) => {
                  if (!isDragging) return;
                  const deltaX = e.clientX - startX;
                  const deltaY = e.clientY - startY;
                  offsetX += deltaX;
                  offsetY += deltaY;
                  offsetX = Math.max(-solarSystem.offsetWidth / 2, Math.min(solarSystem.offsetWidth / 2, offsetX));
                  offsetY = Math.max(-solarSystem.offsetHeight / 2, Math.min(solarSystem.offsetHeight / 2, offsetY));
                  scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                  startX = e.clientX;
                  startY = e.clientY;
                  lastInteractionTime = Date.now();
              });

              document.addEventListener('mouseup', () => {
                  isDragging = false;
                  solarSystem.classList.remove('dragging');
                  lastInteractionTime = Date.now();
              });

              solarSystem.addEventListener('wheel', (e) => {
                  e.preventDefault();
                  const delta = e.deltaY > 0 ? -0.1 : 0.1;
                  scale = Math.max(0.5, Math.min(3, scale + delta));
                  scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                  lastInteractionTime = Date.now();
                  isReturningToCenter = false;
              });



              function checkInactivity() {
                  const now = Date.now();
                  if (now - lastInteractionTime >= inactivityTimeout && !isReturningToCenter && !isPaused) {
                      isReturningToCenter = true;
                      const startX = offsetX;
                      const startY = offsetY;
                      const duration = 1000;
                      let startTime = null;

                      function animateReturn(timestamp) {
                          if (!startTime) startTime = timestamp;
                          const elapsed = timestamp - startTime;
                          const progress = Math.min(elapsed / duration, 1);
                          offsetX = startX + (0 - startX) * progress;
                          offsetY = startY + (0 - startY) * progress;
                          scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                          if (progress < 1) {
                              requestAnimationFrame(animateReturn);
                          } else {
                              isReturningToCenter = false;
                          }
                      }
                      requestAnimationFrame(animateReturn);
                  }
              }
              setInterval(checkInactivity, 1000);

              function updatePlanets() {
                  const now = Date.now();
                  if (isPaused) {
                      requestAnimationFrame(updatePlanets);
                      return;
                  }

                  planetObjects.forEach(planetObj => {
                      try {
                          if (!planetObj.orientation || !planetObj.element) return;
                          const elapsedSeconds = (now - planetObj.startTime) / 1000;
                          const orbitTimeSeconds = planetObj.orbitTime * planetObj.speedFactor;
                          if (!orbitTimeSeconds || orbitTimeSeconds <= 0) {
              
                              return;
                          }
                          const progress = (elapsedSeconds % orbitTimeSeconds) / orbitTimeSeconds;
                          let angle = planetObj.angle + progress * 360;
                          const angleRad = angle * Math.PI / 180;
                          const radius = planetObj.orbitSize / 2;
                          if (!radius || radius <= 0) {
              
                              return;
                          }

                          let x = Math.cos(angleRad) * radius;
                          let y = Math.sin(angleRad) * radius;
                          const centerThreshold = 100; // Увеличен для предотвращения перекрытия логотипа
                          const distanceFromCenter = Math.sqrt(x * x + y * y);
                          if (distanceFromCenter < centerThreshold) {
                              angle += 10;
                              const newAngleRad = angle * Math.PI / 180;
                              x = Math.cos(newAngleRad) * radius;
                              y = Math.sin(newAngleRad) * radius;
                          }

                          planetObj.orientation.style.left = `${50 + 50 * (x / radius)}%`;
                          planetObj.orientation.style.top = `${50 + 50 * (y / radius)}%`;
                          const tiltCompensation = planetTiltCompensation;
                          planetObj.element.style.transform = `rotateX(${tiltCompensation}deg)`;
                      } catch (error) {
          
                      }
                  });

                  requestAnimationFrame(updatePlanets);
              }

              if (planets.length > 0) {
                  requestAnimationFrame(updatePlanets);
              }
          })();
     });
    </script>

  {% else %}
    <div class="access-restricted">
      <h2>Доступ ограничен</h2>
      <p>Эта страница доступна только для пользователей со статусом "Стартапер". Пожалуйста, войдите в аккаунт или зарегистрируйтесь как стартапер.</p>
      {% if user.is_authenticated %}
        <p>Ваша текущая роль: {{ user.role.role_name|default:"не указана" }}</p>
        <p>Чтобы изменить роль, перейдите в настройки профиля.</p>
        <a href="{% url 'profile' %}" class="access-button">Перейти в профиль</a>
      {% else %}
        <a href="{% url 'login' %}" class="access-button">Войти</a>
        <a href="{% url 'register' %}" class="access-button" style="margin-left: 10px;">Зарегистрироваться</a>
      {% endif %}
    </div>
  {% endif %}
  </main>
{% endblock %}