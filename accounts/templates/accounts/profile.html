{% load static %}
{% load humanize %}

{% block title %}Профиль пользователя{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}?v={% now 'U' %}" />
  {# Дополнительные шрифты, если нужны именно для этой страницы, уже могут быть в base.html или global.css #}
  {# <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400&display=swap" /> #}
  {# <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&display=swap" /> #}
  {# <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Circe:wght@400&display=swap" /> #}
{% endblock %}

{% block content %}
<div class="profile-page-wrapper">
    <img class="profile-main-banner" src="{% static 'accounts/images/profile/profile_spacebg.webp' %}" alt="Баннер профиля" />
    <div class="profile-content-container">
        <div class="profile-sidebar">
            <div class="profile-sidebar-user-info-block">
                <div class="profile-sidebar-avatar-wrapper" id="avatarClickableArea" style="cursor: pointer;" title="Изменить аватар">
                    <img class="profile-sidebar-avatar-img" src="{{ avatar_url }}" alt="Аватар пользователя" />
                </div>
                <div class="profile-sidebar-text-details">
                    <div class="profile-sidebar-name-role">
                        <div class="profile-sidebar-name">
                            <span>{{ user.first_name|default:"Имя" }}</span>
                            <span>{{ user.last_name|default:"Фамилия" }}</span>
                        </div>
                        <div class="profile-sidebar-role">
                            <span>
                                {% if user.role.role_name == "startuper" %}Стартапер
                                {% elif user.role.role_name == "investor" %}Инвестор
                                {% elif user.role.role_name == "moderator" %}Модератор
                                {% elif user.role.role_name == "administrator" %}Администратор
                                {% else %}{{ user.role.role_name|default:"Роль не указана" }}{% endif %}
                            </span>
                        </div>
                        <div class="profile-sidebar-id">
                            <span>ID {{ user.user_id|default:"Не указан" }}</span>
                            <div class="profile-sidebar-copy-icon" title="Копировать ID" onclick="copyToClipboard('{{ user.user_id }}')">
                                <div class="profile-sidebar-copy-icon-inner1"></div>
                                <div class="profile-sidebar-copy-icon-inner2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-sidebar-bio">{{ user.bio|default:"Описание отсутствует."}}</div>
                    <div class="profile-sidebar-email">
                        <strong>Email:</strong> {{ user.email }}
                    </div>
                    {% if user.phone and user.show_phone or is_own_profile %}
                    <div class="profile-sidebar-phone">
                        <strong>Телефон:</strong> {{ user.phone|default:"Не указан" }}
                        {% if is_own_profile and not user.show_phone %}
                            <span>(скрыт для других)</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="profile-sidebar-rating">
                        <strong>Рейтинг:</strong> {{ user.rating|floatformat:1|default:"0.0" }}/5
                    </div>
                    <div class="profile-sidebar-rating-planets">
                        {% with rating=user.rating|floatformat:0|intcomma %}
                            {% for i in "12345" %}
                                <img src="{% if i <= rating %}{% static 'accounts/images/profile/planet_filled.png' %}{% else %}{% static 'accounts/images/profile/planet_empty.png' %}{% endif %}" alt="Planet" class="planet-icon" />
                            {% endfor %}
                        {% endwith %}
                    </div>
                    {% if user.website_url %}
                    <div class="profile-sidebar-website">
                        <img src="{% static 'accounts/images/profile/Globe_Line.svg' %}" alt="Website" class="profile-sidebar-website-icon-img">
                        <a href="{{ user.website_url }}" target="_blank" class="profile-sidebar-website-link">{{ user.website_url }}</a>
                    </div>
                    {% endif %}
                    {% if user.social_links %}
                        {% for platform, username in user.social_links.items %}
                            <div class="profile-sidebar-social-link">
                                <strong>{{ platform|capfirst }}:</strong> @{{ username }}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            <div class="profile-sidebar-social-icons-round">
                <div class="profile-sidebar-social-icon-round-item" onclick="shareProfile()">
                    <img src="{% static 'accounts/images/profile/share_icon.svg' %}" alt="Share" class="profile-sidebar-social-icon-img">
                </div>
                <div class="profile-sidebar-social-icon-round-item">
                     <img src="{% static 'accounts/images/profile/dots.svg' %}" alt="More options" class="profile-sidebar-social-icon-img">
                </div>
            </div>
            
            {% if is_own_profile %}
            <div class="profile-avatar-upload-section" style="display: none;">
                <h4>Загрузить аватарку</h4>
                <form method="post" enctype="multipart/form-data" id="avatarUploadForm" class="avatar-upload-form">
                    {% csrf_token %}
                    <input type="file" name="avatar" accept="image/*" required id="id_avatar_input" class="file-input-hidden">
                    <button type="button" onclick="document.getElementById('id_avatar_input').click();" class="btn btn-secondary choose-file-btn">Выберите файл</button>
                    <div id="fileNameDisplay" class="file-name-display">Файл не выбран</div>
                    <button type="submit" class="btn btn-primary upload-btn">Загрузить</button>
                </form>
            </div>
            {% endif %}

            <a href="{% url 'planetary_system' %}" class="profile-sidebar-my-galaxy-btn">
                <div class="profile-sidebar-my-galaxy-btn-text">Моя Галактика</div>
            </a>
            
            <div class="profile-sidebar-social-icons-row">
                {% if user.social_links.vk %}
                    <a href="https://vk.com/{{ user.social_links.vk }}" target="_blank">
                        <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/vk_icon_social.svg' %}" alt="VK" />
                    </a>
                {% else %}
                    <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/vk_icon_social.svg' %}" alt="VK" />
                {% endif %}
                {% if user.social_links.linkedin %}
                    <a href="https://linkedin.com/in/{{ user.social_links.linkedin }}" target="_blank">
                        <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/linkedin_icon_social.svg' %}" alt="LinkedIn" />
                    </a>
                {% else %}
                    <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/linkedin_icon_social.svg' %}" alt="LinkedIn" />
                {% endif %}
            </div>
            <div class="profile-sidebar-divider"></div>
            <div class="profile-sidebar-date-joined">На площадке с {{ user.created_at|date:"d M Y"|default:"Неизвестно" }}</div>
        </div>

        <div class="profile-main-content">
            {% if is_own_profile %}
            <div class="profile-main-edit-btn-container">
                <a href="#" class="profile-main-edit-btn" id="editProfileBtn">
                    <div class="profile-main-edit-btn-text">Редактировать профиль</div>
                    <img src="{% static 'accounts/images/profile/Edit_Line.svg' %}" alt="Редактировать" class="profile-main-edit-btn-icon"/>
                </a>
            </div>
            {% endif %}
            <div id="profileViewBlock">
                <div class="profile-main-startups-section">
                    <div class="profile-main-tabs">
                        <div class="profile-main-tab-item active-tab" data-tab="startups">Стартапы</div>
                        <div class="profile-main-tab-item" data-tab="news">Новости</div>
                    </div>
                    
                    <div class="profile-main-content-tab active-content" id="startupsContent">
                        {% for startup in startups_data %}
                        <div class="profile-main-startup-card-item">
                            <div class="profile-main-startup-card-content">
                                <div class="profile-main-startup-info">
                                    <div class="profile-main-startup-name">{{ startup.name }}</div>
                                    <div class="profile-main-startup-rating-reviews">
                                        <span class="profile-main-startup-rating">{{ startup.rating }}</span>
                                        <div class="profile-main-startup-reviews">
                                            <img src="{% static 'accounts/images/profile/chat_icon.svg' %}" alt="Reviews" class="profile-main-startup-review-icon-img">
                                            <span>{{ startup.comment_count }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-main-startup-category-progress">
                                    <div class="profile-main-startup-category-tag">{{ startup.category }}</div>
                                    <div class="progress-bar-and-text-container">
                                        <div class="profile-main-startup-progress-bar-bg">
                                            <div class="profile-main-startup-progress-bar-fg" style="width: {{ startup.progress }};"></div>
                                        </div>
                                        <span class="profile-main-startup-progress-text">{{ startup.progress }}</span>
                                    </div>
                                </div>
                                <a href="{{ startup.detail_url }}" class="btn btn-primary profile-main-startup-details-btn">Подробнее</a>
                            </div>
                            <img class="profile-main-startup-image" src="{{ startup.image }}" alt="Изображение стартапа" />
                        </div>
                        <div class="profile-main-startup-list-divider"></div>
                        {% empty %}
                        <div class="profile-main-no-content">
                            У пользователя пока нет стартапов.
                        </div>
                        {% endfor %}
                    </div>

                    <div class="profile-main-content-tab" id="newsContent">
                        <div class="profile-news-items-container">
                            {% for news in news_data %}
                            <div class="profile-news-card-item">
                                <img src="{{ news.image }}" alt="Новость"/>
                                <div class="profile-news-card-title">{{ news.title }}</div>
                                <div class="profile-news-card-description">{{ news.description }}</div>
                            </div>
                            {% empty %}
                            <div class="profile-main-no-content">
                                У пользователя пока нет новостей.
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div id="profileEditBlock" class="profile-edit-animated" style="display:none; opacity:0; pointer-events:none;">
                <div class="profile-edit-wrapper">
                    <div class="profile-edit-header-block">
                        <button class="profile-edit-back-btn" id="profileEditBackBtn" type="button">
                            <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="profile-edit-back-icon">
                              <path d="M12.6668 7.99992H3.3335M3.3335 7.99992L8.00016 12.6666M3.3335 7.99992L8.00016 3.33325" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Назад</span>
                        </button>
                        <div class="profile-edit-title">Изменить профиль</div>
                        <div class="profile-edit-desc">Вы можете добавить URL сайта и добавить ваши соц сети, чтобы другие пользователи смогли больше узнать о вас</div>
                    </div>
                    <form method="post" id="editProfileForm">
                        {% csrf_token %}
                        <input type="hidden" name="edit_profile" value="1">
                        <div class="profile-edit-main-row">
                            <div class="profile-edit-avatar-col">
                                <div class="profile-edit-avatar-wrapper">
                                    <img src="{{ avatar_url }}" alt="Аватар" class="profile-edit-avatar-img"/>
                                </div>
                                <div class="profile-edit-avatar-info">
                                    <div class="profile-edit-avatar-label">Profile photo</div>
                                    <div class="profile-edit-avatar-hint">Рекомендация <br>по размеру изображения 400х400 🙌</div>
                                    <div class="profile-edit-avatar-btn" onclick="document.getElementById('avatarClickableArea').click();">Обновить</div>
                                </div>
                            </div>
                            <div class="profile-edit-fields-col">
                                <div class="profile-edit-section">
                                    <div class="profile-edit-section-title">Информация профиля</div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.first_name.label }}</div>
                                        {{ form.first_name }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.last_name.label }}</div>
                                        {{ form.last_name }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.website_url.label }}</div>
                                        {{ form.website_url }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.phone.label }}</div>
                                        {{ form.phone }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.show_phone.label }}</div>
                                        {{ form.show_phone }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">{{ form.bio.label }}</div>
                                        {{ form.bio }}
                                        <div class="profile-edit-char-counter" id="bioCharCounter">0/150</div>
                                    </div>
                                </div>
                                <div class="profile-edit-section" style="margin-top:40px;">
                                    <div class="profile-edit-section-title">Социальные сети</div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label profile-edit-field-label-sm">Telegram</div>
                                        <div class="profile-edit-input-social">
                                            <span class="profile-edit-input-at">@</span>
                                            <span class="profile-edit-input-social-placeholder" id="telegramInput" contenteditable="true" data-placeholder="Telegram username">{{ user.social_links.telegram|default_if_none:"" }}</span>
                                            <div class="profile-edit-social-add-btn" onclick="addSocialLink('telegram')">Добавить</div>
                                        </div>
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label profile-edit-field-label-sm">VK</div>
                                        <div class="profile-edit-input-social">
                                            <span class="profile-edit-input-at">@</span>
                                            <span class="profile-edit-input-social-placeholder" id="vkInput" contenteditable="true" data-placeholder="VK username">{{ user.social_links.vk|default_if_none:"" }}</span>
                                            <div class="profile-edit-social-add-btn" onclick="addSocialLink('vk')">Добавить</div>
                                        </div>
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label profile-edit-field-label-sm">LinkedIn</div>
                                        <div class="profile-edit-input-social">
                                            <span class="profile-edit-input-at">@</span>
                                            <span class="profile-edit-input-social-placeholder" id="linkedinInput" contenteditable="true" data-placeholder="LinkedIn username">{{ user.social_links.linkedin|default_if_none:"" }}</span>
                                            <div class="profile-edit-social-add-btn" onclick="addSocialLink('linkedin')">Добавить</div>
                                        </div>
                                    </div>
                                    <div class="profile-edit-add-social-btn">
                                        <img src="{% static 'accounts/images/profile/add-circle-outline.svg' %}" alt="Добавить" class="profile-edit-add-social-icon"/>
                                        <span>Добавить еще аккаунт</span>
                                    </div>
                                </div>
                                <div class="profile-edit-hint">Чтобы обновить настройки, нажмите "Сохранить изменений".</div>
                                <div class="profile-edit-divider"></div>
                                <div class="profile-edit-actions">
                                    <button type="submit" class="profile-edit-save-btn">Сохранить изменений</button>
                                    <div class="profile-edit-clear-btn">
                                        <img src="{% static 'accounts/images/profile/close_circle.svg' %}" alt="Очистить" class="profile-edit-clear-icon"/>
                                        <span>Очистить</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция копирования ID в буфер обмена
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert('ID скопирован в буфер обмена!');
        }, function(err) {
            console.error('Ошибка при копировании: ', err);
        });
    }

    // Функция поделиться профилем
    function shareProfile() {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: 'Профиль пользователя',
                url: url
            }).then(() => {
                console.log('Профиль успешно поделен');
            }).catch(err => {
                console.error('Ошибка при попытке поделиться: ', err);
            });
        } else {
            navigator.clipboard.writeText(url).then(function() {
                alert('Ссылка на профиль скопирована в буфер обмена!');
            }, function(err) {
                console.error('Ошибка при копировании ссылки: ', err);
            });
        }
    }

    // Удаляем старые функции fadeIn/fadeOut, если они были здесь

    const avatarClickableArea = document.getElementById('avatarClickableArea');
    const avatarInput = document.getElementById('id_avatar_input');
    const avatarUploadForm = document.getElementById('avatarUploadForm');

    if (avatarClickableArea && avatarInput && avatarUploadForm) {
        avatarClickableArea.addEventListener('click', function() {
            avatarInput.click();
        });

        avatarInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                avatarUploadForm.submit();
            } 
        });
    }

    // Новая логика переключения вкладок с CSS-анимацией и transitionend
    const tabs = document.querySelectorAll('.profile-main-tab-item');
    const tabContents = document.querySelectorAll('.profile-main-content-tab');
    // Анимация вкладок
    tabs.forEach(tab => {
        tab.addEventListener('click', function(event) {
            event.preventDefault();
            const currentActiveTab = document.querySelector('.profile-main-tab-item.active-tab');
            const currentActiveContent = document.querySelector('.profile-main-content-tab.active-content');
            const targetTabId = this.getAttribute('data-tab');
            const newActiveContent = document.getElementById(targetTabId + 'Content');
            if (currentActiveTab === this || !newActiveContent) return;
            if (currentActiveTab) currentActiveTab.classList.remove('active-tab');
            if (currentActiveContent) {
                currentActiveContent.classList.remove('active-content');
                currentActiveContent.classList.add('profile-fade-out');
                setTimeout(() => {
                    currentActiveContent.style.display = 'none';
                    currentActiveContent.classList.remove('profile-fade-out');
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');
                    newActiveContent.style.display = 'flex';
                    setTimeout(() => {
                        newActiveContent.classList.add('active-content');
                    }, 10);
                }, 300);
            } else {
                tabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                newActiveContent.style.display = 'flex';
                setTimeout(() => {
                    newActiveContent.classList.add('active-content');
                }, 10);
            }
        });
    });

    // Инициализация активной вкладки при загрузке страницы
    function initializeActiveTab() {
        let initialActiveTab = document.querySelector('.profile-main-tab-item.active-tab');
        if (!initialActiveTab && tabs.length > 0) { // Если нет активной, берем первую
            initialActiveTab = tabs[0];
            initialActiveTab.classList.add('active-tab');
        }

        if (initialActiveTab) {
            const initialTargetTabId = initialActiveTab.getAttribute('data-tab');
            const initialActiveContent = document.getElementById(initialTargetTabId + 'Content');
            if (initialActiveContent) {
                tabContents.forEach(content => {
                    if (content !== initialActiveContent) {
                        content.style.display = 'none'; // Скрываем неактивные сразу
                        content.classList.remove('active-content');
                    }
                });
                initialActiveContent.style.display = 'flex';
                // Добавляем active-content с небольшой задержкой для возможной анимации при загрузке
                requestAnimationFrame(() => {
                     initialActiveContent.classList.add('active-content'); 
                });
            } else if (tabs.length > 0) { // Если у активной вкладки нет контента, активируем первую
                initialActiveTab.classList.remove('active-tab');
                tabs[0].classList.add('active-tab');
                const firstTabId = tabs[0].getAttribute('data-tab');
                const firstContent = document.getElementById(firstTabId + 'Content');
                if (firstContent) {
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active-content');
                    });
                    firstContent.style.display = 'flex';
                    requestAnimationFrame(() => {
                        firstContent.classList.add('active-content');
                    });
                }
            }
        }
    }
    initializeActiveTab(); // Вызываем функцию инициализации

    const editBtn = document.getElementById('editProfileBtn');
    const profileViewBlock = document.getElementById('profileViewBlock');
    const profileEditBlock = document.getElementById('profileEditBlock');
    const backBtn = document.getElementById('profileEditBackBtn');
    const clearBtn = document.querySelector('.profile-edit-clear-btn');
    // Анимация перехода между просмотром и редактированием профиля
    function showEditBlock() {
        profileViewBlock.classList.add('profile-fade-out');
        setTimeout(() => {
            profileViewBlock.style.display = 'none';
            profileEditBlock.style.display = 'block';
            setTimeout(() => {
                profileEditBlock.style.opacity = 1;
                profileEditBlock.style.pointerEvents = 'auto';
                profileEditBlock.classList.add('profile-fade-in');
            }, 10);
        }, 300);
    }
    function hideEditBlock() {
        profileEditBlock.classList.remove('profile-fade-in');
        profileEditBlock.style.opacity = 0;
        profileEditBlock.style.pointerEvents = 'none';
        setTimeout(() => {
            profileEditBlock.style.display = 'none';
            profileViewBlock.style.display = 'block';
            profileViewBlock.classList.remove('profile-fade-out');
        }, 300);
    }
    if (editBtn && profileViewBlock && profileEditBlock) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showEditBlock();
        });
    }
    if (backBtn) {
        backBtn.addEventListener('click', function() {
            hideEditBlock();
        });
    }
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            document.querySelectorAll('.profile-edit-input[contenteditable]').forEach(el => {
                el.innerText = '';
            });
            // Очищаем поля формы
            document.getElementById('editProfileForm').reset();
        });
    }

    // Обновление счётчика символов для поля bio
    const bioField = document.querySelector('#id_bio');
    const bioCharCounter = document.getElementById('bioCharCounter');
    if (bioField && bioCharCounter) {
        function updateCharCounter() {
            const textLength = bioField.value.length;
            const maxLength = 150;
            bioCharCounter.textContent = `${textLength}/${maxLength}`;
            if (textLength > maxLength) {
                bioCharCounter.style.color = 'red';
            } else {
                bioCharCounter.style.color = 'inherit';
            }
        }
        bioField.addEventListener('input', updateCharCounter);
        updateCharCounter(); // Инициализация
    }

    // Функция для добавления соцсетей
    window.addSocialLink = function(platform) {
        const input = document.getElementById(`${platform}Input`);
        const username = input.innerText.trim();
        if (username) {
            // Обновляем скрытое поле social_links
            let socialLinks = JSON.parse('{{ user.social_links|default:"{}"|safe }}') || {};
            socialLinks[platform] = username;
            document.getElementById('id_social_links').value = JSON.stringify(socialLinks);
            alert(`${platform} username добавлен: @${username}`);
        } else {
            alert(`Пожалуйста, введите username для ${platform}`);
        }
    };
});
</script>
{% endblock %}