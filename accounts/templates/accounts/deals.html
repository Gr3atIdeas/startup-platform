{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Сделки - Панель модератора{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'accounts/css/deals.css' %}">
{% endblock %}

{% block content %}
    <div class="deals-page-container">
        <div class="deals-main-wrapper">
            <div class="chat-list-column">
                <h3>Список сделок</h3>
                <!-- Переключатели для фильтрации -->
                <div class="deal-status-filters">
                    <a href="?status=pending" class="filter-btn {% if current_status == 'pending' %}active{% endif %}">Ожидают</a>
                    <a href="?status=approved" class="filter-btn {% if current_status == 'approved' %}active{% endif %}">Приняты</a>
                    <a href="?status=rejected" class="filter-btn {% if current_status == 'rejected' %}active{% endif %}">Отклонены</a>
                </div>
                {% if deals|length == 0 %}
                    <p>Нет сделок с статусом {{ current_status }}.</p>
                {% endif %}
                {% for deal in deals %}
                    <div class="chat-item {% if forloop.first %}active{% endif %}" data-chat-id="{{ deal.conversation_id }}">
                        <img src="{% static 'accounts/images/avatars/default_avatar_ufo.png' %}" alt="{{ deal.name }}" class="chat-item-avatar">
                        <div class="chat-item-info">
                            <h4 class="chat-item-name">{{ deal.name }}</h4>
                            <p class="chat-item-status">{{ deal.participants|join:', ' }}</p>
                        </div>
                        <div class="chat-item-meta">
                            <span class="chat-item-time">{{ deal.created_at }}</span>
                            {% if deal.unread_count > 0 %}
                                <span class="chat-item-badge">{{ deal.unread_count }}</span>
                            {% endif %}
                            <span class="date-chat-preview">{{ deal.date }}</span>
                        </div>
                    </div>
                {% empty %}
                    <p>Сделок не найдено.</p>
                {% endfor %}
            </div>
            <div class="chat-window-column">
                <div class="chat-messages-area">
                    {% if deals and deals|length > 0 %}
                        {% with deal=deals|first %}
                            <div class="chat-actions-top">
                                <button class="btn btn-approve" data-chat-id="{{ deal.conversation_id }}" id="approveDealBtn">Одобрить</button>
                                <button class="btn btn-reject" data-chat-id="{{ deal.conversation_id }}" id="rejectDealBtn">Отклонить</button>
                            </div>
                            <div class="messages-container">
                                <div class="message-date-separator">{{ deal.date }}</div>
                                <div class="message-group">
                                    <div class="message-bubble received">
                                        <div class="message-content">
                                            {{ deal.last_message }}
                                        </div>
                                        <span class="message-time">{{ deal.created_at }}</span>
                                    </div>
                                </div>
                                {% if deal.unread_count > 0 %}
                                    <div class="new-messages-separator">
                                        <span>Новые сообщения</span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endwith %}
                    {% else %}
                        <p>Выберите сделку для просмотра деталей.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const approveBtn = document.getElementById('approveDealBtn');
            const rejectBtn = document.getElementById('rejectDealBtn');

            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    const chatId = this.getAttribute('data-chat-id');
                    fetch(`/deals/approve/${chatId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert(data.error || 'Ошибка при одобрении сделки');
                        }
                    })
                    .catch(error => console.error('Ошибка:', error));
                });
            }

            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    const chatId = this.getAttribute('data-chat-id');
                    fetch(`/deals/reject/${chatId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert(data.error || 'Ошибка при отклонении сделки');
                        }
                    })
                    .catch(error => console.error('Ошибка:', error));
                });
            }
        });
    </script>
{% endblock %}