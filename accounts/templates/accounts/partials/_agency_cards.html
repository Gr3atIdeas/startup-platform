{% load file_tags %}
{% load static %}
{% load humanize %}
{% load accounts_extras %}

{% for franchise in page_obj %}
  <div class="agency-card" data-franchise-id="{{ franchise.franchise_id }}">
    <span class="agency-tag">Агентство</span>
    <div class="agency-image">
      {% if franchise.planet_image %}
        <img src="https://storage.yandexcloud.net/1-st-test-bucket-for-startup-platform-3gb-1/choosable_planets/{{ franchise.planet_image }}" alt="Планета {{ franchise.title }}" class="planet-image">
      {% else %}
        <div class="agency-image-placeholder">
          {{ franchise.title|make_list|first|upper }}
        </div>
      {% endif %}
    </div>

      <div class="agency-card-inner">
        
        <div class="agency-title-container">
          {% if franchise.owner and franchise.owner.get_profile_picture_url %}
            <div class="agency-logo">
              <img src="{{ franchise.owner.get_profile_picture_url }}" alt="Аватар автора {{ franchise.owner.username }}" class="franchise-default-avatar">
            </div>
          {% elif franchise.logo_urls %}
            <div class="agency-logo">
              <img src="{% get_file_url_tag franchise.logo_urls.0 franchise.franchise_id 'logo' %}" alt="Логотип {{ franchise.title }}">
            </div>
          {% else %}
            <div class="agency-logo">
              <img src="{% static 'accounts/images/avatars/default_avatar_ufo.png' %}" alt="Аватар франшизы" class="franchise-default-avatar">
            </div>
          {% endif %}
          <h3 class="agency-title">{{ franchise.customization_data.agency_display_title|default:franchise.title }}</h3>
        </div>
        <div class="agency-rating-comments">
          <span class="rating-text">Рейтинг {{ franchise.get_average_rating|floatformat:1 }}/5 ({{ franchise.total_voters }})</span>
          <span class="comments-count">
            <svg class="comment-icon" viewBox="0 0 16 15" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.222 0H1.778C0.796 0 0 .734 0 1.64v8.197c0 .906.796 1.64 1.778 1.64h9.778l3.556 3.28V11.477h.888c.982 0 1.778-.734 1.778-1.64V1.64C16 .734 15.204 0 14.222 0z" fill="currentColor"/>
            </svg>
            <span>{{ franchise.comments.count|default:0 }}</span>
          </span>
        </div>

        <div class="agency-category-row">
          {% with agency_category=franchise.customization_data.agency_category %}
            {% if agency_category %}
              <span class="category-tag-figma">{{ agency_category }}</span>
            {% else %}
              <span class="category-tag-figma category-tag-placeholder">Категория не указана</span>
            {% endif %}
          {% endwith %}
        </div>

        <div class="successful-count-container">
          <span class="successful-count-text">Успешных проектов: {{ franchise.successful_projects|default:12 }}</span>
        </div>

        <div class="agency-short-description">{{ franchise.short_description|default:"Нет описания"|truncatechars:140 }}</div>

        <a href="{% url 'agency_detail' franchise_id=franchise.franchise_id %}" class="detail-link" aria-label="Подробнее об агентстве {{ franchise.title }}"></a>
    </div>
  </div>
{% endfor %}