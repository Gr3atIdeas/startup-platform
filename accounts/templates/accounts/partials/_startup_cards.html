{% load file_tags %}
{% load static %}
{% load humanize %}
{% load accounts_extras %}

{% for startup in page_obj %}
  <div class="startup-card">
    <span class="startup-franchise-tag">Франшиза</span>
    <div class="startup-image">
      {% if startup.logo_urls %}
        <img src="{% get_file_url_tag startup.logo_urls.0 startup.startup_id 'logo' %}" alt="{{ startup.title }}" class="startup-logo-img">
      {% else %}
        <div class="startup-image-placeholder">
          {{ startup.title|make_list|first|upper }}
        </div>
      {% endif %}
    </div>

    <div class="startup-card-inner">
      <h3 class="startup-title">{{ startup.title }}</h3>
      <p class="startup-short-description">{{ startup.short_description|truncatewords:15|default:"" }}</p>
      
      <div class="startup-rating-comments">
        <span class="rating-text">Рейтинг {{ startup.get_average_rating|floatformat:1 }}/5 ({{ startup.total_voters }})</span>
        <span class="comments-count">
          <i class="far fa-comment"></i>
          {{ startup.comments.count|default:0 }}
        </span>
      </div>

      {% with progress=startup.get_progress_percentage|default:0 %}
      <div class="progress-container">
        <div class="progress-bar-visual" data-progress="{{ progress|floatformat:0 }}">
          {% if progress > 0 %}
            <div class="progress-animation-container">
              <div class="progress-planets"></div>
            </div>
            <span class="progress-percentage">{{ progress|floatformat:0 }}%</span>
          {% else %}
            <span class="progress-percentage">0%</span>
          {% endif %}
        </div>
        <div class="investor-count">
          <i class="fas fa-users"></i>
          <span>({{ startup.get_investors_count }})</span>
        </div>
      </div>
      {% endwith %}

      {% if startup.direction and startup.direction.direction_name %}
        <div class="startup-category-frame">
            <span class="category-tag">{{ startup.direction.direction_name|translate_category }}</span>
        </div>
      {% endif %}

      <div class="investment-type">
        {% if startup.both_mode %}Инвестирование+Выкуп
        {% elif startup.only_invest %}Только инвестирование
        {% elif startup.only_buy %}Только выкуп
        {% else %}Тип не указан
        {% endif %}
      </div>

      <div class="card-funding-goal">
        <span>Цель:</span>
        <span>{{ startup.funding_goal|default:0|floatformat:0|intcomma }} ₽</span>
      </div>

      <div class="card-amount-raised">
        <span>Собрано:</span>
        <span>{{ startup.amount_raised|default:0|floatformat:0|intcomma }} ₽</span>
      </div>

      <a href="{% url 'startup_detail' startup_id=startup.startup_id %}" class="detail-link">Подробнее</a>
      
      <div class="description-popup">
          <h4 class="description-popup-title">Описание</h4>
          <div class="description-popup-content">
              <p>{{ startup.description|linebreaksbr|default:"Нет подробного описания." }}</p>
              <p><strong>Условия:</strong> {{ startup.terms|linebreaksbr|default:"Условия не указаны." }}</p>
          </div>
      </div>
    </div>
  </div>
{% endfor %} 