{% extends 'accounts/base.html' %}
{% load static %}
{% load file_tags %}
{% load humanize %}

{% block title %}Каталог франшиз{% endblock %}

{% block head_extra %}
  {{ block.super }}
  
  <link rel="stylesheet" href="{% static 'accounts/css/franchises_list.css' %}">
{% endblock %}

{% block content %}

  <div class="franchise-catalog-container">
    
    <aside class="franchise-sidebar"> 
      <form method="get" id="franchise-filterForm" class="franchise-filterForm">
        
        <div class="franchise-sort-dropdown">
          <div class="franchise-sort-dropdown-title">Показать сначала</div> 
          <select name="sort_order" id="franchise-sortOrder">
            <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Новые</option>
            <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Старые</option>
          </select>
        </div>

        
        <h2 class="franchise-categories-title">Категории</h2>
        
        
        <ul class="franchise-categories-list">
          {% for category in categories %}
            <li class="franchise-category-item">
              <label class="franchise-category-label">
                
                <input type="checkbox" name="category" value="{{ category.category_name }}" class="franchise-category-checkbox" {% if category.category_name in selected_categories %}checked{% endif %}>
                <span class="franchise-category-name">
                    {{ category.category_name|default:"Не указано" }}
                </span>
              </label>
            </li>
          {% empty %}
            <li>Категории не найдены.</li>
          {% endfor %}
        </ul>

        
        <div class="franchise-investment-filter">
          <div class="franchise-investment-label-container"> 
            <label class="franchise-investment-label">Размер инвестиций</label>
            
            <span id="franchise-investmentValueDisplay" class="franchise-investment-value-display">{{ min_investment|default:0|floatformat:0|intcomma }} - {{ max_investment|default:1000000|floatformat:0|intcomma }} ₽</span>
          </div>
          <div id="franchise-investmentSlider"></div> 
          
          <input type="hidden" name="min_investment" id="franchise-minInvestmentInput" value="{{ min_investment|default:0|floatformat:0 }}">
          <input type="hidden" name="max_investment" id="franchise-maxInvestmentInput" value="{{ max_investment|default:1000000|floatformat:0 }}">
          <div class="franchise-investment-range-label">Диапозон</div> 
        </div>

        
        <div class="franchise-payback-filter">
          <div class="franchise-payback-label-container"> 
            <label class="franchise-payback-label">Срок окупаемости</label>
            
            <span id="franchise-paybackValueDisplay" class="franchise-payback-value-display">{{ min_payback|default:0 }} - {{ max_payback|default:60 }} мес.</span>
          </div>
          <div id="franchise-paybackSlider"></div> 
          
          <input type="hidden" name="min_payback" id="franchise-minPaybackInput" value="{{ min_payback|default:0 }}">
          <input type="hidden" name="max_payback" id="franchise-maxPaybackInput" value="{{ max_payback|default:60 }}">
          <div class="franchise-payback-range-label">Диапозон</div> 
        </div>

        
        <div class="franchise-rating-filter">
          <div class="franchise-rating-label-container"> 
            <label class="franchise-rating-label">Рейтинг</label>
            
            <span id="franchise-ratingValueDisplay" class="franchise-rating-value-display">{{ min_rating|default:0|floatformat:1 }} - {{ max_rating|default:5|floatformat:1 }}</span>
          </div>
          <div id="franchise-ratingSlider"></div> 
          
          <input type="hidden" name="min_rating" id="franchise-minRatingInput" value="{{ min_rating|default:0|floatformat:1 }}">
          <input type="hidden" name="max_rating" id="franchise-maxRatingInput" value="{{ max_rating|default:5|floatformat:1 }}">
          <div class="franchise-rating-range-label">Диапозон</div> 
        </div>

        
        <input type="hidden" name="search" value="{{ search_query|default_if_none:'' }}">

        
        
        <button type="submit" class="franchise-show-button" data-has-icon-end="false" data-has-icon-start="false" data-size="Medium" data-state="Default" data-variant="Primary">Показать</button>
      </form>
    </aside>

    
    <div class="franchise-startups-content">
      
      <div class="franchise-catalog-search-wrapper">
        <form method="get" class="franchise-catalog-search">
          <input type="text" name="search" placeholder="Поиск франшиз..." class="franchise-catalog-search-input" value="{{ search_query|default_if_none:'' }}">
          <button type="submit" class="franchise-catalog-search-btn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </form>
      </div>

      
      <div class="franchise-startups-grid">
        {% if page_obj %}
          {% include 'accounts/partials/_franchise_cards.html' with page_obj=page_obj %}
        {% else %}
          <div class="franchise-no-startups">
            <p>Франшизы не найдены.</p>
          </div>
        {% endif %}
      </div>

      
      {% if page_obj.has_other_pages %}
        <div class="franchise-pagination-controls">
          <div class="franchise-pagination-info">
            Показано {{ page_obj.start_index }}-{{ page_obj.end_index }} из {{ paginator.count }} франшиз
          </div>
          
          {% if page_obj.has_next %}
            <div class="franchise-show-more-container">
              <button class="franchise-show-more-btn" onclick="loadMoreFranchises()">
                Показать еще
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7 17L17 7M17 7H7M17 7V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          {% endif %}
          
          <div class="franchise-pagination-numbers">
            {% if page_obj.has_previous %}
              <a href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">1</a>
              {% if page_obj.number > 3 %}
                <span class="franchise-dots">...</span>
              {% endif %}
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                {% if num == page_obj.number %}
                  <span class="franchise-current-page">{{ num }}</span>
                {% else %}
                  <a href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                {% endif %}
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
              {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                <span class="franchise-dots">...</span>
              {% endif %}
              <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ page_obj.paginator.num_pages }}</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      const franchiseRatingSlider = document.getElementById('franchise-ratingSlider');
      const franchiseInvestmentSlider = document.getElementById('franchise-investmentSlider');
      const franchisePaybackSlider = document.getElementById('franchise-paybackSlider');
      
      if (franchiseRatingSlider) {
        noUiSlider.create(franchiseRatingSlider, {
          start: [{{ min_rating|default:0 }}, {{ max_rating|default:5 }}],
          connect: true,
          range: {
            'min': 0,
            'max': 5
          },
          format: wNumb({
            decimals: 1
          })
        });
        
        franchiseRatingSlider.noUiSlider.on('update', function(values, handle) {
          document.getElementById('franchise-minRatingInput').value = values[0];
          document.getElementById('franchise-maxRatingInput').value = values[1];
          document.getElementById('franchise-ratingValueDisplay').textContent = values[0] + ' - ' + values[1];
        });
      }
      
      if (franchiseInvestmentSlider) {
        noUiSlider.create(franchiseInvestmentSlider, {
          start: [{{ min_investment|default:0 }}, {{ max_investment|default:1000000 }}],
          connect: true,
          range: {
            'min': 0,
            'max': 1000000
          },
          format: wNumb({
            decimals: 0,
            thousand: ' '
          })
        });
        
        franchiseInvestmentSlider.noUiSlider.on('update', function(values, handle) {
          document.getElementById('franchise-minInvestmentInput').value = values[0];
          document.getElementById('franchise-maxInvestmentInput').value = values[1];
          document.getElementById('franchise-investmentValueDisplay').textContent = values[0] + ' - ' + values[1] + ' ₽';
        });
      }
      
      if (franchisePaybackSlider) {
        noUiSlider.create(franchisePaybackSlider, {
          start: [{{ min_payback|default:0 }}, {{ max_payback|default:60 }}],
          connect: true,
          range: {
            'min': 0,
            'max': 60
          },
          format: wNumb({
            decimals: 0
          })
        });
        
        franchisePaybackSlider.noUiSlider.on('update', function(values, handle) {
          document.getElementById('franchise-minPaybackInput').value = values[0];
          document.getElementById('franchise-maxPaybackInput').value = values[1];
          document.getElementById('franchise-paybackValueDisplay').textContent = values[0] + ' - ' + values[1] + ' мес.';
        });
      }
    });
    
    function loadMoreFranchises() {
      const currentUrl = new URL(window.location);
      const currentPage = parseInt(currentUrl.searchParams.get('page') || 1);
      const nextPage = currentPage + 1;
      
      currentUrl.searchParams.set('page', nextPage);
      
      fetch(currentUrl.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.html) {
          const franchiseGrid = document.querySelector('.franchise-startups-grid');
          franchiseGrid.insertAdjacentHTML('beforeend', data.html);
          
          if (!data.has_next) {
            document.querySelector('.franchise-show-more-btn').style.display = 'none';
          }
          
          const franchisePaginationInfo = document.querySelector('.franchise-pagination-info');
          if (franchisePaginationInfo) {
            franchisePaginationInfo.textContent = `Показано 1-${data.count} из ${data.count} франшиз`;
          }
        }
      })
      .catch(error => {
        console.error('Ошибка загрузки франшиз:', error);
      });
    }
  </script>
{% endblock %} 