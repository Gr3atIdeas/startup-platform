{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}
{% load accounts_extras %}
{% load math_filters %}
{% load startup_filters %}

{% block title %}Мои инвестиции{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap">
  <link rel="stylesheet" href="{% static 'accounts/css/investments.css' %}">
  {# Стили из my_startups.html для планетарной системы #}
  <style>
    /* Стили для планетарной системы */
    .planetary-system-container {
      position: relative;
      width: 100%;
      height: 400px; /* Убедимся, что высота задана */
      overflow: hidden;
      background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a1e 100%);
      margin-bottom: 40px;
    }

    .planetary-system {
      width: 100%;
      height: 100%;
      position: relative;
      perspective: 1000px;
      cursor: grab;
    }

    .planetary-system.dragging {
      cursor: grabbing;
    }

    .planetary-system #scene {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transform-style: preserve-3d;
    }

    .planetary-system #galaxy {
      position: absolute;
      top: 0;
      left: 0;
      transform: rotateX(45deg);
      transform-style: preserve-3d;
    }

    .planetary-system #logo {
      width: 60px;
      height: 60px;
      background-size: cover;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotateX(-45deg);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: #333;
      text-align: center;
      line-height: 1.2;
    }

    .planetary-system .orbit {
      position: absolute;
      top: 50%;
      left: 50%;
      width: var(--orbit-size);
      height: var(--orbit-size);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      margin-left: calc(-0.5 * var(--orbit-size));
      margin-top: calc(-0.5 * var(--orbit-size));
      transform-style: preserve-3d;
      z-index: 1;
      transition: all 0.5s ease;
    }

    .planetary-system .planet-orientation {
      position: absolute;
      transform-style: preserve-3d;
    }

    .planetary-system .planet {
      position: absolute;
      width: var(--planet-size);
      height: var(--planet-size);
      margin-left: calc(-0.5 * var(--planet-size));
      margin-top: calc(-0.5 * var(--planet-size));
      border-radius: 50%;
      background-size: cover;
      cursor: pointer;
      transform-style: preserve-3d;
      z-index: 5;
      transition: all 0.3s ease;
    }
    .planetary-system .planet:hover {
      transform: scale(1.1);
    }
    .planetary-system .planet.active {
      transform: scale(1.2);
    }
    .planetary-system #info-card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      max-width: 300px;
      width: 90%;
      color: #333;
      z-index: 20;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .planetary-system #info-card.visible {
      opacity: 1;
      visibility: visible;
    }
  </style>
{% endblock %}

{% block content %}
<div class="portfolio-container">
  <!-- Планетарная система -->
  <div class="planetary-system-container">
    <div class="planetary-system" id="planetary-system">
      <div id="scene">
        <div id="galaxy">
          {% for investment in planetary_investments %}
          <div class="orbit" id="orbit-{{ investment.id }}" style="--orbit-size: {{ investment.orbit_size }}px; animation: orbit {{ investment.orbit_time }}s linear infinite;">
            <div class="planet-orientation" style="--orbit-size: {{ investment.orbit_size }}px;">
              <div class="planet" id="planet-{{ investment.id }}"
                   style="--planet-size: {{ investment.planet_size }}px; background-image: url('{{ investment.image }}');"
                   data-info="{{ investment.name }}"
                   data-startup-id="{{ investment.startup_id }}"
                   data-description="{{ investment.description }}"
                   data-rating="{{ investment.rating }}"
                   data-comment-count="{{ investment.comment_count }}"
                   data-progress="{{ investment.progress }}"
                   data-direction="{{ investment.direction }}"
                   data-investment-type="{{ investment.investment_type }}"
                   data-funding="{{ investment.funding }}"
                   data-funding-goal="{{ investment.funding_goal }}"
                   data-investors="{{ investment.investors }}">
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="info-card" class="info-card"></div>
  </div>

  <!-- Раздел Мои инвестиции -->
  <div class="my-startups-section">
    <div class="startups-header">
      <div class="startups-titles">
        <h2 class="startups-title-main">МОИ</h2>
        <h2 class="startups-title-sub">ИНВЕСТИЦИИ</h2>
      </div>
      <div class="total-investment">
        <span class="investment-label">Всего инвестировано</span>
        <div class="investment-amount">{{ total_investment|default:"0"|intcomma }} ₽</div>
      </div>
    </div>

    <div class="startups-filters">
        <div class="startups-search-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" placeholder="Поиск по названию..." id="startup-search" class="startups-search-input">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn {% if current_sort == 'all' or not current_sort %}active{% endif %}" onclick="applySort('all')">Все</button>
            <div class="filter-dropdown-wrapper">
                <button class="filter-btn filter-btn-dropdown">
                    Категория <i class="fas fa-chevron-down"></i>
                </button>
                <div class="filter-dropdown-content">
                    <a href="#" data-category="all">Все категории</a>
                    {% for direction in all_directions %}
                        <a href="#" data-category="{{ direction.direction_name }}">{{ direction.direction_name }}</a>
                    {% endfor %}
                </div>
            </div>
            <button class="filter-btn {% if current_sort == 'newest' %}active{% endif %}" onclick="applySort('newest')">
                <i class="fas fa-sort-amount-up"></i> Новые
            </button>
            <button class="filter-btn {% if current_sort == 'oldest' %}active{% endif %}" onclick="applySort('oldest')">
                <i class="fas fa-sort-amount-down"></i> Старые
            </button>
        </div>
    </div>


    <div class="startups-grid">
      {% for investment in user_investments %}
        <div class="startup-card" data-category="{{ investment.startup.direction.direction_name|default:''|escapejs }}" data-name="{{ investment.startup.title|default:''|escapejs }}">
          <div class="startup-card-left">
            <a href="{% url 'startup_detail' investment.startup.startup_id %}">
              <img src="{{ investment.startup.planet_image.url | default:'/static/accounts/images/planets/startup_5_logo.png' }}" alt="{{ investment.startup.title|default:'No Name' }} Planet" class="startup-planet-img">
            </a>
            <div class="startup-info-wrapper">
              <div class="startup-name">
                <a href="{% url 'startup_detail' investment.startup.startup_id %}">
                  {{ investment.startup.title|truncatechars:25 }}
                </a>
              </div>
              <div class="startup-meta">
                <div class="startup-rating">
                  {% with rating=investment.startup_average_rating|default:0 %}
                      {% for i in "12345"|make_list %}
                          {% if rating >= i|add:0 %}
                              <i class="fas fa-star"></i>
                          {% elif rating >= i|add:"-0.5" %}
                              <i class="fas fa-star-half-alt"></i>
                          {% else %}
                              <i class="far fa-star"></i>
                          {% endif %}
                      {% endfor %}
                  {% endwith %}
                </div>
                <div class="startup-comments">
                  <i class="fas fa-comment-dots"></i>
                  <span>{{ investment.startup_comment_count|default:0 }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="startup-card-right">
            <div class="startup-detail-row your-investment-row">
                <span class="detail-label">Ваша инвестиция:</span>
                <span class="detail-value your-investment-value">{{ investment.amount|floatformat:0|intcomma }} ₽</span>
            </div>
            <div class="startup-financials">
                <div class="startup-detail-row">
                    <span class="detail-label">Собрано:</span>
                    <span class="detail-value">{{ investment.startup.current_investment|default:'0'|intcomma }} ₽</span>
                </div>
                <div class="startup-detail-row">
                    <span class="detail-label">Цель:</span>
                    <span class="detail-value">{{ investment.startup.goal|default:'0'|intcomma }} ₽</span>
                </div>
            </div>
            <div class="startup-progress">
              <div class="progress-bar-container">
                  <div class="progress-bar" style="width: {% widthratio investment.startup.current_investment investment.startup.goal 100 %}%;"></div>
              </div>
              <span class="progress-percentage">{% widthratio investment.startup.current_investment investment.startup.goal 100 %}%</span>
            </div>
          </div>
          <a href="{% url 'startup_detail' investment.startup.startup_id %}" class="details-button">Подробнее</a>
        </div>
      {% empty %}
        <div class="no-startups-message">
            <p>Вы еще не инвестировали ни в один стартап.</p>
            <a href="{% url 'startups_list' %}" class="btn-primary">Найти стартапы</a>
        </div>
      {% endfor %}
    </div>

    {% if user_investments.has_other_pages %}
      <div class="pagination">
          <span class="step-links">
              {% if user_investments.has_previous %}
                  <a href="?page=1">&laquo; первая</a>
                  <a href="?page={{ user_investments.previous_page_number }}">предыдущая</a>
              {% endif %}

              <span class="current">
                  Страница {{ user_investments.number }} из {{ user_investments.paginator.num_pages }}.
              </span>

              {% if user_investments.has_next %}
                  <a href="?page={{ user_investments.next_page_number }}">следующая</a>
                  <a href="?page={{ user_investments.paginator.num_pages }}">последняя &raquo;</a>
              {% endif %}
          </span>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Скрипт для планетарной системы (из my_startups.html)
  const system = document.getElementById('planetary-system');
  const scene = document.getElementById('scene');
  const galaxy = document.getElementById('galaxy');
  const infoCard = document.getElementById('info-card');

  if (system && scene && galaxy) {
    let isDragging = false;
    let previousX, previousY;
    let rotationX = 45;
    let rotationY = 0;
    let posX = 0;
    let posY = 0;
    let scale = 1.0;

    system.addEventListener('mousedown', function(e) {
      isDragging = true;
      previousX = e.clientX;
      previousY = e.clientY;
      system.classList.add('dragging');
    });

    window.addEventListener('mouseup', function() {
      isDragging = false;
      system.classList.remove('dragging');
    });

    window.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      const dx = e.clientX - previousX;
      const dy = e.clientY - previousY;
      previousX = e.clientX;
      previousY = e.clientY;

      if (e.ctrlKey || e.metaKey) { // Вращение
        rotationY += dx * 0.5;
        rotationX -= dy * 0.5;
        rotationX = Math.max(-90, Math.min(90, rotationX)); // Ограничение вращения
        galaxy.style.transform = `rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
      } else { // Перемещение
        posX += dx;
        posY += dy;
        scene.style.transform = `translate(-50%, -50%) translate(${posX}px, ${posY}px) scale(${scale})`;
      }
    });

    system.addEventListener('wheel', function(e) {
      e.preventDefault();
      scale += e.deltaY * -0.001;
      scale = Math.min(Math.max(.5, scale), 2); // Ограничение масштаба
      scene.style.transform = `translate(-50%, -50%) translate(${posX}px, ${posY}px) scale(${scale})`;
    });

    document.querySelectorAll('.planet').forEach(planet => {
      planet.addEventListener('mouseover', function(e) {
        const startupId = planet.dataset.startupId;
        const name = planet.dataset.info;
        const description = planet.dataset.description;
        const rating = planet.dataset.rating;
        const commentCount = planet.dataset.commentCount;
        const progress = planet.dataset.progress;
        const direction = planet.dataset.direction;
        const investmentType = planet.dataset.investmentType;
        const funding = planet.dataset.funding;
        const fundingGoal = planet.dataset.fundingGoal;
        const investors = planet.dataset.investors;
        
        infoCard.innerHTML = `
          <h4 style="margin: 0 0 10px 0;">${name}</h4>
          <p style="font-size: 12px; margin: 0 0 5px 0;">${description}</p>
          <div style="font-size: 12px;">
            <div><strong>Рейтинг:</strong> ${rating}</div>
            <div><strong>Собрано:</strong> ${funding} из ${fundingGoal}</div>
            <div><strong>Прогресс:</strong> ${progress}</div>
            <div><strong>Инвесторов:</strong> ${investors}</div>
            <div><strong>Направление:</strong> ${direction}</div>
            <div><a href="/startups/${startupId}" style="color: #FFEF2B; text-decoration:none; font-weight:bold;">Подробнее...</a></div>
          </div>
        `;
        infoCard.classList.add('visible');
      });

      planet.addEventListener('mouseout', function() {
        infoCard.classList.remove('visible');
      });

      planet.addEventListener('click', function() {
        window.location.href = `/startups/${planet.dataset.startupId}`;
      });
    });
  }

  // Скрипты для фильтрации и поиска
    const searchInput = document.getElementById('startup-search');
    const startupCards = document.querySelectorAll('.startup-card');
    const filterButtons = document.querySelectorAll('.filter-dropdown-content a');

    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        const activeCategory = document.querySelector('.filter-dropdown-content a.active')?.dataset.category || 'all';

        startupCards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const category = card.dataset.category;

            const nameMatch = name.includes(searchTerm);
            const categoryMatch = (activeCategory === 'all' || category === activeCategory);

            if (nameMatch && categoryMatch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterAndSearch);

    filterButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.filter-dropdown-content a.active')?.classList.remove('active');
            this.classList.add('active');
            const dropdownButton = document.querySelector('.filter-btn-dropdown');
            dropdownButton.firstChild.nodeValue = this.textContent + ' ';
            filterAndSearch();
        });
    });
});

function applySort(sortValue) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortValue);
    window.location.href = url.toString();
}

</script>
{% endblock %}