{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Портфель{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap">
  <link rel="stylesheet" href="{% static 'accounts/css/investments.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
{% endblock %}

{% block content %}
  {% if user.is_authenticated and user.role.role_name == 'investor' %}
    <div class="portfolio-container">
      <!-- Верхняя секция с аналитикой -->
      <div class="analytics-section">
        <div class="analytics-left">
          <!-- Планетарная система -->
          <div class="planetary-system">
            <div id="planetary-canvas"></div>
            <div class="fps-counter">0 FPS</div>
          </div>
          <!-- Категории с радиальными диаграммами -->
          <div class="categories-radial-section">
            <h3 class="categories-radial-title">Категории</h3>
            <div class="categories-radial-grid">
              {% for category in investment_categories %}
              {% with original_name=category.name|default:"" %}
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="{{ category.percentage }}" data-category-name="{{ original_name }}">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">{{ category.percentage }}%</div>
                </div>
                <span class="category-radial-name">
                    {% if original_name == "Medicine" %}Медицина
                    {% elif original_name == "Auto" %}Автомобили
                    {% elif original_name == "Delivery" %}Доставка
                    {% elif original_name == "Cafe" %}Кафе/рестораны
                    {% elif original_name == "Fastfood" %}Фастфуд
                    {% elif original_name == "Health" %}Здоровье
                    {% elif original_name == "Beauty" %}Красота
                    {% elif original_name == "Transport" %}Транспорт
                    {% elif original_name == "Sport" %}Спорт
                    {% elif original_name == "Psychology" %}Психология
                    {% elif original_name == "AI" %}ИИ
                    {% elif original_name == "Finance" %}Финансы
                    {% elif original_name == "Healthcare" %}Здравоохранение
                    {% elif original_name == "Technology" %}Технологии
                    {% elif original_name == "IT" %}ИТ
                    {% elif original_name == "Retail" %}Ритейл
                    {% else %}{{ original_name|default:"Не указано" }}
                    {% endif %}
                </span>
              </div>
              {% endwith %}
              {% empty %}
                <p>Нет данных по категориям.</p>
              {% endfor %}
              <div class="category-radial-item category-all" id="openCategoriesModalBtn">
                <div class="radial-chart-all">
                  <i class="fas fa-ellipsis-h"></i>
                </div>
                <span class="category-radial-name">Все</span>
              </div>
            </div>
          </div>
        </div>
        <div class="analytics-content">
          <div class="analytics-header">
            <h1 class="analytics-title">Аналитика</h1>
            <div class="analytics-controls">
              <select class="month-select">
                <option value="март">Март</option>
                <option value="апрель">Апрель</option>
                <option value="май">Май</option>
              </select>
              <button class="analytics-options-btn">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </div>
          <div class="stats-overview">
            <div class="stat-item">
              <span class="stat-label">Кол-во стартапов</span>
              <div class="stat-value-box dark-box">{{ startups_count|default:"0" }}</div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Общая сумма инвестирования</span>
              <div class="stat-value-box blue-box">{{ total_investment|default:"0"|intcomma }} ₽</div>
            </div>
          </div>
          <div class="stats-details">
            <div class="stat-item detail-item">
              <span class="stat-label">Макс. сумма инвестирования</span>
              <span class="stat-value-simple">{{ max_investment|default:"0"|intcomma }} ₽</span>
            </div>
            <div class="stat-item detail-item">
              <span class="stat-label">Мин. сумма инвестирования</span>
              <span class="stat-value-simple">{{ min_investment|default:"0"|intcomma }} ₽</span>
            </div>
          </div>
          <div class="analytics-chart-container">
            <canvas id="monthlyInvestmentChart"></canvas>
            <span class="chart-title-overlay">Аналитика этого месяца</span>
          </div>
          <button class="download-report-btn">Скачать отчет</button>
        </div>
      </div>
      <!-- Раздел Мои стартапы -->
      <div class="my-startups-section">
        <div class="startups-header">
          <div class="startups-titles">
            <h2 class="startups-title-main">МОИ</h2>
            <h2 class="startups-title-sub">СТАРТАПЫ</h2>
          </div>
          <div class="total-investment">
            <span class="investment-label">инвестировано</span>
            <div class="investment-amount">{{ total_investment|default:"0"|intcomma }}</div>
          </div>
        </div>
        <div class="startups-filters">
          <div class="startups-search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Поиск" id="startup-search" class="startups-search-input">
          </div>
          <div class="filter-buttons">
            <button class="filter-btn {% if current_sort == 'all' %}active{% endif %}" data-filter="all">Все</button>
            <div class="filter-dropdown-wrapper">
              <button class="filter-btn filter-btn-dropdown" data-filter="category">Категория <i class="fas fa-chevron-down"></i></button>
              <div class="filter-dropdown-content">
                {% for direction in all_directions %}
                  <a href="#" data-category="{{ direction.direction_name }}">{{ direction.direction_name|default:"Не указано" }}</a>
                {% empty %}
                  <a href="#">Нет категорий</a>
                {% endfor %}
              </div>
            </div>
            <a href="?sort=newest" class="filter-btn {% if current_sort == 'newest' %}active{% endif %}" data-filter="new"><i class="fas fa-sort-amount-up"></i> Новые</a>
            <a href="?sort=oldest" class="filter-btn {% if current_sort == 'oldest' %}active{% endif %}" data-filter="old"><i class="fas fa-sort-amount-down"></i> Старые</a>
          </div>
        </div>
        <div class="startups-grid">
          {% for investment in user_investments|slice:":4" %}
            <div class="startup-card" data-category="{{ investment.startup.direction.direction_name|default:'' }}" data-name="{{ investment.startup.title|default:'' }}">
              <div class="startup-card-left">
                <img src="{{ investment.startup.planet_image.url | default:'/static/accounts/images/planets/startup_5_logo.png' }}" alt="{{ investment.startup.title|default:'No Name' }} Planet" class="startup-planet-img">
                <div class="startup-name">
                  {% if investment.startup %}
                    {% if investment.startup.title %}
                      {{ investment.startup.title }}
                    {% else %}
                      <span style="color: red; font-size: 10px;">(Имя не задано!)</span>
                    {% endif %}
                  {% else %}
                    <span style="color: red; font-size: 10px;">(Стартап не найден!)</span>
                  {% endif %}
                </div>
                <div class="startup-rating">
                  {% with rating=investment.startup_average_rating|default:0 %}
                    {% for i in "12345"|make_list %}
                      {% if rating >= i|add:0 %}
                        <i class="fas fa-star"></i>
                      {% elif rating >= i|add:-0.5 %}
                        <i class="fas fa-star-half-alt"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                  {% endwith %}
                </div>
                <div class="startup-comments">
                  <i class="fas fa-comment-dots"></i>
                  <span>{{ investment.startup_comment_count|default:0 }}</span>
                </div>
              </div>
              <div class="startup-card-right">
                <div class="startup-status-row">
                  <span class="detail-label">Статус</span>
                  <span class="detail-value status-{{ investment.startup.get_status_display|lower|default:'активен' }}">{{ investment.startup.get_status_display|default:'Активен' }}</span>
                </div>
                <div class="startup-financials">
                  <div class="startup-detail-row">
                    <span class="detail-label">Собранная сумма:</span>
                    <span class="detail-value">{{ investment.startup.current_investment|default:'0'|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Ваши инвестиции:</span>
                    <span class="detail-value">{{ investment.amount|floatformat:0|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Цель финансирования:</span>
                    <span class="detail-value">{{ investment.startup.goal|default:'0'|intcomma }} ₽</span>
                  </div>
                </div>
                <div class="startup-category-row">
                  <span class="detail-label">Категория</span>
                  <span class="startup-category-tag">
                    {% with original_name=investment.startup.direction.direction_name|default:"" %}
                      {% if original_name == "Medicine" %}Медицина
                      {% elif original_name == "Auto" %}Автомобили
                      {% elif original_name == "Delivery" %}Доставка
                      {% elif original_name == "Cafe" %}Кафе/рестораны
                      {% elif original_name == "Fastfood" %}Фастфуд
                      {% elif original_name == "Health" %}Здоровье
                      {% elif original_name == "Beauty" %}Красота
                      {% elif original_name == "Transport" %}Транспорт
                      {% elif original_name == "Sport" %}Спорт
                      {% elif original_name == "Psychology" %}Психология
                      {% elif original_name == "AI" %}ИИ
                      {% elif original_name == "Finance" %}Финансы
                      {% elif original_name == "Healthcare" %}Здравоохранение
                      {% elif original_name == "Technology" %}Технологии
                      {% elif original_name == "IT" %}ИТ
                      {% elif original_name == "Retail" %}Ритейл
                      {% else %}{{ original_name|default:"Категория" }}
                      {% endif %}
                    {% endwith %}
                  </span>
                </div>
              </div>
            </div>
          {% empty %}
            <p>У вас пока нет инвестиций.</p>
          {% endfor %}
          {% for investment in user_investments|slice:"4:" %}
            <div class="startup-card hidden-card" data-category="{{ investment.startup.direction.direction_name|default:'' }}" data-name="{{ investment.startup.title|default:'' }}" style="display: none;">
              <div class="startup-card-left">
                <img src="{{ investment.startup.planet_image.url | default:'/static/accounts/images/planets/startup_5_logo.png' }}" alt="{{ investment.startup.title|default:'No Name' }} Planet" class="startup-planet-img">
                <div class="startup-name">
                  {% if investment.startup %}
                    {% if investment.startup.title %}
                      {{ investment.startup.title }}
                    {% else %}
                      <span style="color: red; font-size: 10px;">(Имя не задано!)</span>
                    {% endif %}
                  {% else %}
                    <span style="color: red; font-size: 10px;">(Стартап не найден!)</span>
                  {% endif %}
                </div>
                <div class="startup-rating">
                  {% with rating=investment.startup_average_rating|default:0 %}
                    {% for i in "12345"|make_list %}
                      {% if rating >= i|add:0 %}
                        <i class="fas fa-star"></i>
                      {% elif rating >= i|add:-0.5 %}
                        <i class="fas fa-star-half-alt"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                  {% endwith %}
                </div>
                <div class="startup-comments">
                  <i class="fas fa-comment-dots"></i>
                  <span>{{ investment.startup_comment_count|default:0 }}</span>
                </div>
              </div>
              <div class="startup-card-right">
                <div class="startup-status-row">
                  <span class="detail-label">Статус</span>
                  <span class="detail-value status-{{ investment.startup.get_status_display|lower|default:'активен' }}">{{ investment.startup.get_status_display|default:'Активен' }}</span>
                </div>
                <div class="startup-financials">
                  <div class="startup-detail-row">
                    <span class="detail-label">Собранная сумма:</span>
                    <span class="detail-value">{{ investment.startup.current_investment|default:'0'|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Ваши инвестиции:</span>
                    <span class="detail-value">{{ investment.amount|floatformat:0|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                    <span class="detail-label">Цель финансирования:</span>
                    <span class="detail-value">{{ investment.startup.goal|default:'0'|intcomma }} ₽</span>
                  </div>
                </div>
                <div class="startup-category-row">
                  <span class="detail-label">Категория</span>
                  <span class="startup-category-tag">
                    {% with original_name=investment.startup.direction.direction_name|default:"" %}
                      {% if original_name == "Medicine" %}Медицина
                      {% elif original_name == "Auto" %}Автомобили
                      {% elif original_name == "Delivery" %}Доставка
                      {% elif original_name == "Cafe" %}Кафе/рестораны
                      {% elif original_name == "Fastfood" %}Фастфуд
                      {% elif original_name == "Health" %}Здоровье
                      {% elif original_name == "Beauty" %}Красота
                      {% elif original_name == "Transport" %}Транспорт
                      {% elif original_name == "Sport" %}Спорт
                      {% elif original_name == "Psychology" %}Психология
                      {% elif original_name == "AI" %}ИИ
                      {% elif original_name == "Finance" %}Финансы
                      {% elif original_name == "Healthcare" %}Здравоохранение
                      {% elif original_name == "Technology" %}Технологии
                      {% elif original_name == "IT" %}ИТ
                      {% elif original_name == "Retail" %}Ритейл
                      {% else %}{{ original_name|default:"Категория" }}
                      {% endif %}
                    {% endwith %}
                  </span>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        {% if user_investments|length > 4 %}
          <div class="startup-buttons-container">
            <button class="show-more-btn" id="load-more">
              Показать еще <i class="fas fa-arrow-right"></i>
            </button>
            <button class="show-more-btn hide-btn" id="hide-startups-btn" style="display: none;">
              Скрыть <i class="fas fa-arrow-up"></i>
            </button>
          </div>
        {% endif %}
      </div>
    </div>
    <!-- Модальное окно для всех категорий -->
    <div id="allCategoriesModal" class="modal-overlay">
      <div class="modal-content category-modal-content">
        <button class="modal-close-btn" id="closeCategoriesModalBtn">×</button>
        <h2 class="modal-title">Все категории инвестиций</h2>
        <div class="modal-categories-grid" id="modalCategoriesGrid"></div>
      </div>
    </div>
    <!-- Модальное окно для деталей стартапа -->
    <div id="planetaryModal" class="modal-overlay">
      <div class="modal-content planetary-modal-content">
        <button class="modal-close-btn" id="closePlanetaryModalBtn">×</button>
        <h2 class="modal-title" id="modalStartupTitle"></h2>
        <div class="planetary-modal-details">
          <p><strong>Статус:</strong> <span id="modalStartupStatus"></span></p>
          <p><strong>Собранная сумма:</strong> <span id="modalStartupRaised"></span></p>
          <p><strong>Ваши инвестиции:</strong> <span id="modalStartupInvestment"></span></p>
          <p><strong>Цель финансирования:</strong> <span id="modalStartupGoal"></span></p>
          <p><strong>Категория:</strong> <span id="modalStartupCategory"></span></p>
          <p><strong>Рейтинг:</strong> <span id="modalStartupRating"></span></p>
          <p><strong>Комментарии:</strong> <span id="modalStartupComments"></span></p>
        </div>
        <a href="#" id="modalStartupLink" class="modal-link">Подробнее</a>
      </div>
    </div>
    <!-- JSON данные -->
    {{ month_labels|json_script:"chart-month-labels" }}
    {{ month_data|json_script:"chart-month-data" }}
    {{ all_directions|json_script:"all-directions-data" }}
    {{ invested_category_data|json_script:"invested-category-data" }}
    {{ planetary_investments|json_script:"planetary-investments" }}
    <script>
      // Глобальные константы и функции
      const categoryColors = {
        "Medicine": "#e74c3c", "Auto": "#3498db", "Delivery": "#f1c40f",
        "Cafe": "#9b59b6", "Fastfood": "#e67e22", "Health": "#1abc9c",
        "Beauty": "#fd79a8", "Transport": "#2ecc71", "Sport": "#a3ff00",
        "Psychology": "#d35400", "AI": "#00bcd4", "Finance": "#2980b9",
        "Healthcare": "#c0392b", "IT": "#8e44ad", "Retail": "#f39c12",
        "default": "#007bff"
      };

      function translateCategoryName(name) {
        const translations = {
          "Medicine": "Медицина", "Auto": "Автомобили", "Delivery": "Доставка",
          "Cafe": "Кафе/рестораны", "Fastfood": "Фастфуд", "Health": "Здоровье",
          "Beauty": "Красота", "Transport": "Транспорт", "Sport": "Спорт",
          "Psychology": "Психология", "AI": "ИИ", "Finance": "Финансы",
          "Healthcare": "Здравоохранение", "Technology": "Технологии", "IT": "ИТ",
          "Retail": "Ритейл"
        };
        return translations[name] || name || "Не указано";
      }

      function updateRadialChartColors() {
        document.querySelectorAll('.radial-chart').forEach(chart => {
          const percentage = parseInt(chart.dataset.percentage || 0, 10);
          const categoryName = chart.dataset.categoryName || '';
          const color = categoryColors[categoryName] || categoryColors["default"];
          const progressElement = chart.querySelector('.radial-chart-progress');
          if (progressElement) {
            progressElement.style.setProperty('--percentage', percentage);
            progressElement.style.setProperty('--progress-color', color);
          }
        });
      }

      function openModal(directionsData, investedDataDict) {
        const modalOverlay = document.getElementById('allCategoriesModal');
        const modalGrid = document.getElementById('modalCategoriesGrid');
        if (!modalOverlay || !modalGrid) return;
        modalGrid.innerHTML = '';
        if (directionsData && directionsData.length > 0) {
          directionsData.forEach(direction => {
            const categoryName = direction.name;
            const percentage = investedDataDict[categoryName] || 0;
            const translatedName = translateCategoryName(categoryName);
            const color = categoryColors[categoryName] || categoryColors["default"];
            const item = document.createElement('div');
            item.classList.add('modal-category-item');
            item.innerHTML = `
              <div class="radial-chart" data-percentage="${percentage}" data-category-name="${categoryName}">
                <div class="radial-chart-progress" style="--percentage: ${percentage}; --progress-color: ${color};"></div>
                <div class="radial-chart-text">${percentage}%</div>
              </div>
              <span class="modal-category-name">${translatedName}</span>
            `;
            modalGrid.appendChild(item);
          });
        } else {
          modalGrid.innerHTML = '<p>Нет доступных категорий.</p>';
        }
        modalOverlay.classList.add('visible');
        document.body.classList.add('modal-open-blur');
      }

      function closeModal() {
        const modalOverlay = document.getElementById('allCategoriesModal');
        if (!modalOverlay) return;
        modalOverlay.classList.remove('visible');
        document.body.classList.remove('modal-open-blur');
      }

      function filterByCategory(event) {
        event.preventDefault();
        const selectedCategory = event.target.dataset.category;
        console.log("[filterByCategory] Clicked category:", selectedCategory);
        const categoryButton = document.querySelector('.filter-btn[data-filter="category"]');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const startupCards = document.querySelectorAll('.startup-card');
        const loadMoreBtn = document.getElementById('load-more');
        const hideBtn = document.getElementById('hide-startups-btn');
        filterButtons.forEach(btn => btn.classList.remove('active'));
        if (categoryButton) {
          categoryButton.classList.add('active');
        }
        startupCards.forEach(card => {
          const isHiddenCard = card.classList.contains('hidden-card');
          if (card.dataset.category === selectedCategory) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        if (hideBtn) hideBtn.style.display = 'none';
      }

      // Планетарная система
      let planetaryData = [];
      try {
        const planetaryElement = document.getElementById('planetary-investments');
        if (planetaryElement) {
          planetaryData = JSON.parse(planetaryElement.textContent);
        }
      } catch (e) {
        console.error("Ошибка парсинга данных планетарной системы:", e);
      }

      function setup() {
        let canvas = createCanvas(400, 400);
        canvas.parent('planetary-canvas');
        frameRate(60);
      }

      function draw() {
        background(0);
        let fpsCounter = document.querySelector('.fps-counter');
        if (fpsCounter) {
          fpsCounter.textContent = `${floor(frameRate())} FPS`;
        }

        // Инвестор в центре
        fill(255, 204, 0);
        ellipse(width / 2, height / 2, 30, 30);

        // Отрисовка планет (стартапов)
        planetaryData.forEach((startup, index) => {
          let radius = 50 + index * 30;
          let angle = frameCount * 0.02 * (1 - index * 0.1);
          let x = width / 2 + cos(angle) * radius;
          let y = height / 2 + sin(angle) * radius;

          let size = map(startup.amount || 0, 0, 1000000, 10, 30);
          let color = categoryColors[startup.startup__direction__direction_name] || categoryColors["default"];
          fill(color);
          ellipse(x, y, size, size);

          if (dist(mouseX, mouseY, x, y) < size / 2) {
            fill(255);
            textAlign(CENTER);
            textSize(12);
            text(startup.startup__title || "Без названия", x, y - size / 2 - 10);
          }
        });
      }

      function mousePressed() {
        planetaryData.forEach((startup, index) => {
          let radius = 50 + index * 30;
          let angle = frameCount * 0.02 * (1 - index * 0.1);
          let x = width / 2 + cos(angle) * radius;
          let y = height / 2 + sin(angle) * radius;
          let size = map(startup.amount || 0, 0, 1000000, 10, 30);

          if (dist(mouseX, mouseY, x, y) < size / 2) {
            let modal = document.getElementById('planetaryModal');
            document.getElementById('modalStartupTitle').textContent = startup.startup__title || "Без названия";
            document.getElementById('modalStartupStatus').textContent = startup.startup__status || "Неизвестно";
            document.getElementById('modalStartupRaised').textContent = (startup.startup__current_investment || 0).toLocaleString('ru-RU') + ' ₽';
            document.getElementById('modalStartupInvestment').textContent = (startup.amount || 0).toLocaleString('ru-RU') + ' ₽';
            document.getElementById('modalStartupGoal').textContent = (startup.startup__goal || 0).toLocaleString('ru-RU') + ' ₽';
            document.getElementById('modalStartupCategory').textContent = translateCategoryName(startup.startup__direction__direction_name || "Без категории");
            document.getElementById('modalStartupRating').textContent = (startup.startup_average_rating || 0).toFixed(1);
            document.getElementById('modalStartupComments').textContent = startup.startup_comment_count || 0;
            document.getElementById('modalStartupLink').href = `/startups/${startup.startup__id || ''}`; // Предполагаемый URL
            modal.classList.add('visible');
            document.body.classList.add('modal-open-blur');
          }
        });
      }

      // Инициализация
      document.addEventListener('DOMContentLoaded', function() {
        let parsedDirections = [];
        let parsedInvestedData = {};
        try {
          const directionsElement = document.getElementById('all-directions-data');
          const investedElement = document.getElementById('invested-category-data');
          if (directionsElement) {
            parsedDirections = JSON.parse(directionsElement.textContent).map(item => ({ pk: item.pk, name: item.direction_name }));
          }
          if (investedElement) {
            parsedInvestedData = JSON.parse(investedElement.textContent);
          }
        } catch (e) {
          console.error("Ошибка парсинга данных для модального окна:", e);
        }

        updateRadialChartColors();

        const categoryDropdownContent = document.querySelector('.filter-dropdown-content');
        if (categoryDropdownContent) {
          categoryDropdownContent.innerHTML = '';
          if (parsedDirections.length > 0) {
            parsedDirections.forEach(direction => {
              const link = document.createElement('a');
              link.href = '#';
              link.dataset.category = direction.name;
              link.textContent = translateCategoryName(direction.name);
              link.addEventListener('click', filterByCategory);
              categoryDropdownContent.appendChild(link);
            });
          } else {
            categoryDropdownContent.innerHTML = '<a href="#">Нет категорий</a>';
          }
        }

        const searchInput = document.getElementById('startup-search');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.startups-grid .startup-card').forEach(card => {
              const name = card.getAttribute('data-name').toLowerCase();
              if (name.includes(searchTerm)) {
                if (card.style.display !== 'none') {
                  card.style.display = 'flex';
                }
              } else {
                if (card.style.display !== 'none') {
                  card.style.display = 'none';
                }
              }
            });
            const loadMoreBtnSearch = document.getElementById('load-more');
            const hideBtnSearch = document.getElementById('hide-startups-btn');
            if (loadMoreBtnSearch) loadMoreBtnSearch.style.display = 'none';
            if (hideBtnSearch) hideBtnSearch.style.display = 'none';
          });
        }

        const filterButtons = document.querySelectorAll('.filter-btn');
        const startupCards = document.querySelectorAll('.startup-card');
        const loadMoreBtn = document.getElementById('load-more');
        const hideBtn = document.getElementById('hide-startups-btn');
        const hiddenCards = document.querySelectorAll('.startup-card.hidden-card');

        filterButtons.forEach(button => {
          button.addEventListener('click', function(event) {
            if (this.classList.contains('filter-btn-dropdown')) {
              return;
            }
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const filter = this.getAttribute('data-filter');
            if (filter === 'all') {
              startupCards.forEach(card => {
                if (!card.classList.contains('hidden-card')) {
                  card.style.display = 'flex';
                } else {
                  card.style.display = 'none';
                }
              });
              if (hiddenCards.length > 0) {
                if (loadMoreBtn) loadMoreBtn.style.display = 'flex';
                if (hideBtn) hideBtn.style.display = 'none';
              } else {
                if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                if (hideBtn) hideBtn.style.display = 'none';
              }
            }
          });
        });

        if (loadMoreBtn && hiddenCards.length > 0) {
          loadMoreBtn.addEventListener('click', function() {
            hiddenCards.forEach(card => {
              if (card.style.display !== 'none' || !card.hasAttribute('style')) {
                card.style.display = 'flex';
              }
            });
            this.style.display = 'none';
            if (hideBtn) hideBtn.style.display = 'flex';
          });
        }

        if (hideBtn) {
          hideBtn.addEventListener('click', function() {
            hiddenCards.forEach(card => {
              card.style.display = 'none';
            });
            this.style.display = 'none';
            if (loadMoreBtn) loadMoreBtn.style.display = 'flex';
          });
        }

        const openModalBtn = document.getElementById('openCategoriesModalBtn');
        const closeModalBtn = document.getElementById('closeCategoriesModalBtn');
        const modalOverlay = document.getElementById('allCategoriesModal');
        if (openModalBtn) {
          openModalBtn.addEventListener('click', function() {
            openModal(parsedDirections, parsedInvestedData);
          });
        }
        if (closeModalBtn) {
          closeModalBtn.addEventListener('click', closeModal);
        }
        if (modalOverlay) {
          modalOverlay.addEventListener('click', function(event) {
            if (event.target === modalOverlay) {
              closeModal();
            }
          });
        }

        const closePlanetaryModalBtn = document.getElementById('closePlanetaryModalBtn');
        const planetaryModal = document.getElementById('planetaryModal');
        if (closePlanetaryModalBtn) {
          closePlanetaryModalBtn.addEventListener('click', function() {
            planetaryModal.classList.remove('visible');
            document.body.classList.remove('modal-open-blur');
          });
        }
        if (planetaryModal) {
          planetaryModal.addEventListener('click', function(event) {
            if (event.target === planetaryModal) {
              planetaryModal.classList.remove('visible');
              document.body.classList.remove('modal-open-blur');
            }
          });
        }

        // Инициализация графика
        (function() {
          const canvasElement = document.getElementById('monthlyInvestmentChart');
          if (!canvasElement) {
            console.error("Элемент canvas #monthlyInvestmentChart не найден.");
            return;
          }
          const ctx = canvasElement.getContext('2d');
          let monthLabels = [];
          let monthData = [];
          try {
            const labelsEl = document.getElementById('chart-month-labels');
            const dataEl = document.getElementById('chart-month-data');
            if (!labelsEl || !dataEl) throw new Error("Элементы данных графика не найдены");
            monthLabels = JSON.parse(labelsEl.textContent);
            monthData = JSON.parse(dataEl.textContent);
            console.log("[Chart Init] Labels:", monthLabels);
            console.log("[Chart Init] Data:", monthData);
          } catch (e) {
            console.error("Ошибка парсинга данных для графика:", e);
            if (canvasElement.parentNode) {
              canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: red;">Ошибка загрузки данных для графика.</p>';
            }
            return;
          }
          const hasData = monthData && monthData.some(value => value > 0);
          if (hasData) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 123, 255, 0.8)');
            gradient.addColorStop(1, 'rgba(0, 123, 255, 0.1)');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: monthLabels,
                datasets: [{
                  label: 'Сумма инвестиций',
                  data: monthData,
                  backgroundColor: gradient,
                  borderColor: 'rgba(0, 123, 255, 1)',
                  borderWidth: 1,
                  borderRadius: 5,
                  barThickness: 'flex',
                  maxBarThickness: 30
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: {
                      callback: function(value) {
                        if (value >= 1000) {
                          return (value / 1000).toLocaleString('ru-RU') + 'k';
                        } else {
                          return value.toLocaleString('ru-RU');
                        }
                      }
                    }
                  },
                  x: { grid: { display: false } }
                },
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.y !== null) {
                          label += context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₽';
                        }
                        return label;
                      }
                    }
                  }
                }
              }
            });
          } else {
            if (canvasElement.parentNode) {
              canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: #6c757d;">Нет данных для графика за текущий год.</p>';
            }
          }
        })();
      });
    </script>
  {% else %}
    <div class="access-restricted">
      <h2>Доступ ограничен</h2>
      <p>Эта страница доступна только для пользователей со статусом "Инвестор". Пожалуйста, войдите в аккаунт или зарегистрируйтесь как инвестор.</p>
      {% if user.is_authenticated %}
        <p>Ваша текущая роль: {{ user.role.role_name|default:"не указана" }}</p>
        <p>Чтобы изменить роль, перейдите в настройки профиля.</p>
        <a href="{% url 'profile' %}" class="access-button">Перейти в профиль</a>
      {% else %}
        <a href="{% url 'login' %}" class="access-button">Войти</a>
        <a href="{% url 'register' %}" class="access-button" style="margin-left: 10px;">Зарегистрироваться</a>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}