{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{# {% static 'accounts/images/avatars/default_avatar_ufo.png' as default_avatar_src %} #}

{% block title %}CosmoChat{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'accounts/css/cosmochat.css' %}">
  <style>
    /* Стили для body, чтобы фон применился */
    body {
        background: linear-gradient(153deg, black 0%, #00346B 25%, #004E9F 48%, #01366D 64%, #020202 100%);
        font-family: 'Unbounded', sans-serif; /* Убедитесь, что шрифт Unbounded подключен */
        color: white;
    }
    /* Фикс для header, если он перекрывается */
    header {
        position: relative;
        z-index: 10; /* Выше, чем основной контент, если есть пересечения */
    }
  </style>
{% endblock %}

{% block content %}
{% static 'accounts/images/avatars/default_avatar_ufo.png' as default_avatar_src %}
<div class="cosmochat-page-wrapper">
    <!-- Верхний блок: Пользователи и Статьи/Новости -->
    <div class="top-section-new">
        <!-- Левая колонка: Поиск пользователей и список пользователей -->
        <div class="users-main-area-new">
            <form method="get" action="." class="user-search-filters-new">
                <div class="search-input-wrapper-new search-form-cosmo">
                    {% render_field search_form.query class+="search-query-input" placeholder="Поиск" %}
                    <img src="{% static 'accounts/images/cosmochat/search.svg' %}" alt="Поиск">
                </div>
                <div class="role-filters-new django-roles-filter">
                    {% for choice in search_form.roles %}
                        {{ choice.tag }} <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                    {% endfor %}
                </div>
            </form>

            <div class="users-list-new">
                {% for user_profile in users %} 
                <div class="user-card-new" data-user-id="{{ user_profile.user_id }}">
                    <img src="{{ user_profile.profile_picture_url|default:default_avatar_src }}" alt="{{ user_profile.first_name }}" class="avatar-img">
                    <div class="user-info-new">
                        <h3>{{ user_profile.first_name }} {{ user_profile.last_name }}</h3>
                        <div class="user-role-rating-new">
                            <div class="rating-stars-new" data-rating="{{ user_profile.rating|default:0|stringformat:".1f" }}">
                                {% for i in "12345" %}
                                <span class="rating-icon-planet-container">
                                    {# Используем partial_filled_planet.svg как основу (пустую) и full_filled_planet.svg для заполнения #}
                                    <img src="{% static 'accounts/images/planets/partial_filled_planet.svg' %}" alt="☆" class="icon-empty">
                                    <img src="{% static 'accounts/images/planets/full_filled_planet.svg' %}" alt="★" class="icon-filled" style="width: 0%;">
                                </span>
                                {% endfor %}
                            </div>
                            <p class="role-text">{{ user_profile.role.role_name|capfirst }}</p>
                        </div>
                    </div>
                    <div class="user-stats-new">
                        {% if user_profile.role.role_name == "investor" %}
                        <p>Инвестирует от: <span>{{ user_profile.investorprofile.investment_range_min|default:"N/A" }}₽</span></p>
                        <p>Инвестировал в: <span>{{ user_profile.investorprofile.completed_projects_count|default:0 }} стартапов</span></p>
                        {% elif user_profile.role.role_name == "startuper" %}
                        <p>Мин. вклад: <span>{{ user_profile.startuperprofile.min_investment_needed|default:"N/A" }}₽</span></p>
                        <p>Открыл: <span>{{ user_profile.startuperprofile.projects_count|default:0 }} стартапов</span></p>
                        {% else %}
                         <p>Нет данных о роли</p>
                        {% endif %}
                    </div>
                    <button type="button" class="chat-btn-on-card" data-user-id="{{ user_profile.user_id }}">Чат</button>
                </div>
                {% empty %}
                <p>Пользователи не найдены.</p>
                {% endfor %}
            </div>

            {% if users.has_other_pages %}
            <div class="pagination-new">
                <div class="page-numbers-new">
                    {% if users.has_previous %}
                        <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">&laquo;</a>
                        <a href="?page={{ users.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">&lsaquo;</a>
                    {% else %}
                        <span class="page-number-item disabled">&laquo;</span>
                        <span class="page-number-item disabled">&lsaquo;</span>
                    {% endif %}

                    {% for num in users.paginator.page_range %}
                        {% if users.number == num %}
                            <span class="page-number-item current">{{ num }}</span>
                        {% elif num > users.number|add:'-2' and num < users.number|add:'2' %} {# Показывать 1 страницу до и 1 после текущей #}
                            <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">{{ num }}</a>
                        {% elif num == users.number|add:'-2' and num != 1 %}
                            <span class="page-number-item dots">...</span>
                        {% elif num == users.number|add:'2' and num != users.paginator.num_pages %}
                            <span class="page-number-item dots">...</span>
                        {% endif %}
                        {% comment %} Всегда показывать первую и последнюю страницу {% endcomment %}
                        {% if forloop.first and users.number > 2 and users.paginator.num_pages > 3 %}
                             <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">1</a>
                             {% if users.number > 3 and users.paginator.num_pages > 4 %} <span class="page-number-item dots">...</span> {% endif %}
                        {% endif %}
                         {% if forloop.last and users.number < users.paginator.num_pages|add:'-1' and users.paginator.num_pages > 3 %}
                             {% if users.number < users.paginator.num_pages|add:'-2' and users.paginator.num_pages > 4 %} <span class="page-number-item dots">...</span> {% endif %}
                             <a href="?page={{ users.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">{{ users.paginator.num_pages }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if users.has_next %}
                        <a href="?page={{ users.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">&rsaquo;</a>
                        <a href="?page={{ users.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-number-item">&raquo;</a>
                    {% else %}
                        <span class="page-number-item disabled">&rsaquo;</span>
                        <span class="page-number-item disabled">&raquo;</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        </div>

        <div class="articles-section-new">
            <h2>Стартапы и статьи</h2>
            
            <div class="article-card-item">
                <img src="https://loremflickr.com/409/214/technology,startup?random=1" alt="Инвестиции будущего" class="article-image">
                <h3>Инвестиции будущего или как быть на волне трендов</h3>
                <p class="description">Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ...</p>
            </div>
            
            <div class="article-card-item">
                <img src="https://loremflickr.com/409/214/business,innovation?random=2" alt="Инвестиции будущего" class="article-image">
                <h3>Инвестиции будущего или как быть на волне трендов</h3>
                <p class="description">Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ...</p>
            </div>

            <div class="article-card-item">
                <img src="https://loremflickr.com/409/214/medical,health?random=3" alt="Ромашка" class="article-image">
                <h3>Ромашка</h3>
                <div class="category-info">
                    Категория: <span class="category-badge-new">Медицина</span>
                </div>
                <p class="description">Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ...</p>
            </div>
        </div>
    </div>

    <div class="main-chat-area-new">
        <div class="chat-list-column-new">
            <div class="chat-list-header-new">
                <div class="search-input-wrapper-new chat-search-input-wrapper">
                    <input type="text" id="chatSearchInput" placeholder="Поиск по чатам">
                    <img src="{% static 'accounts/images/cosmochat/search.svg' %}" alt="Поиск">
                </div>
                <img src="{% static 'accounts/images/cosmochat/edit.svg' %}" alt="Добавить чат" class="add-chat-btn-icon" id="createChatBtn">
            </div>
            <div class="chat-filters-new">
                <button type="button" class="filter-btn-new active" data-filter="all">Все</button>
                <button type="button" class="filter-btn-new" data-filter="chats">Чаты</button>
                <button type="button" class="filter-btn-new" data-filter="groups">Группы</button>
            </div>
            <div class="chat-items-list-new" id="chatListContainer">
                {% for chat in chats %}
                <div class="chat-item-new {% if forloop.first and not current_chat_id %}active{% elif chat.conversation_id == current_chat_id %}active{% endif %}" 
                     data-chat-id="{{ chat.conversation_id }}"
                     data-chat-name="{{ chat.name|escapejs }}"
                     data-chat-type="{{ chat.type|default:'personal' }}" >
                    <img src="{{ chat.image_url|default:default_avatar_src }}" alt="{{ chat.name }}" class="chat-avatar-img">
                    <div class="chat-item-info-new">
                        <h4>{{ chat.name|truncatechars:25 }}</h4>
                        {% with last_message=chat.get_last_message %}
                            {% if last_message %}
                            <p class="last-message-preview">
                                {% if last_message.sender_id == request.user.user_id %}Вы: {% endif %}
                                {{ last_message.message_text|truncatechars:30 }}
                            </p>
                            {% else %}
                            <p class="last-message-preview">Нет сообщений</p>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="chat-item-meta-new">
                        {% with last_message=chat.get_last_message %}
                            {% if last_message %}
                            <span class="timestamp-chat">{{ last_message.created_at|date:"H:i" }}</span>
                                {% if chat.unread_count > 0 %}
                                <span class="unread-badge-chat">{{ chat.unread_count }}</span>
                                {% endif %}
                            <span class="date-chat-preview">{{ last_message.created_at|date:"d/m/Y" }}</span>
                            {% else %}
                            <span class="timestamp-chat"></span>
                            <span class="date-chat-preview"></span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; padding: 20px; color: #797979;">У вас пока нет чатов. Найдите пользователя и начните диалог!</p>
                {% endfor %}
            </div>
        </div>

        <div class="chat-window-column-new" id="chatWindowColumn">
            <div class="chat-active-header" id="chatActiveHeader" style="display: none;">
                <h3 id="chatWindowTitle">Название чата</h3>
                <div class="chat-header-actions">
                    <button id="addParticipantBtn" class="add-participant-btn-new-style">Добавить</button>
                    <button id="leaveChatBtn" class="leave-chat-btn-new-style">Покинуть</button>
                </div>
            </div>

            <div class="chat-messages-area" id="chatMessagesArea">
            </div>
            
            <div class="no-chat-selected-placeholder" id="noChatSelectedPlaceholder">
                <img src="{% static 'accounts/images/cosmochat/dialogicon.png' %}" alt="Выберите чат">
                <h2>Выберите чат</h2>
            </div>

            <div class="chat-input-field-area" id="chatInputFieldArea" style="display: none;">
                <img src="{% static 'accounts/images/cosmochat/attach.svg' %}" alt="Прикрепить" class="attach-file-btn" id="attachFileBtn">
                <form id="messageFormNew" style="width: 100%;">
                    {% csrf_token %}
                    <input type="hidden" id="chatIdInput" name="chat_id" value="">
                    {% render_field message_form.message_text placeholder="Сообщение" rows="1" %}
                    <button type="submit" class="send-message-btn">
                        <img src="{% static 'accounts/images/cosmochat/send.svg' %}" alt="Отправить">
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="profileModal">
      <div class="modal">
        <button class="modal-close" id="closeProfileModalBtn">×</button>
        <img id="profileAvatar" src="" alt="Аватар">
        <h3 id="profileName"></h3>
        <p id="profileRole"></p>
        <p id="profileRating"></p>
        <p id="profileBio"></p>
        <button class="action-btn" id="startChatBtn">Начать чат</button>
        <a id="profileLink" href="#"><button class="action-btn">К профилю</button></a>
      </div>
    </div>

    <div class="modal-overlay" id="addParticipantModal">
      <div class="modal">
        <button class="modal-close" id="closeAddParticipantModalBtn">×</button>
        <h3>Добавить участника</h3>
        <div class="participants-list" id="participantsList">
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="createChatModal">
        <div class="modal">
            <button class="modal-close" id="closeCreateChatModalBtn">×</button>
            <h3>Создать новый чат</h3>
            <p>Выберите пользователя из списка слева, чтобы начать с ним чат, или найдите через поиск.</p>
            <p>Функционал создания групповых чатов будет добавлен позже.</p>
            <button class="action-btn" id="createChatModalCloseBtn">Понятно</button>
        </div>
    </div>

</div>

<script src="{% static 'accounts/js/cosmochat.js' %}"></script>

<script>
// Резервный скрипт, на случай если основной не загрузится
document.addEventListener('DOMContentLoaded', function() {
    // Открытие модального окна профиля
    document.querySelectorAll('.user-card-new').forEach(card => {
        card.addEventListener('click', function() {
            const userId = this.dataset.userId;
            if (userId && typeof openProfileModal === 'function') {
                openProfileModal(userId);
            }
        });
    });

    // Кнопки чата на карточках пользователей
    document.querySelectorAll('.chat-btn-on-card').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const userId = this.dataset.userId;
            if (userId && typeof startChatWithUser === 'function') {
                startChatWithUser(userId);
            }
        });
    });

    // Клик по элементам чата
    document.querySelectorAll('.chat-item-new').forEach(item => {
        item.addEventListener('click', function() {
            const chatId = this.dataset.chatId;
            if (chatId && typeof loadChat === 'function') {
                loadChat(chatId);
            }
        });
    });

    // Обработчики для модальных окон
    const createChatBtn = document.getElementById('createChatBtn');
    if (createChatBtn) {
        createChatBtn.addEventListener('click', function() {
            const modal = document.getElementById('createChatModal');
            if(modal) modal.style.display = 'flex';
        });
    }

    const closeCreateChatModalBtn = document.getElementById('closeCreateChatModalBtn');
    if (closeCreateChatModalBtn) {
        closeCreateChatModalBtn.addEventListener('click', function() {
            const modal = document.getElementById('createChatModal');
            if(modal) modal.style.display = 'none';
        });
    }

    const createChatModalCloseBtn = document.getElementById('createChatModalCloseBtn');
    if (createChatModalCloseBtn) {
        createChatModalCloseBtn.addEventListener('click', function() {
            const modal = document.getElementById('createChatModal');
            if(modal) modal.style.display = 'none';
        });
    }

    // Функция для обновления отображения рейтинга с планетами
    function updateUserRatingDisplay(container) {
        console.log("Обновление рейтинга для", container, "Рейтинг:", container ? container.dataset.rating : "N/A");
        if (!container) return;
        
        const ratingString = container.dataset.rating;
        if (typeof ratingString === 'undefined') return;

        console.log("Рейтинг (строка):", ratingString);
        const iconContainers = container.querySelectorAll('.rating-icon-planet-container');
        console.log("Найдено контейнеров для планет:", iconContainers.length);
        
        const ratingValue = parseFloat(ratingString) || 0;
        console.log("Рейтинг (число):", ratingValue);
        
        const fullStars = Math.floor(ratingValue);
        const partialPercentage = (ratingValue - fullStars) * 100;
        console.log("Целых звезд:", fullStars, "Частичный процент:", partialPercentage);

        iconContainers.forEach((container, index) => {
            const filledIcon = container.querySelector('.icon-filled');
            if (!filledIcon) {
                console.warn("Не найдена заполненная иконка в контейнере", index);
                return; 
            }

            let fillWidth = '0%';
            if (index < fullStars) {
                fillWidth = '100%';
            } else if (index === fullStars && partialPercentage > 0) {
                fillWidth = `${partialPercentage}%`;
            }
            console.log(`Планета ${index+1}: ширина заполнения = ${fillWidth}`);
            filledIcon.style.width = fillWidth;
        });
    }

    // Инициализация отображения рейтинга
    const ratingContainers = document.querySelectorAll('.rating-stars-new');
    console.log("Найдено контейнеров с рейтингом:", ratingContainers.length);
    ratingContainers.forEach(container => {
        updateUserRatingDisplay(container);
    });

    // Отложенный повторный вызов для обновления рейтингов (иногда DOM не успевает загрузиться)
    setTimeout(() => {
        const ratingContainers = document.querySelectorAll('.rating-stars-new');
        console.log("Повторно: найдено контейнеров с рейтингом:", ratingContainers.length);
        ratingContainers.forEach(container => {
            updateUserRatingDisplay(container);
        });
    }, 1000);
});
</script>
{% endblock %}

{% block body_extra_js %}
{{ request.user.user_id|default:0|json_script:"request_user_id_data" }}
{% endblock %}