{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Создание стартапа{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'accounts/css/startup_form.css' %}">

<div class="startup-form-container">
    <div class="form-navigation-header">
        <a href="{% url 'startups_list' %}" class="back-button">&larr; Назад</a>
        <h2 class="form-main-title">Создание стартапа</h2>
    </div>

    <form method="post" enctype="multipart/form-data" id="startupForm" novalidate>
        {% csrf_token %}

        <!-- Верхний блок: Лого и основные поля -->
        <div class="form-section-top">
            <div class="form-top-grid">
                <div class="form-top-left">
                    <div class="form-group logo-upload-group">
                        <label for="{{ form.logo.id_for_label }}" class="logo-upload-label">
                            <div class="logo-placeholder" id="logoPlaceholder">
                                <img src="{% static 'accounts/images/icons/image_placeholder.svg' %}" alt="Upload Logo Icon">
                                <span>Загрузить логотип</span>
                            </div>
                            <img src="" alt="Логотип" class="logo-preview" id="logoPreview" style="display:none;">
                        </label>
                        {{ form.logo|add_class:"form-control-file"|attr:"id:id_logo_input"|attr:"style:display:none;" }}
                        {% if form.logo.errors %}
                            <span class="error-message">{{ form.logo.errors|first }}</span>
                        {% endif %}
                    </div>
                    <div class="form-fields-left">
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">*{{ form.title.label }}</label>
                            <div class="input-wrapper">
                                {{ form.title|add_class:"form-control"|attr:"placeholder:Ромашка" }}
                            </div>
                            {% if form.title.errors %}<span class="error-message">{{ form.title.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.direction.id_for_label }}">*{{ form.direction.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.direction|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.direction.errors %}<span class="error-message">{{ form.direction.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.funding_goal.id_for_label }}">*{{ form.funding_goal.label }}</label>
                            <div class="input-wrapper">
                                {{ form.funding_goal|add_class:"form-control"|attr:"placeholder:Введите сумму ₽" }}
                            </div>
                            {% if form.funding_goal.errors %}<span class="error-message">{{ form.funding_goal.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.stage.id_for_label }}">*{{ form.stage.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.stage|add_class:"form-control" }}
                                 <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.stage.errors %}<span class="error-message">{{ form.stage.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-top-right">
                    <div class="investment-type-card">
                        <div class="form-group checkbox-group micro-investment-group">
                            {{ form.micro_investment_available|add_class:"form-check-input"|attr:"id:id_micro_investment_available" }}
                            <label for="id_micro_investment_available" class="form-check-label">
                                 <img src="{% static 'accounts/images/creat_startup/add-circle-outline.svg' %}" alt="micro-investment icon" class="micro-investment-icon">
                                {{ form.micro_investment_available.label }}
                            </label>
                            {% if form.micro_investment_available.errors %}<span class="error-message">{{ form.micro_investment_available.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group investment-type-group">
                            <label for="{{ form.investment_type.id_for_label }}" class="investment-type-label">Тип инвестирования</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.investment_type|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.investment_type.errors %}<span class="error-message">{{ form.investment_type.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Новый общий контейнер для основного контента формы -->
        <div class="form-main-content-wrapper">

            <!-- Секция Вводная и Описание -->
            <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.short_description.id_for_label }}">*{{ form.short_description.label }}</label>
                    {% if form.short_description.field.required %}
                        <div class="required-field-notice">*Обязательное поле</div>
                    {% endif %}
                    {{ form.short_description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для..." }}
                    <div class="small-text">Краткое описание вашего стартапа, основные моменты.</div>
                    {% if form.short_description.errors %}<span class="error-message">{{ form.short_description.errors|first }}</span>{% endif %}
                </div>
                <div class="form-group full-width">
                    <label for="{{ form.description.id_for_label }}">*{{ form.description.label }}</label>
                     {% if form.description.field.required %}
                        <div class="required-field-notice">*Обязательное поле</div>
                    {% endif %}
                    {{ form.description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ..." }}
                    <div class="small-text">Подробное описание вашего стартапа. Расскажите о проблеме, решении, команде и т.д.</div>
                    {% if form.description.errors %}<span class="error-message">{{ form.description.errors|first }}</span>{% endif %}
                </div>
            </div>

            <!-- Секция Изображения, Видео, Презентация, Оценка, Собранная сумма -->
             <div class="form-content-section">
                <div class="upload-section-grid media-and-finance-grid">
                    <!-- Блок Изображения -->
                    <div class="form-group upload-box">
                        <label for="id_creatives_input">*{{ form.creatives.label }}</label>
                        {{ form.creatives|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_creatives_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_creatives_input').click()">Выбрать файл</div>
                        <div class="small-text">Допустимый формат PNG, JPEG (до 3 файлов)</div>
                        <div id="creativesPreview" class="file-preview-area"></div>
                        {% if form.creatives.errors %}<span class="error-message">{{ form.creatives.errors|first }}</span>{% endif %}
                    </div>
                    <!-- Блок Видео -->
                    <div class="form-group upload-box">
                        <label for="id_video_input">*{{ form.video.label }}</label>
                        {{ form.video|attr:"style:display:none"|attr:"id:id_video_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_video_input').click()">Выбрать файл</div>
                        <div class="small-text">Допустимый формат MOV, MP4 (1 файл)</div>
                        <div id="videoPreview" class="file-preview-area"></div>
                        {% if form.video.errors %}<span class="error-message">{{ form.video.errors|first }}</span>{% endif %}
                    </div>
                    <!-- Блок Презентация, Оценка, Собранная сумма -->
                    <div class="presentation-finance-group">
                        <div class="form-group">
                            <label for="{{ form.pitch_deck_url.id_for_label }}">{{ form.pitch_deck_url.label }}</label>
                            <div class="input-wrapper">
                                {{ form.pitch_deck_url|add_class:"form-control"|attr:"placeholder:URL" }}
                            </div>
                            {% if form.pitch_deck_url.errors %}<span class="error-message">{{ form.pitch_deck_url.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.valuation.id_for_label }}">{{ form.valuation.label }}</label>
                            <div class="input-wrapper valuation-input">
                                {{ form.valuation|add_class:"form-control"|attr:"placeholder:1"|attr:"type:number"|attr:"min:1" }}
                                <div class="valuation-spin-buttons">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="increase value" class="spin-up">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="decrease value" class="spin-down">
                                </div>
                            </div>
                            {% if form.valuation.errors %}<span class="error-message">{{ form.valuation.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.amount_raised.id_for_label }}">{{ form.amount_raised.label }}</label>
                            <div class="input-wrapper">
                                {{ form.amount_raised|add_class:"form-control"|attr:"placeholder:Введите сумму"|attr:"type:number" }}
                            </div>
                            {% if form.amount_raised.errors %}<span class="error-message">{{ form.amount_raised.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция Условия -->
             <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.terms.id_for_label }}">*{{ form.terms.label }}</label>
                     {% if form.terms.field.required %}
                        <div class="required-field-notice">*Обязательное поле</div>
                    {% endif %}
                    {{ form.terms|add_class:"form-control"|attr:"placeholder:Договоры займа сроком на 12 месяцев..." }}
                    <div class="small-text">Условия инвестирования или выкупа, если они уже определены.</div>
                    {% if form.terms.errors %}<span class="error-message">{{ form.terms.errors|first }}</span>{% endif %}
                </div>
            </div>
            
            <!-- Блок таймлайна -->
             <div class="form-content-section timeline-section-wrapper">
                 <h3 class="section-title">*Этапы</h3>
                <div class="timeline-progress-container">
                    <div class="timeline-progress-line"></div>
                    <div class="timeline-progress-filled" id="timelineProgressFilled"></div>
                </div>
                <div class="timeline" id="timeline">
                    {% for i in "12345" %}
                    <div class="timeline-step" data-step="{{ i }}">
                        <div class="step-number-wrapper" id="stepNumber{{ i }}">
                             {% if i == "1" %}<img src="{% static 'accounts/images/creat_startup/Frame 996.svg' %}" alt="Иконка Этап 1" class="step-icon">{% endif %}
                             {% if i == "2" %}<img src="{% static 'accounts/images/creat_startup/Frame 995.svg' %}" alt="Иконка Этап 2" class="step-icon">{% endif %}
                             {% if i == "3" %}<img src="{% static 'accounts/images/creat_startup/Frame 994.svg' %}" alt="Иконка Этап 3" class="step-icon">{% endif %}
                             {% if i == "4" %}<img src="{% static 'accounts/images/creat_startup/Frame 993.svg' %}" alt="Иконка Этап 4" class="step-icon">{% endif %}
                             {% if i == "5" %}<img src="{% static 'accounts/images/creat_startup/Frame 992.svg' %}" alt="Иконка Этап 5" class="step-icon">{% endif %}
                        </div>
                        <div class="step-text">Этап {{ i }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div id="step-descriptions">
                    {% for i in "12345" %}
                    <div class="timeline-description-container" id="step-description-{{ i }}" data-step-content="{{ i }}">
                        <div class="timeline-description-header">
                            <div class="timeline-description-title-wrapper">
                                <div class="timeline-description-title">Этап {{ i }}</div>
                                <button type="button" class="btn-select-current" data-step-target="{{ i }}">Мы здесь</button>
                            </div>
                        </div>
                        <textarea class="timeline-description-textarea" name="step_description_{{ i }}" placeholder="Описание" required></textarea>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="step_number" id="step_number" value="1">
            </div>

            <!-- Секция Документы (Пруфы) -->
             <div class="form-content-section">
                <div class="form-group upload-box full-width">
                    <label for="id_proofs_input">*{{ form.proofs.label }}</label>
                    {% if form.proofs.field.required %}
                        <div class="required-field-notice">*Обязательное поле</div>
                    {% endif %}
                    {{ form.proofs|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_proofs_input" }}
                    <div class="custom-file-upload-button" onclick="document.getElementById('id_proofs_input').click()">Выбрать файл</div>
                    <div class="small-text">Допустимый формат Doc, Excel, PDF (до 3 файлов)</div>
                    <div id="proofsPreview" class="file-preview-area">
                    </div>
                    {% if form.proofs.errors %}<span class="error-message">{{ form.proofs.errors|first }}</span>{% endif %}
                </div>
            </div>

            <!-- Согласия -->
             <div class="form-content-section agreement-section-outer-wrapper">
                <div class="agreement-section">
                    <h3 class="section-title">Согласие</h3>
                    <div class="form-group checkbox-group">
                        {{ form.agree_rules|add_class:"form-check-input"|attr:"id:id_agree_rules" }}
                        <label for="id_agree_rules" class="custom-checkbox-label">
                            <img src="{% static 'accounts/images/creat_startup/checkmark-circle-outline.svg' %}" alt="checkbox icon" class="checkbox-icon default-icon">
                            <img src="{% static 'accounts/images/creat_startup/checkmark-circle-outline.svg' %}" alt="checkbox icon checked" class="checkbox-icon checked-icon">
                            <span class="checkbox-text">{{ form.agree_rules.label }}</span>
                        </label>
                        <div class="tooltip-icon-wrapper">
                            <span class="tooltip-icon">?</span>
                        </div>
                        {% if form.agree_rules.errors %}<span class="error-message">{{ form.agree_rules.errors|first }}</span>{% endif %}
                    </div>
                    <div class="form-group checkbox-group">
                        {{ form.agree_data_processing|add_class:"form-check-input"|attr:"id:id_agree_data_processing" }}
                        <label for="id_agree_data_processing" class="custom-checkbox-label">
                             <img src="{% static 'accounts/images/creat_startup/checkmark-circle-outline.svg' %}" alt="checkbox icon" class="checkbox-icon default-icon">
                            <img src="{% static 'accounts/images/creat_startup/checkmark-circle-outline.svg' %}" alt="checkbox icon checked" class="checkbox-icon checked-icon">
                            <span class="checkbox-text">{{ form.agree_data_processing.label }}</span>
                        </label>
                        <div class="tooltip-icon-wrapper">
                            <span class="tooltip-icon">?</span>
                        </div>
                        {% if form.agree_data_processing.errors %}<span class="error-message">{{ form.agree_data_processing.errors|first }}</span>{% endif %}
                    </div>
                </div>
            </div>

        </div> <!-- Конец form-main-content-wrapper -->

        <!-- Кнопка отправки (вне общего контейнера) -->
        <div class="submit-button-container">
            <button type="submit" class="submit-button">Отправить на модерацию</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Логотип ---
    const logoInput = document.getElementById('id_logo_input');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const logoPreviewImg = document.getElementById('logoPreview');

    if (logoInput && logoPlaceholder && logoPreviewImg) {
        logoPlaceholder.addEventListener('click', () => logoInput.click());
        logoPreviewImg.addEventListener('click', () => logoInput.click());

        logoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                    logoPreviewImg.src = e.target.result;
                    logoPreviewImg.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });
    }

    // --- Логика таймлайна ---
    const timelineSteps = document.querySelectorAll('.timeline-step');
    const descriptionContainers = document.querySelectorAll('.timeline-description-container');
    const currentStepInput = document.getElementById('step_number');
    const setCurrentButtons = document.querySelectorAll('.btn-select-current');

    function selectStep(stepNumber) {
        descriptionContainers.forEach(container => {
            container.classList.toggle('active', container.dataset.stepContent == stepNumber);
        });
        timelineSteps.forEach(step => {
            step.classList.toggle('active-step-display', step.dataset.step == stepNumber);
        });
    }

    function setCurrentStep(stepNumber) {
        currentStepInput.value = stepNumber;
        timelineSteps.forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            const stepCircle = step.querySelector('.step-number');
            if (stepCircle) {
                stepCircle.classList.toggle('active', stepNum <= stepNumber);
            }
        });
        selectStep(stepNumber);
    }

    timelineSteps.forEach(step => {
        step.addEventListener('click', function() {
            const stepNum = this.dataset.step;
            selectStep(stepNum);
        });
    });

    setCurrentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const stepNum = this.dataset.stepTarget;
            setCurrentStep(stepNum);
        });
    });
    
    if (timelineSteps.length > 0) {
        setCurrentStep(1);
    }

    // --- Прокрутка к первой ошибке Django при загрузке страницы ---
    const firstServerSideError = document.querySelector('.error-message:not(.custom-validation-error)');
    if (firstServerSideError) {
        const errorParentGroup = firstServerSideError.closest('.form-group, .upload-box, .agreement-section');
        if (errorParentGroup) {
            errorParentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const inputField = errorParentGroup.querySelector('.form-control, .form-control-file, input[type="checkbox"]');
            if (inputField && inputField.type !== 'checkbox') {
                inputField.classList.add('input-error');
            } else if (inputField && inputField.type === 'checkbox' && errorParentGroup.classList.contains('checkbox-group')) {
                 errorParentGroup.classList.add('input-error');
            }
        } else {
            firstServerSideError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    // --- КОНЕЦ: Прокрутка к первой ошибке Django ---

    // --- ОБНОВЛЕННАЯ Обработка отправки формы --- 
    const startupForm = document.getElementById('startupForm');
    if (startupForm) {
        startupForm.addEventListener('submit', function(e) {
            let firstInvalidElement = null;
            let validationPassed = true;

            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.custom-validation-error').forEach(el => el.remove());
            document.querySelectorAll('.file-upload-area').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.checkbox-group').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.timeline-step .step-number').forEach(el => el.classList.remove('error-step'));

            // 1. Валидация описаний этапов таймлайна
            const timelineTextareas = startupForm.querySelectorAll('textarea.timeline-description-textarea');
            let timelineErrorDisplayed = false;
            let firstTimelineErrorTextarea = null;

            for (let i = 0; i < timelineTextareas.length; i++) {
                const textarea = timelineTextareas[i];
                const stepNumber = textarea.name.split('_').pop();
                const correspondingStepVisual = document.querySelector(`.timeline-step[data-step="${stepNumber}"] .step-number`);

                if (textarea.hasAttribute('required') && !textarea.value.trim()) {
                    validationPassed = false;
                    textarea.classList.add('input-error');
                    if (correspondingStepVisual) {
                        correspondingStepVisual.classList.add('error-step');
                    }
                    if (!firstTimelineErrorTextarea) firstTimelineErrorTextarea = textarea;
                    
                    if (!timelineErrorDisplayed) {
                        const timelineSection = document.getElementById('timeline');
                        if (timelineSection && !timelineSection.parentElement.querySelector('.custom-validation-error.timeline-general-error')) {
                            const errorMsg = document.createElement('p');
                            errorMsg.className = 'error-message custom-validation-error timeline-general-error';
                            errorMsg.textContent = 'Пожалуйста, заполните описания для всех пяти этапов таймлайна.';
                            timelineSection.parentElement.insertBefore(errorMsg, timelineSection.nextElementSibling);
                            timelineErrorDisplayed = true;
                            if (!firstInvalidElement) firstInvalidElement = timelineSection;
                        }
                    }
                }
            }
            
            if (firstTimelineErrorTextarea) {
                const stepNumberToShow = firstTimelineErrorTextarea.name.split('_').pop();
                selectStep(stepNumberToShow);
                if (!firstInvalidElement) firstInvalidElement = firstTimelineErrorTextarea;
            }

            // 2. Валидация поля "Пруфы"
            const proofsInput = document.getElementById('{{ form.proofs.id_for_label }}');
            const proofsLabel = document.querySelector('label[for="{{ form.proofs.id_for_label }}"]');
            const proofsDropArea = document.getElementById('proofsDropArea');
            if (proofsInput && proofsLabel && proofsLabel.textContent.includes('*')) { 
                if (proofsInput.files.length === 0) {
                    validationPassed = false;
                    if(proofsDropArea) proofsDropArea.classList.add('input-error');
                    else proofsInput.classList.add('input-error');
                    
                    if (!firstInvalidElement) firstInvalidElement = proofsDropArea || proofsInput;
                    if (proofsDropArea && !proofsDropArea.parentElement.querySelector('.custom-validation-error.proofs-error')) {
                        const errorMsg = document.createElement('p');
                        errorMsg.className = 'error-message custom-validation-error proofs-error';
                        errorMsg.textContent = 'Пожалуйста, загрузите подтверждающие документы (Пруфы).';
                        proofsDropArea.parentElement.insertBefore(errorMsg, proofsDropArea.nextSibling);
                    }
                }
            }
            
            // 3. Валидация чекбокса "Согласие с правилами"
            const agreeRulesCheckbox = document.getElementById('{{ form.agree_rules.id_for_label }}');
            if (agreeRulesCheckbox && !agreeRulesCheckbox.checked) {
                validationPassed = false;
                const parentDiv = agreeRulesCheckbox.closest('.checkbox-group');
                if(parentDiv) parentDiv.classList.add('input-error');
                else agreeRulesCheckbox.classList.add('input-error');

                if (!firstInvalidElement) firstInvalidElement = parentDiv || agreeRulesCheckbox;
                if (parentDiv && !parentDiv.querySelector('.custom-validation-error.agree-rules-error')) {
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message custom-validation-error agree-rules-error';
                    errorMsg.textContent = 'Необходимо подтвердить согласие с правилами.';
                    parentDiv.appendChild(errorMsg);
                }
            }

            // 4. Валидация чекбокса "Согласие на обработку данных"
            const agreeDataProcessingCheckbox = document.getElementById('{{ form.agree_data_processing.id_for_label }}');
            if (agreeDataProcessingCheckbox && !agreeDataProcessingCheckbox.checked) {
                validationPassed = false;
                const parentDiv = agreeDataProcessingCheckbox.closest('.checkbox-group');
                if(parentDiv) parentDiv.classList.add('input-error');
                else agreeDataProcessingCheckbox.classList.add('input-error');
                
                if (!firstInvalidElement) firstInvalidElement = parentDiv || agreeDataProcessingCheckbox;
                if (parentDiv && !parentDiv.querySelector('.custom-validation-error.agree-data-error')) {
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message custom-validation-error agree-data-error';
                    errorMsg.textContent = 'Необходимо подтвердить согласие на обработку персональных данных.';
                    parentDiv.appendChild(errorMsg);
                }
            }

            const submitButton = this.querySelector('button[type="submit"]');
            if (!validationPassed) {
                e.preventDefault(); 
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Отправить на модерацию';
                }
                if (firstInvalidElement) {
                    if (firstInvalidElement.classList && firstInvalidElement.classList.contains('timeline-description-textarea')){
                        const container = firstInvalidElement.closest('.timeline-description-container');
                        if (container && container.classList.contains('active')){
                             firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else if (document.getElementById('timeline')) {
                            document.getElementById('timeline').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                return false;
            } else {
                if (submitButton) {
                    if (submitButton.disabled) { 
                         e.preventDefault();
                         return;
                    }
                    submitButton.disabled = true;
                    submitButton.textContent = 'Отправка...';
                }
            }
        });
    }

    // --- Drag & Drop для файлов ---
    function setupDragAndDrop(inputId, dropAreaId, previewAreaId, maxFiles = 1, allowedTypes = ['image/jpeg', 'image/png', 'image/gif']) {
        const fileInput = document.getElementById(inputId);
        const dropArea = document.getElementById(dropAreaId);
        const previewArea = document.getElementById(previewAreaId);

        if (!fileInput || !dropArea || !previewArea) return;

        // Клик по области для выбора файлов
        dropArea.addEventListener('click', () => fileInput.click());

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            dropArea.classList.remove('dragover');
            const files = event.dataTransfer.files;
            handleFiles(files, fileInput, previewArea, maxFiles, allowedTypes);
        });

        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            handleFiles(files, fileInput, previewArea, maxFiles, allowedTypes);
        });
    }

    function handleFiles(files, fileInput, previewArea, maxFiles, allowedTypes) {
        // Для инпутов, которые не поддерживают multiple, очищаем старые файлы,
        // если новый файл выбран (HTML5 file input делает это сам для single file input)
        if (!fileInput.multiple) {
             previewArea.innerHTML = ''; // Очищаем превью для single file
        }
        
        let currentFiles = Array.from(fileInput.files);
        let newFilesList = new DataTransfer();

        // Добавляем существующие файлы, если input multiple
        if (fileInput.multiple) {
            currentFiles.forEach(f => newFilesList.items.add(f));
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (fileInput.multiple && newFilesList.items.length >= maxFiles) {
                alert(`Можно загрузить не более ${maxFiles} файлов.`);
                break;
            }
            if (!allowedTypes.includes(file.type) && allowedTypes.length > 0 && !(allowedTypes.includes('application/pdf') && file.name.endsWith('.pdf')) && !(allowedTypes.includes('application/msword') && file.name.endsWith('.doc')) && !(allowedTypes.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document') && file.name.endsWith('.docx')) && !(allowedTypes.includes('application/vnd.ms-excel') && file.name.endsWith('.xls')) && !(allowedTypes.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') && file.name.endsWith('.xlsx'))) {
                 alert(`Файл ${file.name} имеет неподдерживаемый тип. Разрешены: ${allowedTypes.join(', ')}`);
                 continue;
            }

            if (!fileInput.multiple) { // Для single file input, заменяем файл
                newFilesList = new DataTransfer(); // Очищаем, чтобы добавить только один
                previewArea.innerHTML = ''; 
            }
            newFilesList.items.add(file);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                let previewItem;
                if (file.type.startsWith('image/')) {
                    previewItem = `<div class="file-preview-item"><img src="${e.target.result}" alt="${file.name}"><p>${file.name}</p><button type="button" class="remove-file-btn" data-filename="${file.name}">&times;</button></div>`;
                } else if (file.type.startsWith('video/')) {
                     previewItem = `<div class="file-preview-item"><video controls src="${e.target.result}"></video><p>${file.name}</p><button type="button" class="remove-file-btn" data-filename="${file.name}">&times;</button></div>`;
                } else { // Для других типов файлов (PDF, DOC и т.д.)
                    previewItem = `<div class="file-preview-item"><img src="{% static 'accounts/images/icons/file_icon.svg' %}" alt="file icon" class="file-icon"><p>${file.name}</p><button type="button" class="remove-file-btn" data-filename="${file.name}">&times;</button></div>`;
                }
                if (!fileInput.multiple) {
                    previewArea.innerHTML = previewItem; // Заменяем превью для single file
                } else {
                    previewArea.insertAdjacentHTML('beforeend', previewItem);
                }
            };
            reader.readAsDataURL(file);
        }
        fileInput.files = newFilesList.files; // Обновляем файлы в инпуте
    }
    
    // Удаление файла из превью и из fileInput.files
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-file-btn')) {
            const fileNameToRemove = event.target.dataset.filename;
            const previewItem = event.target.closest('.file-preview-item');
            const previewArea = previewItem.parentElement;
            const fileInputId = previewArea.id.replace('Preview', ''); // e.g. 'creatives' from 'creativesPreview'
            const fileInput = document.querySelector(`input[name="${fileInputId}"]`);

            if (fileInput) {
                const dt = new DataTransfer();
                const files = Array.from(fileInput.files);
                files.forEach(file => {
                    if (file.name !== fileNameToRemove) {
                        dt.items.add(file);
                    }
                });
                fileInput.files = dt.files; // Обновляем files в input
            }
            previewItem.remove(); // Удаляем элемент из DOM
        }
    });

    setupDragAndDrop('{{ form.creatives.id_for_label }}', 'creativesDropArea', 'creativesPreview', 3, ['image/jpeg', 'image/png', 'image/gif']);
    setupDragAndDrop('{{ form.video.id_for_label }}', 'videoDropArea', 'videoPreview', 1, ['video/mp4', 'video/quicktime', 'video/x-msvideo']); // 'video/quicktime' for .mov
    setupDragAndDrop('{{ form.proofs.id_for_label }}', 'proofsDropArea', 'proofsPreview', 3, ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet']);

    // --- Logic for custom checkboxes ---
    function setupCustomCheckboxes() {
        document.querySelectorAll('.custom-checkbox-label').forEach(label => {
            const inputId = label.getAttribute('for');
            const input = document.getElementById(inputId);
            const defaultIcon = label.querySelector('.default-icon');
            const checkedIcon = label.querySelector('.checked-icon');

            if (input && defaultIcon && checkedIcon) {
                const updateIcons = () => {
                    if (input.checked) {
                        // В Figma обе иконки одинаковые, но одна синяя с белой галочкой.
                        // Пока используем одну и ту же SVG и меняем цвет через CSS или filter.
                        // Или можно загрузить вторую SVG, если она есть.
                        defaultIcon.style.display = 'none';
                        checkedIcon.style.display = 'inline-block';
                        // Пример смены цвета через filter (нужно будет настроить):
                         checkedIcon.style.filter = 'invert(30%) sepia(80%) saturate(2500%) hue-rotate(190deg) brightness(90%) contrast(100%)';
                    } else {
                        defaultIcon.style.display = 'inline-block';
                        checkedIcon.style.display = 'none';
                        checkedIcon.style.filter = 'none'; // Сбросить фильтр
                    }
                };

                // Initial state
                updateIcons();

                // Update on change
                input.addEventListener('change', updateIcons);

                 // Update when label is clicked (which toggles the input)
                label.addEventListener('click', () => {
                    // Timeout to allow the input state to update before reading it
                    setTimeout(updateIcons, 0);
                });
            }
        });
    }

    // Call the setup function after DOM content is loaded
    setupCustomCheckboxes();

});
</script>
{% endblock %}