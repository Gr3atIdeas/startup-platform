{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Создание стартапа{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'accounts/css/startup_form.css' %}">

<div class="startup-form-container">
    <div class="form-navigation-header">
        <a href="{% url 'startups_list' %}" class="back-button">&larr; Назад</a>
        <h2 class="form-main-title">Создание стартапа</h2>
    </div>

    <form method="post" enctype="multipart/form-data" id="startupForm" novalidate>
        {% csrf_token %}

        <!-- Верхний блок: Лого и основные поля -->
        <div class="form-section-top">
            <div class="form-top-grid">
                <div class="form-top-left">
                    <div class="form-group logo-upload-group">
                        <label for="{{ form.logo.id_for_label }}" class="logo-upload-label">
                            <div class="logo-placeholder" id="logoPlaceholder">
                                <img src="{% static 'accounts/images/icons/image_placeholder.svg' %}" alt="Upload Logo Icon">
                                <span>Загрузить логотип</span>
                            </div>
                            <img src="" alt="Логотип" class="logo-preview" id="logoPreview" style="display:none;">
                        </label>
                        {{ form.logo|add_class:"form-control-file"|attr:"id:id_logo_input"|attr:"style:display:none;" }}
                        {% if form.logo.errors %}
                            <span class="error-message">{{ form.logo.errors|first }}</span>
                        {% endif %}
                    </div>
                    <div class="form-fields-left">
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">*{{ form.title.label }}</label>
                            <div class="input-wrapper">
                                {{ form.title|add_class:"form-control"|attr:"placeholder:Ромашка" }}
                            </div>
                            {% if form.title.errors %}<span class="error-message">{{ form.title.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.direction.id_for_label }}">*{{ form.direction.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.direction|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.direction.errors %}<span class="error-message">{{ form.direction.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.funding_goal.id_for_label }}">*{{ form.funding_goal.label }}</label>
                            <div class="input-wrapper">
                                {{ form.funding_goal|add_class:"form-control"|attr:"placeholder:Введите сумму ₽" }}
                            </div>
                            {% if form.funding_goal.errors %}<span class="error-message">{{ form.funding_goal.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.stage.id_for_label }}">*{{ form.stage.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.stage|add_class:"form-control" }}
                                 <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.stage.errors %}<span class="error-message">{{ form.stage.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-top-right">
                    <div class="investment-type-card">
                        <div class="form-group checkbox-group micro-investment-group">
                            {{ form.micro_investment_available|attr:"id:id_micro_investment_available"|add_class:"form-check-input-hidden" }}
                            <label for="id_micro_investment_available" class="micro-investment-label-new">
                                <span class="micro-checkbox-visual">
                                    <span class="micro-checkbox-unchecked"></span>
                                    <img src="{% static 'accounts/images/creat_startup/checkmark-circle-blue.svg' %}" alt="checked" class="micro-checkbox-checked" style="display:none;">
                                </span>
                                <span class="checkbox-text-span">Микроинвестиции доступны</span>
                            </label>
                            {% if form.micro_investment_available.errors %}<span class="error-message">{{ form.micro_investment_available.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group investment-type-group">
                            <label for="{{ form.investment_type.id_for_label }}" class="investment-type-label">Тип инвестирования</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.investment_type|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow">
                            </div>
                            {% if form.investment_type.errors %}<span class="error-message">{{ form.investment_type.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Новый общий контейнер для основного контента формы -->
        <div class="form-main-content-wrapper">

            <!-- Секция Вводная и Описание -->
            <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.short_description.id_for_label }}">*{{ form.short_description.label }}</label>
                    {{ form.short_description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для..." }}
                    <div class="small-text">Краткое описание вашего стартапа, основные моменты.</div>
                    {% if form.short_description.errors %}<span class="error-message">{{ form.short_description.errors|first }}</span>{% endif %}
                </div>
                <div class="form-group full-width">
                    <label for="{{ form.description.id_for_label }}">*{{ form.description.label }}</label>
                    {{ form.description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ..." }}
                    <div class="small-text">Подробное описание вашего стартапа. Расскажите о проблеме, решении, команде и т.д.</div>
                    {% if form.description.errors %}<span class="error-message">{{ form.description.errors|first }}</span>{% endif %}
                </div>
            </div>

            <!-- Секция Изображения, Видео, Презентация, Оценка, Собранная сумма -->
             <div class="form-content-section">
                <div class="upload-section-grid media-and-finance-grid">
                    <!-- Блок Изображения -->
                    <div class="form-group upload-box" id="creativesDropArea">
                        <label for="id_creatives_input">*Изображения</label>
                        {{ form.creatives|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_creatives_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_creatives_input').click()">Выбрать файл</div>
                        <div class="small-text">Допустимый формат PNG, JPEG (до 3 файлов)</div>
                        <div id="creativesPreview" class="file-preview-area"></div>
                        {% if form.creatives.errors %}<span class="error-message">{{ form.creatives.errors|first }}</span>{% endif %}
                    </div>
                    <!-- Блок Видео -->
                    <div class="form-group upload-box" id="videoDropArea">
                        <label for="id_video_input">*Видео</label>
                        {{ form.video|attr:"style:display:none"|attr:"id:id_video_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_video_input').click()">Выбрать файл</div>
                        <div class="small-text">Допустимый формат MOV, MP4 (1 файл)</div>
                        <div id="videoPreview" class="file-preview-area"></div>
                        {% if form.video.errors %}<span class="error-message">{{ form.video.errors|first }}</span>{% endif %}
                    </div>
                    <!-- Блок Презентация, Оценка, Собранная сумма -->
                    <div class="presentation-finance-group">
                        <div class="form-group">
                            <label for="{{ form.pitch_deck_url.id_for_label }}">{{ form.pitch_deck_url.label }}</label>
                            <div class="input-wrapper">
                                {{ form.pitch_deck_url|add_class:"form-control"|attr:"placeholder:URL" }}
                            </div>
                            {% if form.pitch_deck_url.errors %}<span class="error-message">{{ form.pitch_deck_url.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.valuation.id_for_label }}">{{ form.valuation.label }}</label>
                            <div class="input-wrapper valuation-input">
                                {{ form.valuation|add_class:"form-control"|attr:"placeholder:1"|attr:"type:number"|attr:"min:1" }}
                                <div class="valuation-spin-buttons">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="increase value" class="spin-up">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="decrease value" class="spin-down">
                                </div>
                            </div>
                            {% if form.valuation.errors %}<span class="error-message">{{ form.valuation.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.amount_raised.id_for_label }}">{{ form.amount_raised.label }}</label>
                            <div class="input-wrapper">
                                {{ form.amount_raised|add_class:"form-control"|attr:"placeholder:Введите сумму"|attr:"type:number" }}
                            </div>
                            {% if form.amount_raised.errors %}<span class="error-message">{{ form.amount_raised.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция Условия -->
             <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.terms.id_for_label }}">*{{ form.terms.label }}</label>
                    {{ form.terms|add_class:"form-control"|attr:"placeholder:Договоры займа сроком на 12 месяцев..." }}
                    <div class="small-text">Условия инвестирования или выкупа, если они уже определены.</div>
                    {% if form.terms.errors %}<span class="error-message">{{ form.terms.errors|first }}</span>{% endif %}
                </div>
            </div>
            
            <!-- Блок таймлайна -->
             <div class="form-content-section timeline-section-wrapper">
                 <h3 class="section-title">*Этапы</h3>
                <div class="timeline" id="timeline">
                    <div class="timeline-progress-container">
                        <div class="timeline-progress-line"></div>
                        <div class="timeline-progress-filled" id="timelineProgressFilled"></div>
                    </div>
                    {% for i in "12345" %}
                    <div class="timeline-step" data-step="{{ i }}">
                        <div class="step-number-wrapper" id="stepNumber{{ i }}">
                             {% if i == "1" %}<img src="{% static 'accounts/images/creat_startup/Frame 996.svg' %}" alt="Иконка Этап 1" class="step-icon">{% endif %}
                             {% if i == "2" %}<img src="{% static 'accounts/images/creat_startup/Frame 995.svg' %}" alt="Иконка Этап 2" class="step-icon">{% endif %}
                             {% if i == "3" %}<img src="{% static 'accounts/images/creat_startup/Frame 994.svg' %}" alt="Иконка Этап 3" class="step-icon">{% endif %}
                             {% if i == "4" %}<img src="{% static 'accounts/images/creat_startup/Frame 993.svg' %}" alt="Иконка Этап 4" class="step-icon">{% endif %}
                             {% if i == "5" %}<img src="{% static 'accounts/images/creat_startup/Frame 992.svg' %}" alt="Иконка Этап 5" class="step-icon">{% endif %}
                        </div>
                        <div class="step-text">Этап {{ i }}</div>
                        <button type="button" class="btn-select-current-step" data-step-target="{{ i }}">Мы здесь</button>
                    </div>
                    {% endfor %}
                </div>
                <div id="step-descriptions">
                    {% for i in "12345" %}
                    <div class="timeline-description-container" id="step-description-{{ i }}" data-step-content="{{ i }}">
                        <div class="timeline-description-header">
                            <div class="timeline-description-title-wrapper">
                                <div class="timeline-description-title">Этап {{ i }}</div>
                            </div>
                        </div>
                        <textarea class="timeline-description-textarea" name="step_description_{{ i }}" placeholder="Описание" required></textarea>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="step_number" id="step_number" value="1">
            </div>

            <!-- Секция Документы (Пруфы) -->
             <div class="form-content-section">
                <div class="form-group upload-box full-width" id="proofsDropArea">
                    <label for="id_proofs_input">*Документы</label>
                    {{ form.proofs|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_proofs_input" }}
                    <div class="custom-file-upload-button" onclick="document.getElementById('id_proofs_input').click()">Выбрать файл</div>
                    <div class="small-text">Допустимый формат Doc, Excel, PDF (до 3 файлов)</div>
                    <div id="proofsPreview" class="file-preview-area">
                    </div>
                    {% if form.proofs.errors %}<span class="error-message">{{ form.proofs.errors|first }}</span>{% endif %}
                </div>
            </div>

            <!-- Согласия -->
             <div class="form-content-section agreement-section-outer-wrapper">
                <div class="agreement-section">
                    <h3 class="section-title">Согласие</h3>
                    <div class="form-group checkbox-group">
                        {{ form.agree_rules|attr:"id:id_agree_rules"|add_class:"form-check-input-hidden" }}
                        <label for="id_agree_rules" class="custom-checkbox-label">
                            <span class="custom-checkbox-visual">
                                <span class="custom-checkbox-unchecked"></span>
                                <span class="custom-checkbox-checked"></span>
                            </span>
                            <span class="checkbox-text">{{ form.agree_rules.label }}</span>
                        </label>
                        {% if form.agree_rules.errors %}<span class="error-message">{{ form.agree_rules.errors|first }}</span>{% endif %}
                    </div>
                    <div class="form-group checkbox-group">
                        {{ form.agree_data_processing|attr:"id:id_agree_data_processing"|add_class:"form-check-input-hidden" }}
                        <label for="id_agree_data_processing" class="custom-checkbox-label">
                            <span class="custom-checkbox-visual">
                                <span class="custom-checkbox-unchecked"></span>
                                <span class="custom-checkbox-checked"></span>
                            </span>
                            <span class="checkbox-text">{{ form.agree_data_processing.label }}</span>
                        </label>
                        {% if form.agree_data_processing.errors %}<span class="error-message">{{ form.agree_data_processing.errors|first }}</span>{% endif %}
                    </div>
                </div>
            </div>

        </div> <!-- Конец form-main-content-wrapper -->

        <!-- Кнопка отправки (вне общего контейнера) -->
        <div class="submit-button-container">
            <button type="submit" class="submit-button">Отправить на модерацию</button>
        </div>
    </form>
</div>

<script>
const creatStartupStaticUrl = "{% static 'accounts/images/creat_startup/' %}";

document.addEventListener('DOMContentLoaded', function() {
    // --- Логотип ---
    const logoInput = document.getElementById('id_logo_input');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const logoPreviewImg = document.getElementById('logoPreview');

    if (logoInput && logoPlaceholder && logoPreviewImg) {
        logoPlaceholder.addEventListener('click', () => logoInput.click());
        logoPreviewImg.addEventListener('click', () => logoInput.click());

        logoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                    logoPreviewImg.src = e.target.result;
                    logoPreviewImg.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });
    }

    // --- Логика таймлайна (Обновлено) ---
    const timelineSteps = document.querySelectorAll('.timeline-step');
    const descriptionContainers = document.querySelectorAll('.timeline-description-container');
    const currentStepInput = document.getElementById('step_number');
    const setCurrentButtons = document.querySelectorAll('.btn-select-current-step');
    const timelineProgressFilled = document.getElementById('timelineProgressFilled'); // Полоса прогресса
    const totalSteps = 5; // Общее количество шагов

    function selectStepDescription(stepNumber) {
        descriptionContainers.forEach(container => {
            container.classList.toggle('active', container.dataset.stepContent == stepNumber);
        });
        timelineSteps.forEach(step => {
            step.classList.toggle('active-step-display', step.dataset.step == stepNumber);
        });
    }

    function setCurrentStep(stepNumber) {
        const currentStep = parseInt(stepNumber);
        currentStepInput.value = currentStep;

        timelineSteps.forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            const stepWrapper = step.querySelector('.step-number-wrapper');
            
            step.classList.remove('active-step-display'); // Сначала убираем у всех свечение
            stepWrapper.classList.remove('active'); // Убираем активную раскраску у всех
            // stepWrapper.classList.remove('future-step'); // future-step больше не используется для стилизации напрямую

            if (stepNum <= currentStep) {
                stepWrapper.classList.add('active'); // Пройденные и текущий этап - активные (цветные)
            } else {
                // Будущие этапы - неактивные (по умолчанию будут черно-белыми по CSS)
            }
            
            // Показываем описание и свечение только для выбранного текущего этапа
            if (stepNum === currentStep) {
                selectStepDescription(currentStep); // Показываем описание (эта функция также добавляет active-step-display)
            }
        });

        // Обновление полосы прогресса
        let progressPercentage = 0;
        if (currentStep > 1) {
            // Прогресс рассчитывается как (текущий_шаг - 1) / (всего_шагов - 1)
            // Чтобы на 1 шаге было 0%, на последнем 100%
            progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        }
        if(timelineProgressFilled) {
             timelineProgressFilled.style.width = `${progressPercentage}%`;
        }
    }

    timelineSteps.forEach(step => {
        step.addEventListener('click', function() {
            const stepNum = this.dataset.step;
            selectStepDescription(stepNum); // Только показываем описание при клике на круг
        });
    });

    setCurrentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const stepNum = this.dataset.stepTarget;
            setCurrentStep(stepNum); // Устанавливаем как текущий этап
        });
    });
    
    // Инициализация таймлайна при загрузке (устанавливаем шаг 1)
    if (timelineSteps.length > 0) {
        setCurrentStep(1);
    }

    // --- Прокрутка к первой ошибке Django при загрузке страницы ---
    const firstServerSideError = document.querySelector('.error-message:not(.custom-validation-error)');
    if (firstServerSideError) {
        const errorParentGroup = firstServerSideError.closest('.form-group, .upload-box, .agreement-section');
        if (errorParentGroup) {
            errorParentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const inputField = errorParentGroup.querySelector('.form-control, .form-control-file, input[type="checkbox"], .custom-checkbox-label');
            if (inputField && inputField.type !== 'checkbox') {
                inputField.classList.add('input-error');
            } else if (inputField && (inputField.type === 'checkbox' || inputField.classList.contains('custom-checkbox-label')) && errorParentGroup.classList.contains('checkbox-group')) {
                 errorParentGroup.classList.add('input-error'); // Подсветка группы кастомного чекбокса
            }
        } else {
            firstServerSideError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // --- ОБНОВЛЕННАЯ Обработка отправки формы --- 
    const startupForm = document.getElementById('startupForm');
    if (startupForm) {
        // Helper function to create and display error messages
        function displayValidationMessage(element, message, fieldType = 'input') {
            // Remove existing error for this element
            const parentGroup = element.closest('.form-group, .upload-box, .logo-upload-group');
            let existingErrorMsg = null;
            if (parentGroup) {
                existingErrorMsg = parentGroup.querySelector('.custom-validation-error.field-specific-error');
            } else {
                // For elements not in a group, check next sibling (less common)
                if (element.nextElementSibling && element.nextElementSibling.classList.contains('custom-validation-error')){
                    existingErrorMsg = element.nextElementSibling;
                }
            }
            if (existingErrorMsg) {
                existingErrorMsg.remove();
            }

            const errorMsg = document.createElement('p');
            errorMsg.className = 'error-message custom-validation-error field-specific-error'; // Added field-specific-error
            errorMsg.textContent = message;

            if (parentGroup) {
                parentGroup.appendChild(errorMsg); // Append error inside the group for better structure
                if (fieldType === 'fileButton' && element.classList.contains('custom-file-upload-button')) {
                    element.classList.add('input-error');
                } else if (element.type !== 'checkbox') { // Don't add to checkbox input itself
                     element.classList.add('input-error');
                }
                // For custom checkboxes, the error highlighting is handled by adding .input-error to parentGroup
            } else {
                // Fallback: insert after the element if no parentGroup found
                element.parentNode.insertBefore(errorMsg, element.nextSibling);
                element.classList.add('input-error');
            }
            return errorMsg; // Return the error message element for scrollIntoView
        }

        startupForm.addEventListener('submit', function(e) {
            let firstInvalidElementOrGroup = null;
            let validationPassed = true;

            // Сброс предыдущих ошибок
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.custom-validation-error').forEach(el => el.remove()); 
            // document.querySelectorAll('.file-upload-area').forEach(el => el.classList.remove('input-error')); // .file-upload-area не используется как основной класс для ошибок
            // document.querySelectorAll('.upload-box .custom-file-upload-button').forEach(el => el.classList.remove('input-error')); // Сброс выше
            // document.querySelectorAll('.checkbox-group').forEach(el => el.classList.remove('input-error')); // Сброс выше
            document.querySelectorAll('.timeline-step .step-number-wrapper').forEach(el => el.classList.remove('error-step'));

            // --- Валидация всех обязательных полей --- 
            const requiredFields = [
                // Текстовые поля и textarea
                { id: '{{ form.title.id_for_label }}', name: 'Название стартапа', type: 'text' },
                { id: '{{ form.funding_goal.id_for_label }}', name: 'Цель финансирования', type: 'text' }, // или number
                { id: '{{ form.short_description.id_for_label }}', name: 'Вводная', type: 'textarea' },
                { id: '{{ form.description.id_for_label }}', name: 'Описание', type: 'textarea' },
                { id: '{{ form.terms.id_for_label }}', name: 'Условия', type: 'textarea' },

                // Select поля (проверка на выбранное значение)
                { id: '{{ form.direction.id_for_label }}', name: 'Направление', type: 'select' },
                { id: '{{ form.stage.id_for_label }}', name: 'Стадия', type: 'select' },

                // Файловые поля
                // { id: 'id_logo_input', name: 'Логотип', type: 'file', required: true }, // Если лого обязателен
                { id: 'id_creatives_input', name: 'Изображения', type: 'file', required: true },
                { id: 'id_video_input', name: 'Видео', type: 'file', required: true },
                // { id: 'id_proofs_input', name: 'Документы', type: 'file', required: true }, // Уже валидируется ниже отдельно
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (element) {
                    let isInvalid = false;
                    if (field.type === 'text' || field.type === 'textarea') {
                        if (!element.value.trim()) {
                            isInvalid = true;
                        }
                    } else if (field.type === 'select') {
                        if (element.value === '' || element.value === null) { // Или специфичное значение для "не выбрано"
                            isInvalid = true;
                        }
                    } else if (field.type === 'file' && field.required) {
                        if (element.files.length === 0) {
                            isInvalid = true;
                        }
                    }

                    if (isInvalid) {
                        validationPassed = false;
                        const errorElement = displayValidationMessage(element, `Пожалуйста, заполните поле "${field.name}".`);
                        if (!firstInvalidElementOrGroup) {
                            firstInvalidElementOrGroup = errorElement.closest('.form-group, .upload-box, .logo-upload-group') || errorElement;
                        }
                        // Для файловых полей, если кнопка кастомная
                        if (field.type === 'file') {
                            const parentBox = element.closest('.upload-box, .logo-upload-group');
                            const uploadButton = parentBox ? parentBox.querySelector('.custom-file-upload-button, .logo-placeholder') : null;
                            if (uploadButton) {
                                uploadButton.classList.add('input-error');
                                if (!firstInvalidElementOrGroup || firstInvalidElementOrGroup === errorElement) { // Если еще не установлено или это ошибка самого поля
                                     firstInvalidElementOrGroup = uploadButton;
                                }
                            }
                        }
                    }
                }
            }

            // Валидация Логотипа (если он обязателен - раскомментировать и настроить required в requiredFields)
            const logoInput = document.getElementById('id_logo_input');
            const logoLabel = document.querySelector('label[for="id_logo_input"]'); // Предполагая, что у лейбла есть for
            // Пример: если лого обязателен, ищем звездочку в label или явно указываем
            // if (logoInput && logoLabel && logoLabel.textContent.includes('*')) { 
            //     if (logoInput.files.length === 0) {
            //         validationPassed = false;
            //         const logoPlaceholder = document.getElementById('logoPlaceholder');
            //         const errorEl = displayValidationMessage(logoPlaceholder || logoInput, 'Пожалуйста, загрузите логотип.');
            //         if (logoPlaceholder) logoPlaceholder.classList.add('input-error');
            //         else logoInput.classList.add('input-error');
            //         if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = logoPlaceholder || logoInput;
            //     }
            // }

            // 1. Валидация описаний этапов таймлайна (оставляем существующую логику)
            const timelineTextareas = startupForm.querySelectorAll('textarea.timeline-description-textarea');
            let timelineErrorDisplayed = false;
            let firstTimelineErrorTextarea = null;

            for (let i = 0; i < timelineTextareas.length; i++) {
                const textarea = timelineTextareas[i];
                const stepNumber = textarea.name.split('_').pop();
                const correspondingStepVisual = document.querySelector(`.timeline-step[data-step="${stepNumber}"] .step-number-wrapper`);

                if (textarea.hasAttribute('required') && !textarea.value.trim()) {
                    validationPassed = false;
                    textarea.classList.add('input-error');
                    if (correspondingStepVisual) {
                        correspondingStepVisual.classList.add('error-step');
                    }
                    if (!firstTimelineErrorTextarea) firstTimelineErrorTextarea = textarea;
                    
                    if (!timelineErrorDisplayed) {
                        const timelineSection = document.getElementById('timeline');
                        const timelineWrapper = timelineSection?.closest('.timeline-section-wrapper'); // Ищем обертку
                        if (timelineWrapper && !timelineWrapper.querySelector('.custom-validation-error.timeline-general-error')) {
                            const errorMsg = document.createElement('p');
                            errorMsg.className = 'error-message custom-validation-error timeline-general-error';
                            errorMsg.textContent = 'Пожалуйста, заполните описания для всех пяти этапов таймлайна.';
                             // Вставляем после h3
                             const titleElement = timelineWrapper.querySelector('h3.section-title');
                             if (titleElement) {
                                 titleElement.parentNode.insertBefore(errorMsg, titleElement.nextSibling);
                             } else {
                                 timelineWrapper.insertBefore(errorMsg, timelineWrapper.firstChild);
                             }
                            timelineErrorDisplayed = true;
                            if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = timelineWrapper; // Скролл к обертке
                        }
                    }
                }
            }
            
            if (firstTimelineErrorTextarea) {
                const stepNumberToShow = firstTimelineErrorTextarea.closest('.timeline-description-container').dataset.stepContent;
                selectStepDescription(stepNumberToShow);
                if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = firstTimelineErrorTextarea;
            }

            // 2. Валидация поля "Документы" (Пруфы) (оставляем существующую)
            const proofsInput = document.getElementById('id_proofs_input');
            const proofsLabelText = document.querySelector('label[for="id_proofs_input"]')?.textContent || '';
            const proofsUploadButton = proofsInput?.closest('.upload-box')?.querySelector('.custom-file-upload-button');
            if (proofsInput && proofsLabelText.includes('*')) { 
                if (proofsInput.files.length === 0) {
                    validationPassed = false;
                    const errorEl = displayValidationMessage(proofsUploadButton || proofsInput, 'Пожалуйста, загрузите Документы.', proofsUploadButton ? 'fileButton' : 'file');
                    if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = proofsUploadButton || proofsInput;
                }
            }
            
            // 3. Валидация чекбокса "Согласие с правилами" (оставляем существующую)
            const agreeRulesCheckbox = document.getElementById('id_agree_rules');
            if (agreeRulesCheckbox && (document.querySelector('label[for="id_agree_rules"] span.checkbox-text')?.textContent?.includes('*') || true)) { // Убрал includes('*') т.к. по логике они обязательны
                if(!agreeRulesCheckbox.checked){
                    validationPassed = false;
                    const parentDiv = agreeRulesCheckbox.closest('.checkbox-group');
                    const errorEl = displayValidationMessage(parentDiv || agreeRulesCheckbox, 'Необходимо подтвердить согласие с правилами.', 'checkbox');
                    if(parentDiv) parentDiv.classList.add('input-error');
                    if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = parentDiv || agreeRulesCheckbox;
                }
            }

            // 4. Валидация чекбокса "Согласие на обработку данных" (оставляем существующую)
            const agreeDataProcessingCheckbox = document.getElementById('id_agree_data_processing');
            if (agreeDataProcessingCheckbox && (document.querySelector('label[for="id_agree_data_processing"] span.checkbox-text')?.textContent?.includes('*') || true )) { // Убрал includes('*')
                if(!agreeDataProcessingCheckbox.checked){
                    validationPassed = false;
                    const parentDiv = agreeDataProcessingCheckbox.closest('.checkbox-group');
                    const errorEl = displayValidationMessage(parentDiv || agreeDataProcessingCheckbox, 'Необходимо подтвердить согласие на обработку персональных данных.', 'checkbox');
                    if(parentDiv) parentDiv.classList.add('input-error');
                    if (!firstInvalidElementOrGroup) firstInvalidElementOrGroup = parentDiv || agreeDataProcessingCheckbox;
                }
            }

            // Логика предотвращения отправки и скролла
            const submitButton = this.querySelector('button[type="submit"]');
            if (!validationPassed) {
                e.preventDefault(); 
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Отправить на модерацию';
                }
                if (firstInvalidElementOrGroup) {
                    // Проверяем, является ли первый невалидный элемент текстовым полем таймлайна
                    if (firstInvalidElementOrGroup.classList && firstInvalidElementOrGroup.classList.contains('timeline-description-textarea')){
                        const container = firstInvalidElementOrGroup.closest('.timeline-description-container');
                        // Если контейнер активен (виден), скроллим к полю
                        if (container && container.classList.contains('active')){
                             firstInvalidElementOrGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else { // Иначе скроллим к началу секции таймлайна
                           const timelineWrapper = document.querySelector('.timeline-section-wrapper');
                           if (timelineWrapper) {
                               timelineWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Скролл к началу секции
                           }
                        }
                    } else if (firstInvalidElementOrGroup.closest('.timeline-section-wrapper')) { // Если ошибка в заголовке таймлайна
                         firstInvalidElementOrGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else { // Для всех остальных ошибок
                        firstInvalidElementOrGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                return false;
            } else {
                // Блокировка кнопки при успешной валидации
                if (submitButton) {
                    if (submitButton.disabled) { 
                         e.preventDefault();
                         return;
                    }
                    submitButton.disabled = true;
                    submitButton.textContent = 'Отправка...';
                }
            }
        });
    }

    // --- Helper function to display file upload errors ---
    function displayFileUploadError(inputId, message) {
        const fileInput = document.getElementById(inputId);
        if (!fileInput) {
            console.error('File input not found for error display:', inputId);
            return;
        }
        // Находим родительский .upload-box или .logo-upload-group по fileInput
        const dropArea = fileInput.closest('.upload-box, .logo-upload-group'); 

        if (!dropArea) {
            console.error('Drop area (parent .upload-box or .logo-upload-group) not found for input:', inputId);
            return;
        }

        // Remove existing file-specific error message for this drop area
        const existingError = dropArea.querySelector('.custom-validation-error.file-specific-upload-error');
        if (existingError) {
            existingError.remove();
        }

        const errorMsgElement = document.createElement('p');
        errorMsgElement.className = 'error-message custom-validation-error file-specific-upload-error';
        errorMsgElement.textContent = message;

        // Try to append after the 'small-text' element or the upload button
        const smallText = dropArea.querySelector('.small-text');
        const uploadButton = dropArea.querySelector('.custom-file-upload-button');

        if (smallText && smallText.nextSibling) {
            smallText.parentNode.insertBefore(errorMsgElement, smallText.nextSibling);
        } else if (smallText) {
            smallText.parentNode.appendChild(errorMsgElement);
        } else if (uploadButton && uploadButton.nextSibling) {
            uploadButton.parentNode.insertBefore(errorMsgElement, uploadButton.nextSibling);
        } else if (uploadButton) {
            uploadButton.parentNode.appendChild(errorMsgElement);
        } else {
            dropArea.appendChild(errorMsgElement); // Fallback
        }

        if (uploadButton) {
            uploadButton.classList.add('input-error');
        } else {
            dropArea.classList.add('input-error');
        }
        
        errorMsgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- Drag & Drop для файлов (Обновлено для документов) ---
    function setupDragAndDrop(inputId, dropAreaId, previewAreaId, allowedTypesDetails, isMultiple = false, maxFiles = 1) {
        const dropArea = document.getElementById(dropAreaId);
        const fileInput = document.getElementById(inputId);
        const previewArea = document.getElementById(previewAreaId);

        if (!dropArea || !fileInput || !previewArea) {
            console.error('Элементы не найдены для Drag & Drop:', { inputId, dropAreaId, previewAreaId });
            return;
        }
        
        // Clear file input value before click to ensure change event fires even for the same file
        const customButton = dropArea.querySelector('.custom-file-upload-button');
        if (customButton) {
            customButton.addEventListener('click', () => {
                console.log(`Clearing fileInput.value for ${inputId} before click.`);
                fileInput.value = null; // << СБРОС ЗНАЧЕНИЯ ПЕРЕД ОТКРЫТИЕМ ДИАЛОГА
                // fileInput.click(); // Это уже делается в HTML через onclick
            });
        }

        checkPlaceholderVisibility(dropAreaId); 

        dropArea.addEventListener('click', (e) => {
            if (e.target.closest('.delete-file-btn') || e.target.closest('.edit-file-btn')) {
                return;
            }
            // Сбрасываем значение перед программным кликом, если клик идет по dropArea, а не по кнопке
            if (!e.target.closest('.custom-file-upload-button')) {
                 console.log(`Clearing fileInput.value for ${inputId} via dropArea click.`);
                 fileInput.value = null;
                 fileInput.click();
            }
        });

        fileInput.addEventListener('change', (event) => {
            console.log(`File input ${inputId} CHANGED. Event target files:`, event.target.files);
            if (event.target.files && event.target.files.length > 0) {
                handleFiles(event.target.files, inputId, previewAreaId, allowedTypesDetails, isMultiple, maxFiles);
            } else {
                console.log(`File input ${inputId} changed, but no files selected or files array is empty.`);
            }
            checkPlaceholderVisibility(dropAreaId);
        });

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            dropArea.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length) {
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => dataTransfer.items.add(file));
                fileInput.files = dataTransfer.files;
                
                handleFiles(files, inputId, previewAreaId, allowedTypesDetails, isMultiple, maxFiles);
            }
            checkPlaceholderVisibility(dropAreaId);
        });
        
        updateFileActionButtonsState(previewAreaId);
    }

    // Общая функция для обработки файлов и отображения превью
    function handleFiles(files, inputId, previewAreaId, allowedTypesDetails, isMultiple, maxFiles) {
        const fileInput = document.getElementById(inputId);
        const previewArea = document.getElementById(previewAreaId);
        const existingFileCount = previewArea.children.length;

        // Удаляем предыдущие ошибки для этого поля загрузки
        const dropArea = fileInput.closest('.upload-box, .logo-upload-group');
        if (dropArea) {
            const existingError = dropArea.querySelector('.custom-validation-error.file-specific-upload-error');
            if (existingError) {
                existingError.remove();
            }
            const uploadButton = dropArea.querySelector('.custom-file-upload-button');
            if (uploadButton) uploadButton.classList.remove('input-error');
            else dropArea.classList.remove('input-error');
        }

        console.log(`handleFiles called for inputId: ${inputId}. Received ${files.length} files. IsMultiple: ${isMultiple}, MaxFiles: ${maxFiles}, ExistingFilesInPreview: ${existingFileCount}`);

        if (!isMultiple) {
            previewArea.innerHTML = ''; // Очищаем превью для одиночных файлов
            console.log('Cleared preview area for single file input.');
        }

        let filesToProcess = Array.from(files);
        console.log('Initial filesToProcess count:', filesToProcess.length);

        if (isMultiple && (existingFileCount + filesToProcess.length > maxFiles)) {
            displayFileUploadError(inputId, `Можно загрузить не более ${maxFiles} файлов для этого поля.`);
            filesToProcess = filesToProcess.slice(0, maxFiles - existingFileCount);
            console.log(`Slicing files for multiple input. New filesToProcess count: ${filesToProcess.length}`);
        } else if (!isMultiple && filesToProcess.length > maxFiles) {
            displayFileUploadError(inputId, `Можно загрузить не более ${maxFiles} файла для этого поля.`);
            filesToProcess = filesToProcess.slice(0, maxFiles);
            console.log(`Slicing files for single input (e.g. via drag-drop). New filesToProcess count: ${filesToProcess.length}`);
        }
        
        // Обновляем files в fileInput, если количество файлов было изменено из-за maxFiles
        if (filesToProcess.length < Array.from(files).length) {
            const dataTransfer = new DataTransfer();
            filesToProcess.forEach(file => dataTransfer.items.add(file));
            if (fileInput) {
                fileInput.files = dataTransfer.files;
                console.log(`Updated fileInput.files for ${inputId} due to maxFiles constraint. New count: ${fileInput.files.length}`);
            }
        }

        filesToProcess.forEach((file, index) => {
            console.log(`Processing file #${index + 1}: ${file.name}, type: ${file.type}, size: ${file.size}`);
            const fileType = file.type;
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let isAllowed = false;

            if (allowedTypesDetails.mimes.some(mime => fileType.startsWith(mime)) && fileType !== '') {
                isAllowed = true;
            } else if (allowedTypesDetails.extensions.includes(fileExtension)) {
                isAllowed = true;
            }
            
            console.log(`File ${fileName} - Allowed: ${isAllowed}. Type found: ${fileType}, Ext found: ${fileExtension}. Allowed mimes: ${allowedTypesDetails.mimes.join(',')}, Allowed exts: ${allowedTypesDetails.extensions.join(',')}`);


            if (!isAllowed) {
                displayFileUploadError(inputId, `Файл "${file.name}" имеет неподдерживаемый тип или расширение. Допустимые форматы: ${allowedTypesDetails.extensions.map(ext => ext.toUpperCase()).join(', ')}`);
                console.warn(`File ${file.name} has unsupported type. Skipping.`);
                // Удаляем этот файл из fileInput.files, если он там оказался (особенно актуально для drag-n-drop)
                if (fileInput) {
                    const dt = new DataTransfer();
                    Array.from(fileInput.files).forEach(f => {
                        if (f.name !== file.name || f.size !== file.size || f.lastModified !== file.lastModified) {
                           dt.items.add(f);
                        }
                    });
                    fileInput.files = dt.files;
                     console.log(`Removed disallowed file ${file.name} from input ${inputId}. New input count: ${fileInput.files.length}`);
                }
                return; 
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const isImage = file.type.startsWith('image/');
                const previewSrc = isImage && e.target.result ? e.target.result : creatStartupStaticUrl + 'docimage.png';
                const imageClass = isImage ? 'preview-image' : 'file-icon';

                const dragHandleHTML = `<div class="drag-handle-mock"><span></span><span></span><span></span><span></span><span></span><span></span></div>`;
                const actionsHTML = `
                    <div class="file-actions">
                        <button type="button" class="edit-file-btn" aria-label="Редактировать">
                            <img src="${creatStartupStaticUrl}edit_icon.svg" alt="Редактировать">
                        </button>
                        <button type="button" class="delete-file-btn" aria-label="Удалить">
                            <img src="${creatStartupStaticUrl}delete_icon.svg" alt="Удалить">
                        </button>
                    </div>`;

                const previewItemHTML = `
                    <div class="file-preview-item" draggable="true" data-filename="${CSS.escape(file.name)}">
                        ${dragHandleHTML}
                        <div class="file-info">
                            <img src="${previewSrc}" alt="${isImage ? 'Предпросмотр' : 'Иконка файла'}" class="${imageClass}">
                            <div class="file-text-details">
                                <p class="file-name-display">${file.name}</p>
                                <p class="file-type-display">${fileExtension.toUpperCase()}</p>
                            </div>
                        </div>
                        ${actionsHTML}
                    </div>`;

                if (!isMultiple) {
                    previewArea.innerHTML = previewItemHTML;
                } else {
                     if (previewArea.children.length < maxFiles) {
                        previewArea.insertAdjacentHTML('beforeend', previewItemHTML);
                    }
                }
                updateFileActionButtonsState(previewAreaId); 
            };

            if (file.type.startsWith('image/')) {
                console.log(`Reading ${file.name} as Data URL (image).`);
                reader.readAsDataURL(file);
            } else {
                console.log(`Processing ${file.name} as non-image. Triggering onload directly.`);
                reader.onload({ target: { result: null } }); 
            }
        });

        if (fileInput) {
             fileInput.dataset.hadFile = previewArea.children.length > 0 ? 'true' : 'false';
             console.log(`Finished processing for ${inputId}. Preview area has ${previewArea.children.length} items. hadFile: ${fileInput.dataset.hadFile}`);
        }
        updateFileActionButtonsState(previewAreaId);

        // Микроинвестиции
        const microCheckboxInput = document.getElementById('id_micro_investment_available');
        const microLabel = document.querySelector('label[for="id_micro_investment_available"].micro-investment-label-new');

        if (microCheckboxInput && microLabel) {
            const visualUnchecked = microLabel.querySelector('.micro-checkbox-unchecked');
            const visualChecked = microLabel.querySelector('.micro-checkbox-checked');

            if (visualUnchecked && visualChecked) {
                const updateMicroCheckboxVisual = () => {
                    if (microCheckboxInput.checked) {
                        visualUnchecked.style.display = 'none';
                        visualChecked.style.display = 'inline-block';
                    } else {
                        visualUnchecked.style.display = 'inline-block';
                        visualChecked.style.display = 'none';
                    }
                };

                // Устанавливаем начальное состояние при загрузке
                updateMicroCheckboxVisual();

                // Обработчик клика на label
                microLabel.addEventListener('click', function(e) {
                    // Не предотвращаем стандартное поведение, label for сам переключит input
                    // Просто обновим визуализацию ПОСЛЕ того, как браузер изменит состояние инпута
                    // Используем setTimeout, чтобы дать браузеру время обновить .checked состояние
                    setTimeout(updateMicroCheckboxVisual, 0);
                });

                // Также слушаем событие change на самом инпуте (на случай, если он меняется другим способом)
                microCheckboxInput.addEventListener('change', updateMicroCheckboxVisual);

            } else {
                console.error('Visual elements for micro-investment checkbox not found inside label.');
            }
        } else {
            console.error('Micro-investment checkbox input or its new label not found.');
        }
    }
    
    // Удаление файла из превью и из fileInput.files (Обновлено)
    document.addEventListener('click', function(event) {
        const deleteButton = event.target.closest('.delete-file-btn'); // изменено с remove-file-btn
        if (deleteButton) {
            const previewItem = deleteButton.closest('.file-preview-item');
            if (!previewItem) return;

            const fileNameToRemove = previewItem.dataset.filename;
            const previewArea = previewItem.parentElement;
            
            // Определяем связанный input по ID previewArea
            // Например, creativesPreview -> id_creatives_input
            const inputId = previewArea.id.replace('Preview', '_input'); 
            const fileInput = document.getElementById(inputId);

            if (fileInput) {
                const dt = new DataTransfer();
                const files = Array.from(fileInput.files);
                files.forEach(file => {
                    if (CSS.escape(file.name) !== fileNameToRemove) { // Сравнение экранированных имен
                        dt.items.add(file);
                    }
                });
                fileInput.files = dt.files; // Обновляем files в input
            }
            previewItem.remove(); // Удаляем элемент из DOM
            checkPlaceholderVisibility(previewArea.id.replace('Preview', 'DropArea')); // Обновляем видимость плейсхолдера
            updateFileActionButtonsState(previewArea.id);
        }
    });

    // Настройка Drag & Drop для всех полей
    setupDragAndDrop('id_creatives_input', 'creativesDropArea', 'creativesPreview', 
        { mimes: ['image/jpeg', 'image/png'], extensions: ['jpg', 'jpeg', 'png'] }, true, 3);
    setupDragAndDrop('id_video_input', 'videoDropArea', 'videoPreview', 
        { mimes: ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'], extensions: ['mp4', 'mov', 'avi', 'mkv'] }, false, 1);
    setupDragAndDrop('id_proofs_input', 'proofsDropArea', 'proofsPreview', 
        { mimes: ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'], extensions: ['pdf', 'doc', 'docx', 'xls', 'xlsx'] }, true, 3);


    // --- Logic for custom checkboxes (Обновлено) ---
    function setupCustomCheckboxes() {
        // Согласия
        document.querySelectorAll('.agreement-section .custom-checkbox-label').forEach(label => {
            const inputId = label.getAttribute('for');
            const input = document.getElementById(inputId);
            const uncheckedVisual = label.querySelector('.custom-checkbox-unchecked');
            const checkedVisual = label.querySelector('.custom-checkbox-checked');

            if (input && uncheckedVisual && checkedVisual) {
                const updateAgreementIcons = () => {
                    if (input.checked) {
                        uncheckedVisual.style.display = 'none';
                        checkedVisual.style.display = 'block'; // или 'inline-block' / 'flex' в зависимости от CSS для галочки
                    } else {
                        uncheckedVisual.style.display = 'block'; // или 'inline-block' / 'flex'
                        checkedVisual.style.display = 'none';
                    }
                };
                updateAgreementIcons();
                input.addEventListener('change', updateAgreementIcons);
            }
        });

        // Микроинвестиции
        const microCheckboxInput = document.getElementById('id_micro_investment_available');
        const microLabel = document.querySelector('label[for="id_micro_investment_available"].micro-investment-label-new');

        if (microCheckboxInput && microLabel) {
            const visualUnchecked = microLabel.querySelector('.micro-checkbox-unchecked');
            const visualChecked = microLabel.querySelector('.micro-checkbox-checked');

            if (visualUnchecked && visualChecked) {
                const updateMicroCheckboxVisual = () => {
                    if (microCheckboxInput.checked) {
                        visualUnchecked.style.display = 'none';
                        visualChecked.style.display = 'inline-block';
                    } else {
                        visualUnchecked.style.display = 'inline-block';
                        visualChecked.style.display = 'none';
                    }
                };

                // Устанавливаем начальное состояние при загрузке
                updateMicroCheckboxVisual();

                // Обработчик клика на label
                microLabel.addEventListener('click', function(e) {
                    // Не предотвращаем стандартное поведение, label for сам переключит input
                    // Просто обновим визуализацию ПОСЛЕ того, как браузер изменит состояние инпута
                    // Используем setTimeout, чтобы дать браузеру время обновить .checked состояние
                    setTimeout(updateMicroCheckboxVisual, 0);
                });

                // Также слушаем событие change на самом инпуте (на случай, если он меняется другим способом)
                microCheckboxInput.addEventListener('change', updateMicroCheckboxVisual);

            } else {
                console.error('Visual elements for micro-investment checkbox not found inside label.');
            }
        } else {
            console.error('Micro-investment checkbox input or its new label not found.');
        }
    }
    setupCustomCheckboxes();

    // --- Translate Direction Options --- 
    function translateDirectionOptions() {
        const directionSelect = document.getElementById('{{ form.direction.id_for_label }}');
        if (!directionSelect) {
            console.error('Direction select field not found for translation.');
            return;
        }

        const translations = {
            "Medicine": "Медицина",
            "Auto": "Автомобили",
            "Delivery": "Доставка",
            "Cafe": "Кафе/рестораны",
            "Fastfood": "Фастфуд",
            "Health": "Здоровье",
            "Beauty": "Красота",
            "Transport": "Транспорт",
            "Sport": "Спорт",
            "Psychology": "Психология",
            "AI": "ИИ",
            "Finance": "Финансы",
            "Healthcare": "Здравоохранение",
            "Technology": "Технологии"
            // Добавьте другие переводы по аналогии, если необходимо
        };

        Array.from(directionSelect.options).forEach(option => {
            const originalValue = option.textContent.trim(); // или option.value, если value содержит англ. название
            if (translations[originalValue]) {
                option.textContent = translations[originalValue];
            }
        });
    }
    translateDirectionOptions();

    // --- Spin buttons for Valuation --- (Добавлено)
    const valuationInput = document.querySelector('.valuation-input input[type="number"]');
    const spinUp = document.querySelector('.valuation-spin-buttons .spin-up');
    const spinDown = document.querySelector('.valuation-spin-buttons .spin-down');

    if (valuationInput && spinUp && spinDown) {
        spinUp.addEventListener('click', () => {
            valuationInput.stepUp();
        });
        spinDown.addEventListener('click', () => {
            valuationInput.stepDown();
        });
    }

    // Обновление состояния кнопок редактирования/удаления
    function updateFileActionButtonsState(previewAreaId) {
        const previewArea = document.getElementById(previewAreaId);
        if (!previewArea) return;

        const items = previewArea.querySelectorAll('.file-preview-item');
        items.forEach(item => {
            const editBtn = item.querySelector('.edit-file-btn');
            const deleteBtn = item.querySelector('.delete-file-btn');
            const fileName = item.dataset.filename; 

            if (editBtn) {
                editBtn.style.display = 'none'; // Функционал редактирования пока не реализован
            }
            // Логика для deleteBtn уже в общем обработчике кликов документа
        });
    }
    
    // Показываем/скрываем плейсхолдер (для кнопок "Выбрать файл")
    function checkPlaceholderVisibility(dropAreaId) {
        const dropArea = document.getElementById(dropAreaId);
        if (!dropArea) return;

        // Эта функция, возможно, больше не нужна в таком виде, 
        // так как "плейсхолдер" - это сама кнопка "Выбрать файл", которая всегда видна.
        // Если речь шла о каком-то другом плейсхолдере, нужно уточнить.
        // const previewAreaId = dropAreaId.replace('DropArea', 'Preview');
        // const previewArea = document.getElementById(previewAreaId);
        // const placeholder = dropArea.querySelector('.upload-placeholder'); // Если есть такой класс

        // if (placeholder && previewArea) {
        //     if (previewArea.children.length > 0) {
        //         placeholder.style.display = 'none';
        //     } else {
        //         placeholder.style.display = 'flex'; 
        //     }
        // }
    }

});
</script>
{% endblock %}