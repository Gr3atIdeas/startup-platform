{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Создание стартапа{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'accounts/css/startup_form.css' %}">

<div class="startup-form-container">
    <div class="form-navigation-header">
        <a href="{% url 'startups_list' %}" class="back-button">← Назад</a>
        <h2 class="form-main-title">Создание стартапа</h2>
    </div>

    <form method="post" enctype="multipart/form-data" id="startupForm" novalidate>
        {% csrf_token %}

        
        <div class="form-section-top">
            <div class="form-top-grid">
                <div class="form-top-left">
                <div class="form-group planet-upload-group">
                    <label class="planet-upload-label">Выберите планету *</label>
                    <div class="planet-selector">
                    <button type="button" class="planet-nav-button prev-planet" aria-label="Предыдущая планета">
                        <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="Previous" loading="lazy" decoding="async">
                    </button>
                    <div class="planet-display">
                        <div class="planet-ribbon" id="planetRibbon">
                            
                        </div>
                    </div>
                    <button type="button" class="planet-nav-button next-planet" aria-label="Следующая планета">
                        <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="Next" loading="lazy" decoding="async">
                    </button>
                    </div>
                    {{ form.planet_image|add_class:"form-control"|attr:"id:id_planet_image" }}
                    {% if form.planet_image.errors %}
                    <span class="error-message">{{ form.planet_image.errors|first }}</span>
                    {% endif %}
                </div>
                <div class="form-group logo-upload-group">
                    <div class="logo-upload-label">
                    <div class="logo-placeholder" id="logoPlaceholder">
                        <img src="{% static 'accounts/images/icons/image_placeholder.svg' %}" alt="Upload Logo Icon" loading="lazy" decoding="async">
                        <span>*Загрузить логотип</span>
                    </div>
                    <img src="" alt="Логотип" class="logo-preview" id="logoPreview" style="display:none;">
                    </div>
                    {{ form.logo|add_class:"form-control-file"|attr:"id:id_logo_input"|attr:"style:display:none;" }}
                    <div class="custom-file-upload-button" id="logoUploadButton">Выбрать логотип</div>
                    {% if form.logo.errors %}
                    <span class="error-message">{{ form.logo.errors|first }}</span>
                    {% endif %}
                </div>
                <div class="form-fields-left">
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">*{{ form.title.label }}</label>
                            <div class="input-wrapper">
                                {{ form.title|add_class:"form-control"|attr:"placeholder:Ромашка" }}
                            </div>
                            {% if form.title.errors %}<span class="error-message">{{ form.title.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.direction.id_for_label }}">*{{ form.direction.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.direction|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow" loading="lazy" decoding="async">
                            </div>
                            {% if form.direction.errors %}<span class="error-message">{{ form.direction.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.funding_goal.id_for_label }}">*{{ form.funding_goal.label }}</label>
                            <div class="input-wrapper">
                                {{ form.funding_goal|add_class:"form-control"|attr:"placeholder:Введите сумму ₽" }}
                            </div>
                            {% if form.funding_goal.errors %}<span class="error-message">{{ form.funding_goal.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.stage.id_for_label }}">*{{ form.stage.label }}</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.stage|add_class:"form-control" }}
                                 <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow" loading="lazy" decoding="async">
                            </div>
                            {% if form.stage.errors %}<span class="error-message">{{ form.stage.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-top-right">
                    <div class="investment-type-card">
                        <div class="form-group checkbox-group micro-investment-group">
                            {{ form.micro_investment_available|attr:"id:id_micro_investment_available"|add_class:"form-check-input-hidden" }}
                            <label for="id_micro_investment_available" class="micro-investment-label-new">
                                <span class="micro-checkbox-visual">
                                    <span class="micro-checkbox-unchecked"></span>
                                    <img src="{% static 'accounts/images/creat_startup/checkmark-circle-blue.svg' %}" alt="checked" class="micro-checkbox-checked" style="display:none;">
                                </span>
                                <span class="checkbox-text-span">Микроинвестиции доступны</span>
                            </label>
                            {% if form.micro_investment_available.errors %}<span class="error-message">{{ form.micro_investment_available.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group investment-type-group">
                            <label for="{{ form.investment_type.id_for_label }}" class="investment-type-label">Тип инвестирования</label>
                            <div class="input-wrapper select-wrapper">
                                {{ form.investment_type|add_class:"form-control" }}
                                <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="dropdown arrow" class="select-arrow" loading="lazy" decoding="async">
                            </div>
                            {% if form.investment_type.errors %}<span class="error-message">{{ form.investment_type.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="form-main-content-wrapper">

            
            <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.short_description.id_for_label }}">*{{ form.short_description.label }}</label>
                    {{ form.short_description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для..." }}
                    <div class="small-text">Краткое описание вашего стартапа, основные моменты.</div>
                    {% if form.short_description.errors %}<span class="error-message">{{ form.short_description.errors|first }}</span>{% endif %}
                </div>
                <div class="form-group full-width">
                    <label for="{{ form.description.id_for_label }}">*{{ form.description.label }}</label>
                    {{ form.description|add_class:"form-control"|attr:"placeholder:Наш стартап разрабатывает инновационную платформу для телемедицины, которая обеспечивает пользователям доступ..." }}
                    <div class="small-text">Подробное описание вашего стартапа. Расскажите о проблеме, решении, команде и т.д.</div>
                    {% if form.description.errors %}<span class="error-message">{{ form.description.errors|first }}</span>{% endif %}
                </div>
            </div>

            
             <div class="form-content-section">
                <div class="upload-section-grid media-and-finance-grid">
                    
                    <div class="form-group upload-box" id="creativesDropArea">
                        <label>*Изображения</label>
                        {{ form.creatives|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_creatives_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_creatives_input').click()">Выбрать файл</div>
                        <div class="small-text">Допустимый формат PNG, JPEG (до 3 файлов)</div>
                        <div id="creativesPreview" class="file-preview-area"></div>
                        {% if form.creatives.errors %}<span class="error-message">{{ form.creatives.errors|first }}</span>{% endif %}
                    </div>
                    
                    <div class="form-group upload-box" id="videoDropArea">
                        <label>*Видео</label>
                        {{ form.video|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_video_input" }}
                        <div class="custom-file-upload-button" onclick="document.getElementById('id_video_input').click()">Выбрать файлы</div>
                        <div class="small-text">Допустимый формат MOV, MP4 (до 3 файлов)</div>
                        <div id="videoPreview" class="file-preview-area"></div>
                        {% if form.video.errors %}<span class="error-message">{{ form.video.errors|first }}</span>{% endif %}
                    </div>
                    
                    <div class="presentation-finance-group">
                        <div class="form-group">
                            <label for="{{ form.pitch_deck_url.id_for_label }}">{{ form.pitch_deck_url.label }}</label>
                            <div class="input-wrapper">
                                {{ form.pitch_deck_url|add_class:"form-control"|attr:"placeholder:URL" }}
                            </div>
                            {% if form.pitch_deck_url.errors %}<span class="error-message">{{ form.pitch_deck_url.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.valuation.id_for_label }}">{{ form.valuation.label }}</label>
                            <div class="input-wrapper valuation-input">
                                {{ form.valuation|add_class:"form-control"|attr:"placeholder:1"|attr:"type:number"|attr:"min:1" }}
                                <div class="valuation-spin-buttons">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="increase value" class="spin-up">
                                    <img src="{% static 'accounts/images/creat_startup/Chevron down.svg' %}" alt="decrease value" class="spin-down">
                                </div>
                            </div>
                            {% if form.valuation.errors %}<span class="error-message">{{ form.valuation.errors|first }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.amount_raised.id_for_label }}">{{ form.amount_raised.label }}</label>
                            <div class="input-wrapper">
                                {{ form.amount_raised|add_class:"form-control"|attr:"placeholder:Введите сумму"|attr:"type:number" }}
                            </div>
                            {% if form.amount_raised.errors %}<span class="error-message">{{ form.amount_raised.errors|first }}</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
             <div class="form-content-section">
                <div class="form-group full-width">
                    <label for="{{ form.terms.id_for_label }}">*{{ form.terms.label }}</label>
                    {{ form.terms|add_class:"form-control"|attr:"placeholder:Договоры займа сроком на 12 месяцев..." }}
                    <div class="small-text">Условия инвестирования или выкупа, если они уже определены.</div>
                    {% if form.terms.errors %}<span class="error-message">{{ form.terms.errors|first }}</span>{% endif %}
                </div>
            </div>
            
            
             <div class="form-content-section timeline-section-wrapper">
                 <h3 class="section-title">*Этапы</h3>
                <div class="timeline" id="timeline">
                    <div class="timeline-progress-container">
                        <div class="timeline-progress-line"></div>
                        <div class="timeline-progress-filled" id="timelineProgressFilled"></div>
                    </div>
                    {% for i in "12345" %}
                    <div class="timeline-step" data-step="{{ i }}">
                        <div class="step-number-wrapper" id="stepNumber{{ i }}">
                             {% if i == "1" %}<img src="{% static 'accounts/images/creat_startup/Frame 996.svg' %}" alt="Иконка Этап 1" class="step-icon" loading="lazy" decoding="async">{% endif %}
                             {% if i == "2" %}<img src="{% static 'accounts/images/creat_startup/Frame 995.svg' %}" alt="Иконка Этап 2" class="step-icon" loading="lazy" decoding="async">{% endif %}
                             {% if i == "3" %}<img src="{% static 'accounts/images/creat_startup/Frame 994.svg' %}" alt="Иконка Этап 3" class="step-icon" loading="lazy" decoding="async">{% endif %}
                             {% if i == "4" %}<img src="{% static 'accounts/images/creat_startup/Frame 993.svg' %}" alt="Иконка Этап 4" class="step-icon" loading="lazy" decoding="async">{% endif %}
                             {% if i == "5" %}<img src="{% static 'accounts/images/creat_startup/Frame 992.svg' %}" alt="Иконка Этап 5" class="step-icon" loading="lazy" decoding="async">{% endif %}
                        </div>
                        <div class="step-text">Этап {{ i }}</div>
                        <button type="button" class="btn-select-current-step" data-step-target="{{ i }}">Мы здесь</button>
                    </div>
                    {% endfor %}
                </div>
                <div id="step-descriptions">
                    {% for i in "12345" %}
                    <div class="timeline-description-container" id="step-description-{{ i }}" data-step-content="{{ i }}">
                        <div class="timeline-description-header">
                            <div class="timeline-description-title-wrapper">
                                <div class="timeline-description-title">Этап {{ i }}</div>
                            </div>
                        </div>
                        <textarea class="timeline-description-textarea" name="step_description_{{ i }}" placeholder="Описание" {% if i == "1" %}required{% endif %}></textarea>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="step_number" id="step_number" value="1">
            </div>

            
             <div class="form-content-section">
                <div class="form-group upload-box full-width" id="proofsDropArea">
                    <label>*Документы</label>
                    {{ form.proofs|attr:"style:display:none"|attr:"multiple:true"|attr:"id:id_proofs_input" }}
                    <div class="custom-file-upload-button" onclick="document.getElementById('id_proofs_input').click()">Выбрать файлы</div>
                    <div class="small-text">Допустимый формат Doc, Excel, PDF (до 10 файлов)</div>
                    <div id="proofsPreview" class="file-preview-area">
                    </div>
                    {% if form.proofs.errors %}<span class="error-message">{{ form.proofs.errors|first }}</span>{% endif %}
                </div>
            </div>

            
             <div class="form-content-section agreement-section-outer-wrapper">
                <div class="agreement-section">
                    <h3 class="section-title">Согласие</h3>
                    <div class="form-group">
                        <div class="small-text">Перед установкой галочек ознакомьтесь с документами:</div>
                        <div class="consents-docs-buttons">
                            <button type="button" class="custom-file-upload-button consent-doc-btn" data-doc="1">Документ 1</button>
                            <button type="button" class="custom-file-upload-button consent-doc-btn" data-doc="2">Документ 2</button>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        {{ form.agree_rules|attr:"id:id_agree_rules"|add_class:"form-check-input-hidden"|attr:"disabled:disabled" }}
                        <label for="id_agree_rules" class="custom-checkbox-label">
                            <span class="custom-checkbox-visual">
                                <span class="custom-checkbox-unchecked"></span>
                                <span class="custom-checkbox-checked"></span>
                            </span>
                            <span class="checkbox-text">{{ form.agree_rules.label }}</span>
                        </label>
                        {% if form.agree_rules.errors %}<span class="error-message">{{ form.agree_rules.errors|first }}</span>{% endif %}
                    </div>
                    <div class="form-group checkbox-group">
                        {{ form.agree_data_processing|attr:"id:id_agree_data_processing"|add_class:"form-check-input-hidden"|attr:"disabled:disabled" }}
                        <label for="id_agree_data_processing" class="custom-checkbox-label">
                            <span class="custom-checkbox-visual">
                                <span class="custom-checkbox-unchecked"></span>
                                <span class="custom-checkbox-checked"></span>
                            </span>
                            <span class="checkbox-text">{{ form.agree_data_processing.label }}</span>
                        </label>
                        {% if form.agree_data_processing.errors %}<span class="error-message">{{ form.agree_data_processing.errors|first }}</span>{% endif %}
                    </div>
                </div>
            </div>

        </div> 

        
        <div class="submit-button-container">
            <button type="submit" class="submit-button">Отправить на модерацию</button>
        </div>
    </form>
</div>

<script src="{% static 'accounts/js/startup_form.js' %}"></script>
<script>
const creatStartupStaticUrl = "{% static 'accounts/images/creat_startup/' %}";
const planetChoices = [{% for choice in form.planet_image.field.choices %}"{{ choice.0|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}];
const planetBaseUrl = "{{ S3_PUBLIC_BASE_URL }}/choosable_planets/";

document.addEventListener('DOMContentLoaded', function() {
    const planetInput = document.getElementById('id_planet_image');
    const planetRibbon = document.getElementById('planetRibbon');
    const prevButton = document.querySelector('.planet-nav-button.prev-planet');
    const nextButton = document.querySelector('.planet-nav-button.next-planet');
    let currentPlanetIndex = 0;

    if (!planetRibbon) {
        return;
    }

    function createPlanetRibbon() {
        planetRibbon.innerHTML = '';

        const totalPlanets = planetChoices.length;
        if (totalPlanets === 0) {
            return;
        }

        planetChoices.forEach((planet, index) => {
            const planetImg = document.createElement('img');
            planetImg.className = 'planet-ribbon-item';
            planetImg.src = planetBaseUrl + planet;
            planetImg.alt = `Планета ${index + 1}`;
            planetImg.dataset.planetIndex = index;
            planetImg.loading = 'lazy';
            planetImg.decoding = 'async';

            planetImg.onerror = () => {
                planetImg.src = 'https://via.placeholder.com/150';
            };

            planetImg.onload = () => {
                planetImg.style.opacity = '1';
            };

            planetRibbon.appendChild(planetImg);
        });

        planetRibbon.style.width = `${totalPlanets * 450}px`;
        currentPlanetIndex = 0;
        planetRibbon.style.transform = 'translateX(0)';
        planetInput.value = planetChoices[0];
    }

    function updatePlanetRibbon(direction) {
        const totalPlanets = planetChoices.length;
        if (totalPlanets === 0) return;

        if (direction === 'next') {
            currentPlanetIndex = (currentPlanetIndex + 1) % totalPlanets;
        } else {
            currentPlanetIndex = (currentPlanetIndex - 1 + totalPlanets) % totalPlanets;
        }

        const translateX = -currentPlanetIndex * 450;
        planetRibbon.style.transition = 'transform 0.4s ease-in-out';
        planetRibbon.style.transform = `translateX(${translateX}px)`;
        planetInput.value = planetChoices[currentPlanetIndex];
    }

    prevButton.addEventListener('click', () => {
        if (planetChoices.length > 0) {
            updatePlanetRibbon('prev');
        }
    });

    nextButton.addEventListener('click', () => {
        if (planetChoices.length > 0) {
            updatePlanetRibbon('next');
        }
    });

    if (planetChoices && planetChoices.length > 0) {
        createPlanetRibbon();
    } else {
        planetRibbon.innerHTML = '<img src="https://via.placeholder.com/150" alt="Нет планет" class="planet-ribbon-item">';
        planetInput.value = '';
    }

    const logoInput = document.getElementById('id_logo_input');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const logoPreviewImg = document.getElementById('logoPreview');
    const logoUploadButton = document.getElementById('logoUploadButton');

    if (logoInput && logoUploadButton && logoPreviewImg) {
        logoUploadButton.addEventListener('click', () => logoInput.click());

        logoInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoPreviewImg.src = e.target.result;
                    logoPreviewImg.style.display = 'block';
                    if (logoPlaceholder) { logoPlaceholder.style.display = 'none'; }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    const timelineSteps = document.querySelectorAll('.timeline-step');
    const descriptionContainers = document.querySelectorAll('.timeline-description-container');
    const currentStepInput = document.getElementById('step_number');
    const setCurrentButtons = document.querySelectorAll('.btn-select-current-step');
    const timelineProgressFilled = document.getElementById('timelineProgressFilled');
    const totalSteps = 5;

    function selectStepDescription(stepNumber) {
        descriptionContainers.forEach(container => {
            container.classList.toggle('active', container.dataset.stepContent == stepNumber);
        });
        timelineSteps.forEach(step => {
            step.classList.toggle('active-step-display', step.dataset.step == stepNumber);
        });
    }

    function setCurrentStep(stepNumber) {
        const currentStep = parseInt(stepNumber);
        currentStepInput.value = currentStep;

        timelineSteps.forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            const stepWrapper = step.querySelector('.step-number-wrapper');

            step.classList.remove('active-step-display');
            stepWrapper.classList.remove('active');

            if (stepNum <= currentStep) {
                stepWrapper.classList.add('active');
            }

            if (stepNum === currentStep) {
                selectStepDescription(currentStep);
            }
        });

        let progressPercentage = 0;
        if (currentStep > 1) {
            progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        }
        if (timelineProgressFilled) {
            timelineProgressFilled.style.width = `${progressPercentage}%`;
        }
    }

    timelineSteps.forEach(step => {
        step.addEventListener('click', function() {
            const stepNum = this.dataset.step;
            selectStepDescription(stepNum);
        });
    });

    setCurrentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const stepNum = this.dataset.stepTarget;
            setCurrentStep(stepNum);
        });
    });
    
    if (timelineSteps.length > 0) {
        setCurrentStep(1);
    }

    const firstServerSideError = document.querySelector('.error-message:not(.custom-validation-error)');
    if (firstServerSideError) {
        const errorParentGroup = firstServerSideError.closest('.form-group, .upload-box, .agreement-section');
        if (errorParentGroup) {
            errorParentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const inputField = errorParentGroup.querySelector('.form-control, .form-control-file, input[type="checkbox"], .custom-checkbox-label');
            if (inputField && inputField.type !== 'checkbox') {
                inputField.classList.add('input-error');
            } else if (inputField && (inputField.type === 'checkbox' || inputField.classList.contains('custom-checkbox-label')) && errorParentGroup.classList.contains('checkbox-group')) {
                errorParentGroup.classList.add('input-error');
            }
        } else {
            firstServerSideError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    const startupForm = document.getElementById('startupForm');
    if (startupForm) {
        function displayValidationMessage(element, message, fieldType = 'input') {
            const parentGroup = element.closest('.form-group, .upload-box, .logo-upload-group');
            let existingErrorMsg = null;
            if (parentGroup) {
                existingErrorMsg = parentGroup.querySelector('.custom-validation-error.field-specific-error');
            } else if (element.nextElementSibling && element.nextElementSibling.classList.contains('custom-validation-error')) {
                existingErrorMsg = element.nextElementSibling;
            }
            if (existingErrorMsg) {
                existingErrorMsg.remove();
            }

            const errorMsg = document.createElement('p');
            errorMsg.className = 'error-message custom-validation-error field-specific-error';
            errorMsg.textContent = message;

            if (parentGroup) {
                parentGroup.appendChild(errorMsg);
                if (fieldType === 'fileButton' && element.classList.contains('custom-file-upload-button')) {
                    element.classList.add('input-error');
                } else if (element.type !== 'checkbox') {
                    element.classList.add('input-error');
                }
            } else {
                element.parentNode.insertBefore(errorMsg, element.nextSibling);
                element.classList.add('input-error');
            }
            return errorMsg;
        }

        startupForm.addEventListener('submit', function(e) {
            let firstInvalidElementOrGroup = null;
            let validationPassed = true;

            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.custom-validation-error').forEach(el => el.remove());
            document.querySelectorAll('.timeline-step .step-number-wrapper').forEach(el => el.classList.remove('error-step'));

            const requiredFields = [
                { id: '{{ form.title.id_for_label }}', name: 'Название стартапа', type: 'text' },
                { id: '{{ form.funding_goal.id_for_label }}', name: 'Цель финансирования', type: 'text' },
                { id: '{{ form.short_description.id_for_label }}', name: 'Вводная', type: 'textarea' },
                { id: '{{ form.description.id_for_label }}', name: 'Описание', type: 'textarea' },
                { id: '{{ form.terms.id_for_label }}', name: 'Условия', type: 'textarea' },
                { id: '{{ form.direction.id_for_label }}', name: 'Направление', type: 'select' },
                { id: '{{ form.stage.id_for_label }}', name: 'Стадия', type: 'select' },
                { id: 'id_logo_input', name: 'Логотип', type: 'file', required: true },
                { id: 'id_creatives_input', name: 'Изображения', type: 'file', required: true },
                { id: 'id_video_input', name: 'Видео', type: 'file', required: true },
                { id: 'id_planet_image', name: 'Планета', type: 'hidden' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (element) {
                    let isInvalid = false;
                    if (field.type === 'text' || field.type === 'textarea') {
                        if (!element.value.trim()) {
                            isInvalid = true;
                        }
                    } else if (field.type === 'select' || field.type === 'hidden') {
                        if (element.value === '' || element.value === null) {
                            isInvalid = true;
                        }
                    } else if (field.type === 'file' && field.required) {
                        if (element.files.length === 0) {
                            isInvalid = true;
                        }
                    }

                    if (isInvalid) {
                        validationPassed = false;
                        const errorElement = displayValidationMessage(element, `Пожалуйста, заполните поле "${field.name}".`);
                        if (!firstInvalidElementOrGroup) {
                            firstInvalidElementOrGroup = errorElement.closest('.form-group, .upload-box, .logo-upload-group') || errorElement;
                        }
                        if (field.type === 'file') {
                            const parentBox = element.closest('.upload-box, .logo-upload-group');
                            const uploadButton = parentBox ? parentBox.querySelector('.custom-file-upload-button, .logo-placeholder') : null;
                            if (uploadButton) {
                                uploadButton.classList.add('input-error');
                                if (!firstInvalidElementOrGroup || firstInvalidElementOrGroup === errorElement) {
                                    firstInvalidElementOrGroup = uploadButton;
                                }
                            }
                        }
                    }
                }
            }

            const timelineTextareas = startupForm.querySelectorAll('textarea.timeline-description-textarea');
            let timelineErrorDisplayed = false;
            let firstTimelineError = null;

            timelineTextareas.forEach(textarea => {
                if (!textarea.value.trim()) {
                    if (!timelineErrorDisplayed) {
                        const timelineContainer = textarea.closest('.timeline-description-container');
                        if (timelineContainer) {
                            const stepNumber = timelineContainer.dataset.stepContent;
                            const stepElement = document.querySelector(`.timeline-step[data-step="${stepNumber}"]`);
                            if (stepElement) {
                                const stepWrapper = stepElement.querySelector('.step-number-wrapper');
                                stepWrapper.classList.add('error-step');
                                if (!firstTimelineError) {
                                    firstTimelineError = stepElement;
                                }
                            }
                        }
                        timelineErrorDisplayed = true;
                    }
                    validationPassed = false;
                }
            });

            if (!validationPassed) {
                e.preventDefault();
                const elementToScroll = firstInvalidElementOrGroup || firstTimelineError || firstServerSideError;
                if (elementToScroll) {
                    elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    }
    // Consents modal logic
    const agreeRules = document.getElementById('id_agree_rules');
    const agreeData = document.getElementById('id_agree_data_processing');
    let doc1Read = false;
    let doc2Read = false;

    function updateConsentsAvailability() {
        if (doc1Read && doc2Read) {
            if (agreeRules) agreeRules.removeAttribute('disabled');
            if (agreeData) agreeData.removeAttribute('disabled');
        }
    }

    function openConsentModal(docNumber) {
        const modal = document.getElementById('consentsModal');
        const content = document.getElementById('consentDocContent');
        const title = document.getElementById('consentDocTitle');
        if (!modal || !content || !title) return;
        title.textContent = docNumber === 1 ? 'Документ 1' : 'Документ 2';
        content.innerHTML = '';
        const inner = document.createElement('div');
        inner.className = 'consent-doc-inner';
        inner.style.maxHeight = '50vh';
        inner.style.overflow = 'auto';
        inner.style.paddingRight = '8px';
        inner.innerHTML = '<p>Краткий тестовый текст документа ' + docNumber + '. Пролистайте до конца, чтобы подтвердить прочтение.</p><p>Раздел 1. Описание условий.</p><p>Раздел 2. Положения и определения.</p><p>Раздел 3. Заключительные положения.</p><p>Спасибо за внимание.</p>';
        content.appendChild(inner);
        const confirmBtn = document.getElementById('consentConfirmBtn');
        if (confirmBtn) confirmBtn.disabled = true;
        inner.addEventListener('scroll', function onScroll() {
            const atBottom = inner.scrollTop + inner.clientHeight >= inner.scrollHeight - 4;
            if (atBottom && confirmBtn) {
                confirmBtn.disabled = false;
            }
        });
        modal.classList.add('open');
        if (confirmBtn) {
            confirmBtn.onclick = function() {
                modal.classList.remove('open');
                if (docNumber === 1) doc1Read = true; else doc2Read = true;
                updateConsentsAvailability();
            }
        }
        const closeBtn = document.getElementById('consentCloseBtn');
        if (closeBtn) {
            closeBtn.onclick = function() { modal.classList.remove('open'); };
        }
        modal.addEventListener('click', function(e){ if (e.target === modal) modal.classList.remove('open'); });
    }

    document.querySelectorAll('.consent-doc-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const n = parseInt(btn.getAttribute('data-doc')) || 1;
            openConsentModal(n);
        });
    });

    document.querySelectorAll('.agreement-section .custom-checkbox-label').forEach(lbl => {
        lbl.addEventListener('click', function(e){
            const inputId = this.getAttribute('for');
            const input = document.getElementById(inputId);
            if (input && input.hasAttribute('disabled')) {
                e.preventDefault();
                if (!doc1Read) openConsentModal(1); else if (!doc2Read) openConsentModal(2);
            }
        });
    });
});
</script>

<!-- Consents Modal -->
<div id="consentsModal" class="modal-overlay" style="display:block; visibility:hidden; opacity:0; transition:opacity .2s ease, visibility .2s ease;">
  <div class="modal-dialog" style="max-width:640px; margin:10vh auto; background:#222; color:#fff; border-radius:10px; border:1px solid rgba(255,255,255,.2); box-shadow:0 10px 30px rgba(0,0,0,.5);">
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.1)">
      <div id="consentDocTitle" style="font-weight:600;">Документ</div>
      <button id="consentCloseBtn" type="button" style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer">×</button>
    </div>
    <div id="consentDocContent" class="modal-body" style="padding:16px 20px;"></div>
    <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:10px; padding:12px 20px; border-top:1px solid rgba(255,255,255,.1);">
      <button id="consentConfirmBtn" type="button" class="custom-file-upload-button" disabled>Подтвердить прочтение</button>
    </div>
  </div>
</div>
<style>
#consentsModal { position:fixed; inset:0; background:rgba(0,0,0,.6); }
#consentsModal.open { visibility:visible !important; opacity:1 !important; }
</style>
{% endblock %}