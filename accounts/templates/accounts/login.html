{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Вход{% endblock %}

{% block head_extra %}
{{ block.super }}
<!-- Adding Telegram widget script -->
<script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="testmarketstartup_bot" data-size="medium" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
{% endblock %}

{% block content %}
    {# Добавляем canvas для звездного поля #}
    <canvas id="stars-canvas" class="absolute inset-0 z-0"></canvas>

    <div class="relative z-10 flex min-h-screen items-center justify-center">
        <div class="w-full max-w-md rounded-lg bg-white/10 p-8 shadow-lg backdrop-blur-md">
            <h2 class="mb-6 text-center text-2xl font-bold text-white">Вход</h2>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                {# Явный рендеринг полей #}
                <div>
                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-white">{{ form.email.label }}</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <p class="mt-1 text-sm text-red-500">{{ form.email.errors }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.password.id_for_label }}" class="block text-sm font-medium text-white">{{ form.password.label }}</label>
                    {{ form.password }}
                    {% if form.password.errors %}
                        <p class="mt-1 text-sm text-red-500">{{ form.password.errors }}</p>
                    {% endif %}
                </div>

                <button type="submit" class="w-full rounded-md bg-indigo-600 py-2 text-white hover:bg-indigo-700">Войти</button>
            </form>

            <!-- Telegram Login Button -->
            <div class="mt-4 text-center">
                <div id="telegram-login-button" class="inline-block"></div>
                <script type="text/javascript">
                    function onTelegramAuth(user) {
                        // Send user data to your backend
                        fetch('/telegram-login/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(user)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = '/dashboard/'; // Redirect to dashboard or desired page
                            } else {
                                alert('Telegram login failed: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error during Telegram login: ' + error);
                        });
                    }
                </script>
            </div>

            <p class="mt-4 text-center text-sm text-white">
                Нет аккаунта? <a href="{% url 'register' %}" class="text-indigo-400 hover:underline">Зарегистрироваться</a>
            </p>
        </div>
    </div>
{% endblock %}