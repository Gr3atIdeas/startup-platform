{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Уведомления{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'accounts/css/notifications.css' %}">
{% endblock %}

{% block content %}
<div class="notifications-page-wrapper">
    <div class="notifications-content-container">
        <div class="notifications-promo-card">
            <div class="promo-card-background-elements">
                <div class="promo-bg-blur-circle-1"></div>
                <div class="promo-bg-blur-circle-2"></div>
            </div>
            <div class="promo-card-text-content">
                <div class="promo-title-main">Мои</div>
                <div class="promo-title-accent">СТАРТАПЫ</div>
            </div>
            <img class="promo-img-1" src="https://placehold.co/112x81" alt="Promo image" />
            <img class="promo-img-2" src="https://placehold.co/158x98" alt="Promo image" />
            <img class="promo-img-3" src="https://placehold.co/108x105" alt="Promo image" />
            <img class="promo-img-4" src="https://placehold.co/125x125" alt="Promo image" />
            <img class="promo-img-5" src="https://placehold.co/261x238" alt="Promo image" />
            <div class="promo-card-gradient-overlay"></div>
            <a href="{% url 'my_startups' %}" class="btn promo-action-button">Перейти</a>
        </div>

        <div class="notifications-list-section">
            <div class="notifications-list-items">
                {% for i in "x"|ljust:6 %} {# Создаем 6 элементов для примера #}
                <div class="notification-item" data-notification-id="{{ i }}">
                    <div class="notification-item-meta">
                        <span class="notification-date">25/03/2025</span>
                        <span class="notification-time">12:30</span>
                    </div>
                    <div class="notification-item-bubble">
                        <p>User 67346 инвестировал 7 899 ₽</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="notifications-section-title">
        СТАРТАПЫ
    </div>

    <div class="notifications-related-startups">
        {% for i in "x"|ljust:7 %} {# Создаем 7 элементов для примера #}
        <div class="related-startup-card">
            <img src="https://placehold.co/123x111" alt="Лого стартапа">
            <span class="related-startup-name">Ромашка {{forloop.counter}}</span>
            <div class="related-startup-badge">
                <span>{{ forloop.counter|add:2 }}</span>
            </div>
        </div>
        {% endfor %}
         <!-- Пустышка для выравнивания последнего ряда, если нужно -->
        <div class="related-startup-card-empty-spacer"></div>
        {# <div class="related-startup-badge-empty-spacer"></div> Удаляем, т.к. бейдж теперь внутри карточки #}
    </div>
</div>

<!-- Модальное окно для уведомлений -->
<div id="notification-modal-overlay" class="modal-overlay">
    <div id="notification-modal-popup" class="modal-popup">
        <button id="notification-modal-close" class="modal-close-button">
            <img src="{% static 'accounts/images/icons/Close_yellow.svg' %}" alt="Закрыть">
        </button>
        <div class="modal-content-wrapper">
            <div class="modal-promo-card">
                <div class="modal-promo-bg-elements">
                    <div class="modal-promo-blur-1"></div>
                    <div class="modal-promo-blur-2"></div>
                </div>
                <div class="modal-promo-text">
                    <div class="modal-promo-subtitle">Стартап</div>
                    <div class="modal-promo-title">Ромашка</div> {# Динамически будет меняться #}
                </div>
                <img class="modal-promo-main-img" src="https://placehold.co/286x261" alt="Изображение стартапа" />
                <div class="modal-promo-gradient"></div>
                <a href="#" class="btn modal-promo-action">Перейти</a> {# URL будет меняться #}
            </div>
            <div class="modal-notification-details">
                <div class="modal-notification-list">
                    <!-- Сюда будут копироваться уведомления или отображаться детали одного -->
                    <div class="notification-item"> {# Пример структуры, будет заполняться JS #}
                        <div class="notification-item-meta">
                            <span class="notification-date">25/03/2025</span>
                            <span class="notification-time">12:30</span>
                        </div>
                        <div class="notification-item-bubble">
                            <p>User 67346 инвестировал 7 899 ₽</p>
                        </div>
                    </div>
                </div>
                {# Удаляем кастомный скроллбар, так как стилизуем нативный для modal-notification-list #}
                {# <div class="modal-notification-scrollbar-track">
                    <div class="modal-notification-scrollbar-thumb"></div>
                </div> #}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM Content Loaded - Notification Modal Script Initializing'); // DEBUG

    const notificationBubbles = document.querySelectorAll('.notifications-list-section .notification-item-bubble');
    console.log('Found notification bubbles:', notificationBubbles.length, notificationBubbles); // DEBUG

    const modalOverlay = document.getElementById('notification-modal-overlay');
    const modalCloseButton = document.getElementById('notification-modal-close');
    const modalPopup = document.getElementById('notification-modal-popup');

    if (!modalOverlay || !modalCloseButton || !modalPopup) {
        console.error('Modal core elements (overlay, close button, or popup) not found!'); // DEBUG
        return;
    }

    const modalPromoTitle = modalPopup.querySelector('.modal-promo-title');
    const modalNotificationList = modalPopup.querySelector('.modal-notification-list');
    const modalPromoAction = modalPopup.querySelector('.modal-promo-action');
    const modalPromoSubtitle = modalPopup.querySelector('.modal-promo-subtitle');
    const modalPromoMainImg = modalPopup.querySelector('.modal-promo-main-img');

    if (!modalPromoTitle || !modalNotificationList || !modalPromoAction || !modalPromoSubtitle || !modalPromoMainImg) {
        console.error('One or more modal content elements not found! Check classes/IDs.'); // DEBUG
        // Не прерываем выполнение полностью, т.к. основная логика открытия/закрытия может работать
    }

    let modalNotificationListTitle = modalPopup.querySelector('.modal-notification-list-title');
    if (!modalNotificationListTitle && modalNotificationList) {
        console.log('Modal notification list title not found, creating it.'); // DEBUG
        modalNotificationListTitle = document.createElement('div');
        modalNotificationListTitle.className = 'modal-notification-list-title';
        modalNotificationList.parentNode.insertBefore(modalNotificationListTitle, modalNotificationList);
    }

    notificationBubbles.forEach((bubble, index) => {
        console.log('Attaching click listener to bubble #', index, bubble); // DEBUG
        bubble.addEventListener('click', function () {
            console.log('Notification bubble clicked:', this); // DEBUG

            const parentItem = this.closest('.notification-item');
            console.log('Parent .notification-item:', parentItem); // DEBUG
            if (!parentItem) {
                console.error('Could not find parent .notification-item for bubble:', this);
                return;
            }

            const notificationId = parentItem.dataset.notificationId || 'N/A';
            const date = parentItem.querySelector('.notification-date')?.textContent || 'Дата не указана';
            const time = parentItem.querySelector('.notification-time')?.textContent || 'Время не указано';
            const message = this.querySelector('p')?.textContent || 'Детали уведомления отсутствуют.';
            console.log('Extracted data:', { notificationId, date, time, message }); // DEBUG

            let startupName = "Детализация";
            let startupImage = "https://placehold.co/286x261/000000/FFFFFF?text=Startup";
            let startupUrl = "#";

            if (message.toLowerCase().includes('стартап')) {
                const match = message.match(/стартап\s*"?(С\S+)/i);
                 if (match && match[1]) {
                    startupName = match[1].replace(/[",.]/g, '');
                }
            } else if (message.includes("Ромашка")) {
                startupName = "Ромашка";
                startupImage = "https://placehold.co/286x261/E6E6FA/000000?text=Ромашка";
                startupUrl = "/startup/romashka/";
            }
            
            const linkedStartupName = parentItem.dataset.startupName;
            if (linkedStartupName) startupName = linkedStartupName;
            const linkedStartupImage = parentItem.dataset.startupImage;
            if (linkedStartupImage) startupImage = linkedStartupImage;
            const linkedStartupUrl = parentItem.dataset.startupUrl;
            if (linkedStartupUrl) startupUrl = linkedStartupUrl;
            console.log('Final startup data for modal:', { startupName, startupImage, startupUrl }); // DEBUG
            
            if(modalPromoSubtitle) modalPromoSubtitle.textContent = "Уведомление от стартапа";
            if(modalPromoTitle) modalPromoTitle.textContent = startupName;
            if(modalPromoMainImg) {
                modalPromoMainImg.src = startupImage;
                modalPromoMainImg.alt = `Логотип стартапа ${startupName}`;
            }
            if(modalPromoAction) modalPromoAction.href = startupUrl;

            if(modalNotificationListTitle) modalNotificationListTitle.textContent = `Информация по уведомлению`;

            if(modalNotificationList) {
                modalNotificationList.innerHTML = ''; 
                const clickedItemClone = parentItem.cloneNode(true);
                modalNotificationList.appendChild(clickedItemClone);
            } else {
                console.error('modalNotificationList is not available to append content!'); // DEBUG
            }
            
            console.log('Attempting to display modal overlay...'); // DEBUG
            modalOverlay.style.display = 'flex';
            console.log('Modal overlay display set to flex.'); // DEBUG
        });
    });

    if (modalCloseButton) {
        modalCloseButton.addEventListener('click', function () {
            console.log('Modal close button clicked.'); // DEBUG
            modalOverlay.style.display = 'none';
        });
    } else {
        console.error('Modal close button not found for attaching event listener!'); // DEBUG
    }

    modalOverlay.addEventListener('click', function (event) {
        if (event.target === modalOverlay) {
            console.log('Clicked on modal overlay (background). Closing modal.'); // DEBUG
            modalOverlay.style.display = 'none';
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && modalOverlay.style.display === 'flex') {
            console.log('Escape key pressed. Closing modal.'); // DEBUG
            modalOverlay.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
