{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Планетарная система стартапов{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/planetary_system.css' %}">
{% endblock %}

{% block content %}
  <div class="planetary-system-wrapper">
    <div class="planetary-system-container">
      <div class="space-background"></div>
      <div class="stars"></div>
      <div id="solar-system">
        <div id="scene">
          <div id="galaxy">
            <div id="logo" style="background-image: url('{{ logo_data.image }}');"></div>
            {% for planet in planets_data|slice:":9" %}
              <div class="orbit" style="--orbit-size: {{ planet.orbit_size }}px; --orbit-time: {{ planet.orbit_time }}s;">
                <div class="planet-orientation">
                  <div class="planet" style="--planet-size: {{ planet.planet_size }}px; background-image: url('{{ planet.image }}');" data-id="{{ planet.id }}"></div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div id="info-card">
        <button id="close-card" class="no-wave-effect">×</button>
        <div class="planet-image" id="planet-image"></div>
        <h2 id="startup-name"></h2>
        <div class="rating" id="startup-rating"></div>
        <div class="progress-bar">
          <button class="no-wave-effect">Выкуп+инвестирование</button>
          <div class="progress" id="startup-progress"></div>
        </div>
        <div class="funding" id="startup-funding"></div>
        <div class="investors" id="startup-investors"></div>
        <div class="description" id="startup-description"></div>
        <button class="more-details no-wave-effect" id="more-details">Подробнее</button>
      </div>
      <div id="crosshair"></div>
      <div id="crosshair-coords"></div>
      <div id="mouse-coords"></div>
      <div id="axes">
        <div class="axis" id="axis-x"></div>
        <div class="axis" id="axis-y"></div>
        <div class="axis" id="axis-z"></div>
        <div class="axis-label" id="label-x">X</div>
        <div class="axis-label" id="label-y">Y</div>
        <div class="axis-label" id="label-z">Z</div>
      </div>
      <div id="fps">0 FPS</div>
      <div id="galaxy-selector">
        <div id="galaxy-list">
          {% for direction in directions %}
            <div class="galaxy-item {% if direction.direction_name == selected_galaxy %}selected{% endif %}" data-name="{{ direction.direction_name }}">{{ direction.direction_name }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script_extra %}
  <script>
    (function() {
      console.log('Planetary System Script Started (IIFE)');

      try {
        const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
        const isStartuper = {{ is_startuper|yesno:"true,false" }};
        // console.log('User context:', { isAuthenticated, isStartuper });

        const startups = {
          {% for planet in planets_data|slice:":9" %}
            '{{ planet.id|escapejs }}': {
              name: '{{ planet.name|escapejs }}',
              description: '{{ planet.description|escapejs }}',
              rating: '{{ planet.rating|escapejs }}',
              comment_count: {{ planet.comment_count|default:0 }},
              progress: '{{ planet.progress|escapejs }}',
              direction: '{{ planet.direction|escapejs }}',
              investment_type: '{{ planet.investment_type|escapejs }}',
              funding: '{{ planet.funding_goal|escapejs }}',
              investors: '{{ planet.investors|escapejs }}',
              image: '{{ planet.image|escapejs }}',
              startup_id: '{{ planet.startup_id|default:"null"|escapejs }}'
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        };
        // console.log('Startups data:', startups);

        const planets = document.querySelectorAll('.planet');
        const infoCard = document.getElementById('info-card');
        const planetImage = document.getElementById('planet-image');
        const startupName = document.getElementById('startup-name');
        const startupRating = document.getElementById('startup-rating');
        const startupProgress = document.getElementById('startup-progress');
        const startupFunding = document.getElementById('startup-funding');
        const startupInvestors = document.getElementById('startup-investors');
        const startupDescription = document.getElementById('startup-description');
        const closeCardButton = document.getElementById('close-card');
        const moreDetailsButton = document.getElementById('more-details');
        const solarSystem = document.getElementById('solar-system');
        const scene = document.getElementById('scene');
        const galaxy = document.getElementById('galaxy');
        const crosshairCoords = document.getElementById('crosshair-coords');
        const mouseCoords = document.getElementById('mouse-coords');
        const fpsElement = document.getElementById('fps');
        const galaxySelector = document.getElementById('galaxy-selector');
        const galaxyList = document.getElementById('galaxy-list');

        // console.log('Found planets:', planets.length);
        // console.log('infoCard:', infoCard);
        // console.log('solarSystem:', solarSystem);
        // console.log('galaxySelector:', galaxySelector);

        let currentStartupID = null;
        const galaxyTiltAngle = 45;
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;
        let isPaused = false;
        let pausedTime = 0;
        let lastInteractionTime = Date.now();
        const inactivityTimeout = 10000;
        let isReturningToCenter = false;
        let isDragging = false;
        let startX, startY;
        let offsetX = 0;
        let offsetY = 0;
        let scale = 1;
        const planetObjects = [];

        if (planets && typeof getComputedStyle !== 'undefined' && planets.length > 0) {
            planets.forEach(planet => {
                const id = planet.getAttribute('data-id');
                // ... (код для randomAngle, randomSpeedFactor - они были в CSS, теперь не нужны в JS если орбиты CSS-анимированные)

                const orbit = planet.closest('.orbit');
                const planetOrientation = planet.closest('.planet-orientation');

                if (!orbit || !planetOrientation) {
                    console.error('Orbit or orientation not found for planet', planet);
                    return;
                }

                const orbitSizeStyle = getComputedStyle(orbit).getPropertyValue('--orbit-size');
                const orbitTimeStyle = getComputedStyle(orbit).getPropertyValue('--orbit-time');
                const planetSizeStyle = getComputedStyle(planet).getPropertyValue('--planet-size');

                const orbitSize = parseFloat(orbitSizeStyle);
                const orbitTime = parseFloat(orbitTimeStyle);
                const planetSize = parseFloat(planetSizeStyle);

                if (isNaN(orbitSize) || isNaN(planetSize)) {
                    console.error('Invalid dimensions for planet', id, {orbitSize, orbitTime, planetSize});
                    return;
                }
                
                planetObjects.push({
                    element: planet,
                    orientation: planetOrientation,
                    orbit: orbit,
                    size: planetSize,
                    orbitSize: orbitSize,
                    orbitTimeCSS: orbitTime,
                    angle: Math.random() * 360,
                    speedFactor: 0.8 + Math.random() * 0.4,
                    startTime: Date.now() - Math.random() * (orbitTime || 10) * 1000
                });

                if (startups[id] && startups[id].image) {
                    const img = new Image();
                    img.src = startups[id].image;
                    img.onerror = () => {
                        console.error(`Failed to load image for startup ${id}: ${startups[id].image}`);
                        planet.style.backgroundImage = `url('https://via.placeholder.com/100?text=Error')`;
                    };
                } else if (id !== 'create-startup') {
                     planet.style.backgroundImage = `url('https://via.placeholder.com/100?text=No+Image')`;
                }

                planet.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (id === 'create-startup') {
                        if (isAuthenticated && isStartuper) {
                            window.location.href = "{% url 'create_startup' %}";
                        } else if (!isAuthenticated) {
                            window.location.href = "{% url 'register' %}";
                        }
                        return;
                    }
                    const startup = startups[id];
                    if (!startup) return;

                    if(planetImage) planetImage.style.backgroundImage = `url('${startup.image}')`;
                    if(startupName) startupName.textContent = startup.name;
                    if(startupRating) startupRating.textContent = `Рейтинг ${startup.rating} | Комментариев: ${startup.comment_count}`;
                    if(startupProgress) startupProgress.innerHTML = `
                        <div class="progress-bar-visual">
                           <div class="progress-animation-container" style="width: ${startup.progress};">
                             <div class="progress-planets"></div>
                           </div>
                           <span class="progress-percentage">${startup.progress}</span>
                         </div>`;
                    if(startupFunding) startupFunding.innerHTML = `
                        <strong>Направление:</strong> ${startup.direction}<br>
                         <div class="funding-goal-container-figma">
                           <span class="funding-goal-text-figma">Цель финансирования: ${startup.funding}</span>
                         </div>`;
                    if(startupInvestors) startupInvestors.innerHTML = `
                        <div class="investor-count-container-figma">
                           <i class="fas fa-users investor-icon-figma"></i>
                           <span class="investor-count-text-figma">${startup.investors}</span>
                         </div>`;
                    if(startupDescription) startupDescription.innerHTML = `
                        <div class="progress-bar">
                           ${startup.investment_type !== "Не указано" ? `<button class="no-wave-effect">${startup.investment_type}</button>` : ""}
                         </div>
                         <div class="startup-short-description">${startup.description}</div>`;

                    currentStartupID = startup.startup_id;
                    planets.forEach(p => p.classList.remove('active'));
                    planet.classList.add('active');
                    if(infoCard) infoCard.style.display = 'block';
                    isPaused = true;
                    pausedTime = Date.now();
                    lastInteractionTime = Date.now();
                });
            });
        }

        if(closeCardButton) {
            closeCardButton.addEventListener('click', () => {
                if(infoCard) infoCard.style.display = 'none';
                planets.forEach(p => p.classList.remove('active'));
                if (isPaused) {
                    const pauseDuration = Date.now() - pausedTime;
                    planetObjects.forEach(planetObj => { planetObj.startTime += pauseDuration; });
                    isPaused = false;
                }
                lastInteractionTime = Date.now();
            });
        }

        if(moreDetailsButton) {
            moreDetailsButton.addEventListener('click', () => {
                if (currentStartupID && currentStartupID !== "null") {
                    window.location.href = `/startup/${currentStartupID}/`;
                } else {
                    console.log('No startup_id for details');
                }
            });
        }

        if (solarSystem) {
            solarSystem.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const rect = solarSystem.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                isDragging = true;
                solarSystem.classList.add('dragging');
                lastInteractionTime = Date.now();
                isReturningToCenter = false;
            });

            solarSystem.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = solarSystem.getBoundingClientRect();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(0.5, Math.min(3, scale + delta));
                
                scale = newScale;

                if(scene) scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                if(crosshairCoords) crosshairCoords.textContent = `Center: (${Math.round(offsetX)}, ${Math.round(offsetY)}, 0) Scale: ${scale.toFixed(1)}`;
                if(mouseCoords) {
                    mouseCoords.style.left = `${Math.min(rect.width - 80, Math.max(0, e.clientX - rect.left))}px`;
                    mouseCoords.style.top = `${Math.min(rect.height - 30, Math.max(0, e.clientY - rect.top))}px`;
                    mouseCoords.textContent = `Mouse: (${Math.round(e.clientX - rect.left)}, ${Math.round(e.clientY - rect.top)})`;
                }
                lastInteractionTime = Date.now();
                isReturningToCenter = false;
            });
        }

        document.addEventListener('mousemove', (e) => {
            const solarSystemRect = solarSystem ? solarSystem.getBoundingClientRect() : null;

            if (isDragging && solarSystemRect) {
                const deltaX = e.clientX - solarSystemRect.left - startX;
                const deltaY = e.clientY - solarSystemRect.top - startY;
                offsetX += deltaX;
                offsetY += deltaY;

                const maxOffset = 300 * scale; 
                offsetX = Math.max(-maxOffset, Math.min(maxOffset, offsetX));
                offsetY = Math.max(-maxOffset, Math.min(maxOffset, offsetY));

                if(scene) scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                startX = e.clientX - solarSystemRect.left;
                startY = e.clientY - solarSystemRect.top;
                if(crosshairCoords) crosshairCoords.textContent = `Center: (${Math.round(offsetX)}, ${Math.round(offsetY)}, 0) Scale: ${scale.toFixed(1)}`;
                lastInteractionTime = Date.now();
            }
            if (solarSystemRect && mouseCoords) {
                 mouseCoords.style.left = `${Math.min(solarSystemRect.width - 80, Math.max(0, e.clientX - solarSystemRect.left))}px`;
                 mouseCoords.style.top = `${Math.min(solarSystemRect.height - 30, Math.max(0, e.clientY - solarSystemRect.top))}px`;
                 mouseCoords.textContent = `Mouse: (${Math.round(e.clientX - solarSystemRect.left)}, ${Math.round(e.clientY - solarSystemRect.top)})`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                if(solarSystem) solarSystem.classList.remove('dragging');
                lastInteractionTime = Date.now();
            }
        });

        if(infoCard) {
            infoCard.addEventListener('mousedown', (e) => { e.stopPropagation(); lastInteractionTime = Date.now(); });
        }

        function checkInactivity() {
            const currentTime = Date.now();
            if (currentTime - lastInteractionTime >= inactivityTimeout && !isReturningToCenter && !isDragging && !isPaused) {
                isReturningToCenter = true;
                const startAnimX = offsetX;
                const startAnimY = offsetY;
                const startScale = scale;
                const targetScale = 1.0;
                const duration = 1000;
                let animStartTime = null;

                function animateReturn(timestamp) {
                    if (!animStartTime) animStartTime = timestamp;
                    const elapsed = timestamp - animStartTime;
                    const progress = Math.min(elapsed / duration, 1);

                    offsetX = startAnimX + (0 - startAnimX) * progress;
                    offsetY = startAnimY + (0 - startAnimY) * progress;
                    scale = startScale + (targetScale - startScale) * progress;

                    if(scene) scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                    if(crosshairCoords) crosshairCoords.textContent = `Center: (${Math.round(offsetX)}, ${Math.round(offsetY)}, 0) Scale: ${scale.toFixed(1)}`;

                    if (progress < 1) {
                        requestAnimationFrame(animateReturn);
                    } else {
                        isReturningToCenter = false;
                        offsetX = 0; offsetY = 0; scale = targetScale;
                        if(scene) scene.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                        if(crosshairCoords) crosshairCoords.textContent = `Center: (${Math.round(offsetX)}, ${Math.round(offsetY)}, 0) Scale: ${scale.toFixed(1)}`;
                    }
                }
                requestAnimationFrame(animateReturn);
            }
        }
        setInterval(checkInactivity, 1000);

        function updatePlanetsRotation() {
            const currentTime = Date.now();
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                if(fpsElement) fpsElement.textContent = `${fps} FPS`;
            }

            if (isPaused) {
                requestAnimationFrame(updatePlanetsRotation);
                return;
            }

            planetObjects.forEach(planetObj => {
            });
            requestAnimationFrame(updatePlanetsRotation);
        }
        
        let scrollVelocity = 0;
        let lastScrollTime = 0;

        if (galaxySelector && galaxyList) {
            const galaxyListItems = galaxyList.querySelectorAll('.galaxy-item');
            const itemsArray = Array.from(galaxyListItems);
            const totalItems = itemsArray.length;
            let clonedItems = [];

            if (totalItems > 0) {
                itemsArray.forEach(item => {
                    const clone = item.cloneNode(true);
                    galaxyList.appendChild(clone);
                    clonedItems.push(clone);
                    clone.addEventListener('click', () => {
                        const galaxyName = clone.getAttribute('data-name');
                        if (galaxyName) selectGalaxy(galaxyName);
                    });
                });
            }
            
            itemsArray.forEach(item => {
                item.addEventListener('click', () => {
                    const galaxyName = item.getAttribute('data-name');
                    if (galaxyName) selectGalaxy(galaxyName);
                });
            });

            galaxySelector.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY * 0.5;
                scrollVelocity += delta;
                lastScrollTime = Date.now();
                lastInteractionTime = Date.now();
            }, { passive: false });

            function selectGalaxy(galaxyName) {
                scrollVelocity = 0;
                lastScrollTime = Date.now();
                localStorage.setItem('selectedGalaxy', galaxyName);
                 window.location.href = `{% url 'planetary_system' %}?galaxy=${encodeURIComponent(galaxyName)}`;
            }

            function smoothScrollGalaxyList() {
                const currentTime = Date.now();
                const timeSinceLastScroll = currentTime - lastScrollTime;

                if (Math.abs(scrollVelocity) > 0.1) {
                    galaxySelector.scrollLeft += scrollVelocity;
                    scrollVelocity *= 0.92;
                    if (Math.abs(scrollVelocity) < 0.1) scrollVelocity = 0;
                } else {
                    scrollVelocity = 0;
                }
                
                if (totalItems > 0 && itemsArray[0]) {
                    const itemWidthWithMargin = itemsArray[0].offsetWidth + 
                                                parseFloat(getComputedStyle(itemsArray[0]).marginLeft) + 
                                                parseFloat(getComputedStyle(itemsArray[0]).marginRight);
                    const totalListWidth = itemWidthWithMargin * totalItems;
                    
                    if (galaxySelector.scrollLeft >= totalListWidth) {
                        galaxySelector.scrollLeft -= totalListWidth;
                    } else if (galaxySelector.scrollLeft <= -itemWidthWithMargin) {
                         galaxySelector.scrollLeft += totalListWidth;
                    }
                }

                const containerRect = galaxySelector.getBoundingClientRect();
                const containerCenter = containerRect.left + containerRect.width / 2;
                const allItems = galaxyList.querySelectorAll('.galaxy-item');

                allItems.forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    const itemCenter = itemRect.left + itemRect.width / 2;
                    const distanceFromCenter = Math.abs(containerCenter - itemCenter);
                    const maxDistanceEffect = containerRect.width / 2.5;

                    let itemScale = 1;
                    let opacity = 1;

                    if (distanceFromCenter < maxDistanceEffect) {
                        itemScale = 1 - 0.4 * (distanceFromCenter / maxDistanceEffect);
                        opacity = 1 - 0.5 * (distanceFromCenter / maxDistanceEffect);
                    } else {
                        itemScale = 0.6;
                        opacity = 0.5;
                    }
                    itemScale = Math.max(0.5, itemScale);
                    opacity = Math.max(0.3, opacity);
                    
                    item.style.transform = `scale(${itemScale})`;
                    item.style.opacity = opacity;
                    
                    const currentSelectedGalaxy = localStorage.getItem('selectedGalaxy') || "{{ selected_galaxy|default:''|escapejs }}";
                    if (item.getAttribute('data-name') === currentSelectedGalaxy) {
                        item.classList.add('highlighted');
                        item.style.transform = 'scale(1.05)';
                        item.style.opacity = 1;
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
                requestAnimationFrame(smoothScrollGalaxyList);
            }
            
            const initialGalaxy = localStorage.getItem('selectedGalaxy') || "{{ selected_galaxy|default:''|escapejs }}";
            if (initialGalaxy && itemsArray.length > 0) {
                let foundItem = itemsArray.find(item => item.getAttribute('data-name') === initialGalaxy);
                if (foundItem) {
                    setTimeout(() => {
                        const containerRect = galaxySelector.getBoundingClientRect();
                        const itemRect = foundItem.getBoundingClientRect();
                        const scrollTarget = foundItem.offsetLeft - (containerRect.width / 2) + (itemRect.width / 2);
                        galaxySelector.scrollTo({ left: scrollTarget, behavior: 'smooth' });
                    }, 100);
                }
            }
            if (totalItems > 0) requestAnimationFrame(smoothScrollGalaxyList);
        }

        if (typeof requestAnimationFrame !== 'undefined') {
            requestAnimationFrame(updatePlanetsRotation);
        }
        if (crosshairCoords) crosshairCoords.textContent = `Center: (${Math.round(offsetX)}, ${Math.round(offsetY)}, 0) Scale: ${scale.toFixed(1)}`;

      } catch (error) {
        console.error('Error in Planetary System script:', error);
      }
    })();
  </script>
{% endblock %}