{% extends "accounts/base.html" %}
{% load static %}

{% block title %}Ошибка авторизации{% endblock %}

{% block content %}
<div style="min-height: 50vh; display: flex; align-items: center; justify-content: center;">
  <div style="max-width: 560px; padding: 24px; border-radius: 12px; background: rgba(255,255,255,0.04); color: #fff; text-align: center;">
    {% if request.user.is_authenticated %}
      <h1 style="margin: 0 0 12px">Добро пожаловать!</h1>
      <p style="margin: 0 0 20px; color: #ccc">Перенаправляем в каталог стартапов…</p>
      <a href="{% url 'startups_list' %}" style="display:inline-block; padding:12px 18px; border:1px solid #fff; border-radius:8px; text-decoration:none; color:#fff">Открыть каталог</a>
      <script>
        setTimeout(function(){ window.location.replace("{% url 'startups_list' %}"); }, 50);
      </script>
    {% else %}
      <h1 style="margin: 0 0 12px">Third-Party Login Failure</h1>
      <p style="margin: 0 0 20px; color: #ccc">Произошла ошибка при попытке входа через сторонний сервис.</p>
      <a href="{% url 'login' %}" style="display:inline-block; padding:12px 18px; border:1px solid #fff; border-radius:8px; text-decoration:none; color:#fff">Вернуться к входу</a>
    {% endif %}
  </div>
  
</div>
<script>
  // Всегда мгновенно уводим в каталог стартапов, чтобы пользователь не видел экран ошибки
  setTimeout(function(){ window.location.replace("{% url 'startups_list' %}"); }, 50);
  // Если в hash есть tgAuthResult и это не 'false', попробуем отправить его повторно POST'ом
  (function(){
    try {
      var h = window.location.hash || '';
      if (!h) return;
      var m = h.match(/tgAuthResult=([^&]+)/);
      if (!m) return;
      var val = decodeURIComponent(m[1] || '');
      if (!val || val.toLowerCase() === 'false') return;
      try { val = atob(val); } catch(e) {}
      if (val && val[0] === '{') {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.pathname + window.location.search;
        var inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = 'tgAuthResult';
        inp.value = val;
        form.appendChild(inp);
        document.body.appendChild(form);
        form.submit();
      }
    } catch(e) {}
  })();
</script>
{% endblock %}


